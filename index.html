<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RootDonate ‚Ä¢ Live GPS Posts Map ‚Äì Carrick Era #MUFC</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5p5QbskXk=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    body, html { margin:0; height:100%; background:#000; color:#eee; font-family:system-ui,sans-serif; }
    #map { height:100%; }
    .overlay {
      position: absolute; top:10px; left:50%; transform:translateX(-50%);
      z-index:1000; background:rgba(0,0,0,0.7); padding:12px 20px; border-radius:12px;
      text-align:center; pointer-events:all; max-width:90%; box-shadow:0 4px 20px rgba(0,255,136,0.2);
    }
    h1 { margin:0 0 8px; font-size:2.4rem; background:linear-gradient(90deg,#0af,#0f5,#f90); -webkit-background-clip:text; background-clip:text; color:transparent; }
    input, button { margin:6px 4px; padding:8px 14px; border-radius:8px; border:1px solid #444; background:#222; color:#fff; }
    button { background:#1d9bf0; border:none; cursor:pointer; font-weight:600; }
    button:hover { background:#0c85d0; }
    #status, #gpsStatus { font-size:0.9rem; color:#0f5; margin:4px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="overlay">
    <h1>RootDonate</h1>
    <div>
      <input id="keyword" placeholder="Filter e.g. training, Amad, Carrington" />
      <button id="filterBtn">Filter</button>
      <button id="clearFilter">Clear</button>
    </div>
    <div>
      <input id="postText" placeholder="Your shoutout..." style="width:240px;" />
      <label><input type="checkbox" id="hasMedia"> + Media?</label>
      <button id="addPostButton">Drop on Map & Email</button>
    </div>
    <div>
      <button id="refreshEmailPosts">Refresh Email Posts</button>
      <button id="zoomButton">Zoom Carrington</button>
      <span id="gpsStatus">GPS: checking...</span>
    </div>
    <div id="status">Jan 21, 2026 ‚Ä¢ @iandreme ‚Ä¢ Email ‚Üí GPS Nodes ‚Ä¢ #MUFC</div>
  </div>

  <script>
    emailjs.init({ publicKey: "1oXeNo5ZXiRcipyWo" }); // ‚Üê your EmailJS public key

    const map = L.map('map').setView([53.4631, -2.2913], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap & CARTO'
    }).addTo(map);

    const markers = L.markerClusterGroup({ maxClusterRadius: 60 });
    map.addLayer(markers);

    const emailIcon = L.divIcon({
      className: 'email-marker',
      html: '<div style="background:#0f5;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 0 8px #0f5;"></div>',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    let userLat = 53.4631, userLng = -2.2913;
    let gpsOK = false;

    // GPS tracking
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        gpsOK = true;
        document.getElementById('gpsStatus').textContent = `GPS: ${userLat.toFixed(5)}, ${userLng.toFixed(5)}`;
      }, err => {
        let msg = 'GPS off / denied ‚Äì using Carrington default';
        if (err.code === 3) msg += ' (timeout)';
        document.getElementById('gpsStatus').textContent = msg;
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 });
    }

    // Super forgiving coordinate cleaner/autocorrect
    function cleanCoords(latInput, lngInput) {
      if (!latInput || !lngInput) {
        return { lat: userLat, lng: userLng };
      }

      // Helper: DMS ‚Üí decimal (e.g. 53¬∞27'50" N)
      function dmsToDecimal(str, isLat = true) {
        const regex = /([+-]?\d+(?:\.\d+)?)[¬∞d]?\s*(\d+(?:\.\d+)?)?['‚Ä≤]?\s*(\d+(?:\.\d+)?)?["‚Ä≥]?([NSEW])?/i;
        const match = str.match(regex);
        if (!match) return NaN;

        let deg = parseFloat(match[1]) || 0;
        let min = parseFloat(match[2]) || 0;
        let sec = parseFloat(match[3]) || 0;
        let dir = (match[4] || '').toUpperCase();

        let decimal = deg + min / 60 + sec / 3600;

        // Apply direction
        if (dir && ['S','W'].includes(dir)) decimal = -decimal;

        return decimal;
      }

      // Clean strings: comma ‚Üí dot, keep numbers/dots/minus/¬∞'"/NSEW/space
      let latStr = (latInput + '').replace(/,/g, '.').replace(/[^0-9.\-¬∞'‚Ä≥NSEWd ]/gi, ' ').trim();
      let lngStr = (lngInput + '').replace(/,/g, '.').replace(/[^0-9.\-¬∞'‚Ä≥NSEWd ]/gi, ' ').trim();

      // Try DMS parse first
      let lat = dmsToDecimal(latStr, true);
      let lng = dmsToDecimal(lngStr, false);

      // Fallback to simple number parse
      if (isNaN(lat)) lat = parseFloat(latStr) || userLat;
      if (isNaN(lng)) lng = parseFloat(lngStr) || userLng;

      // Safety bounds
      if (Math.abs(lat) > 90 || isNaN(lat)) lat = userLat;
      if (Math.abs(lng) > 180 || isNaN(lng)) lng = userLng;

      return {
        lat: +lat.toFixed(6),
        lng: +lng.toFixed(6)
      };
    }

    function addMarker(lat, lng, user, text, hasMedia = false) {
      const popup = `
        <b>${user}</b><br>
        ${text || '(no text)'}<br>
        ${hasMedia ? 'üì∏ Has media' : ''}<br>
        <small>${new Date().toLocaleString()}</small>
      `;
      L.marker([lat, lng], { icon: emailIcon })
        .addTo(markers)
        .bindPopup(popup);
    }

    async function loadEmailPosts(filter = '') {
      try {
        // CHANGE THIS to your real JSON endpoint when ready!
        // e.g. 'https://rootdonate.com/api/posts.json' or wherever your backend serves the array
        const resp = await fetch('https://rootdonate.com');
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        const posts = await resp.json();

        markers.clearLayers();

        let added = 0;
        posts.forEach(p => {
          const txt = (p.t || p.text || p.message || '').toLowerCase();
          if (filter && !txt.includes(filter.toLowerCase())) return;

          const latSrc = p.lat ?? p.latitude ?? p.Lat ?? p.coords?.lat ?? '';
          const lngSrc = p.lng ?? p.longitude ?? p.Lng ?? p.coords?.lng ?? '';

          const { lat, lng } = cleanCoords(latSrc, lngSrc);

          addMarker(
            lat, lng,
            p.u || p.user || p.from || 'Email Node',
            p.t || p.text || p.message || '‚Äî',
            !!p.hasMedia || !!p.media || !!p.image
          );
          added++;
        });

        document.getElementById('status').textContent = 
          `Jan 21, 2026 ‚Ä¢ @iandreme ‚Ä¢ Loaded ${added} email GPS nodes ‚Ä¢ #MUFC`;
      } catch (e) {
        console.error('Load error:', e);
        document.getElementById('status').textContent = 
          `Load failed: ${e.message} (check endpoint)`;
      }
    }

    // Add your own post
    document.getElementById('addPostButton').onclick = () => {
      const text = document.getElementById('postText').value.trim();
      if (!text) return alert('Type something first!');

      const hasMedia = document.getElementById('hasMedia').checked;

      addMarker(userLat, userLng, '@iandreme', text, hasMedia);

      emailjs.send('service_amql3dos', 'template_cyl5hjt', {
        text,
        lat: userLat.toFixed(6),
        lng: userLng.toFixed(6),
        hasMedia: hasMedia ? 'Yes' : 'No',
        from_name: 'RootDonate Drop'
      }).then(() => {
        alert('Dropped on map + emailed!');
        document.getElementById('postText').value = '';
      }).catch(err => {
        alert('EmailJS failed: ' + (err.text || 'check console'));
        console.error(err);
      });
    };

    // Filter controls
    document.getElementById('filterBtn').onclick = () => {
      const kw = document.getElementById('keyword').value.trim();
      loadEmailPosts(kw);
    };
    document.getElementById('clearFilter').onclick = () => {
      document.getElementById('keyword').value = '';
      loadEmailPosts();
    };

    document.getElementById('refreshEmailPosts').onclick = () => {
      loadEmailPosts(document.getElementById('keyword').value);
    };

    document.getElementById('zoomButton').onclick = () => {
      map.setView([53.4631, -2.2913], 15);
    };

    // Initial load
    loadEmailPosts();
  </script>
</body>
</html>