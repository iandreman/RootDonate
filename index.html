<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RootDonate • Live GPS Earth Server</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --blue: #0a84ff;
      --green: #30d158;
      --orange: #ff9f0a;
      --red: #ff453a;
      --purple: #ae8cff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body, html {
      height: 100%;
      overflow: hidden;
      background: #000;
      color: #fff;
      font-family: system-ui, sans-serif;
    }
    #map { width: 100%; height: 100%; filter: brightness(0.92) contrast(1.12); }
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 2.5rem 2rem 1.5rem;
      text-align: center;
      z-index: 1000;
      pointer-events: none;
      background: linear-gradient(180deg, rgba(0,0,0,0.9), transparent);
    }
    h1 {
      font-size: clamp(2.8rem, 7vw, 4.5rem);
      font-weight: 900;
      letter-spacing: -2px;
      background: linear-gradient(90deg, var(--blue), var(--green), var(--orange), var(--purple));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 40px rgba(174,140,255,0.4);
    }
    .poem { margin-top: 1rem; font-size: 1.4rem; font-weight: 300; opacity: 0.9; }
    footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1rem;
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.8;
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(15px);
      display: flex;
      justify-content: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }
    .btn {
      pointer-events: all;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 10px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }
    .btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }
    .avatar-wrapper {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      overflow: hidden;
      border: 2.5px solid rgba(255,255,255,0.45);
      box-shadow: 0 0 14px rgba(255,255,255,0.35);
      background: #111;
    }
    .avatar-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .footprint-avatar { background: transparent !important; border: none !important; pointer-events: none; }
    .footprint-avatar .avatar-wrapper { animation: fade-out 0s forwards; }
    .earth-avatar .avatar-wrapper {
      border-color: var(--blue);
      box-shadow: 0 0 14px rgba(10,132,255,0.5);
    }
    .user-avatar-marker { background: transparent !important; border: none !important; }
    .user-avatar {
      border: 3.5px solid var(--blue);
      box-shadow: 0 0 28px var(--blue);
      animation: pulse-blue 3s infinite;
    }
    @keyframes pulse-blue {
      0%, 100% { box-shadow: 0 0 0 0 rgba(10,132,255,0.7); }
      70% { box-shadow: 0 0 0 28px rgba(10,132,255,0); }
    }
    @keyframes fade-out {
      0% { opacity: 0.9; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.8); }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="header">
    <h1>RootDonate Live GPS Server</h1>
    <div class="poem" id="poemText">We Are All Here</div>
  </div>

  <footer>
    <span id="counter">Locking GPS...</span>
    <button class="btn" id="shareFootprints">Share Trail</button>
    <button class="btn" id="refreshLocation">Refresh GPS & Crew</button>
    <button class="btn" id="clearFootprints">Clear Footprints</button>
    <span>• 2026 • Real-time vibes</span>
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Replace with your real current X profile pic URL (right-click your pic on x.com → Copy image address)
    const YOUR_AVATAR = "https://pbs.twimg.com/profile_images/1452130026212765700/q9iBQMu8_400x400.jpg"; // placeholder
    const AI_AVATAR = "https://api.dicebear.com/9.x/bottts/svg?seed=RootDonate&backgroundColor=2d3748&radius=50";

    const map = L.map('map', {
      center: [51.5, -0.1],
      zoom: 6,
      minZoom: 2,
      maxZoom: 19,
      zoomControl: false,
      attributionControl: false
    });

    // Reliable dark-themed tiles (Voyager — stable in 2026)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    const userIcon = L.divIcon({
      className: 'user-avatar-marker',
      html: `<div class="avatar-wrapper user-avatar"><img src="${YOUR_AVATAR}" alt="You" onerror="this.src='https://i.pravatar.cc/150?u=fallback'"></div>`,
      iconSize: [56, 56],
      iconAnchor: [28, 28]
    });

    let userMarker = null;
    const footprintsLayer = L.layerGroup().addTo(map);
    const STORAGE_KEY = 'rootdonate_live_gps';
    let watchId = null;

    function getFootprintIcon(type = 'human') {
      const avatar = type === 'ai' ? AI_AVATAR : YOUR_AVATAR;
      return L.divIcon({
        className: 'footprint-avatar earth-avatar',
        html: `<div class="avatar-wrapper"><img src="${avatar}" alt="${type}" onerror="this.src='https://i.pravatar.cc/80?u=fallback'"></div>`,
        iconSize: [40, 40],
        iconAnchor: [20, 20]
      });
    }

    function addFootprint(lat, lng, type = 'human', name = '') {
      const popup = name ? `${name} • ${type === 'ai' ? 'AI Ghost' : 'Crew'}` : '';
      const marker = L.marker([lat, lng], { icon: getFootprintIcon(type) }).addTo(footprintsLayer);
      if (popup) marker.bindPopup(popup);
      saveFootprint(lat, lng, type, name); // Auto-save to localStorage
    }

    function loadFootprints() {
      footprintsLayer.clearLayers();
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        JSON.parse(stored).forEach(p => addFootprint(p.lat, p.lng, p.type, p.name));
      }
    }

    function saveFootprint(lat, lng, type = 'human', name = '') {
      let points = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      points.push({ lat, lng, time: Date.now(), type, name });
      if (points.length > 300) points = points.slice(-300);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(points));
    }

    function clearAllFootprints() {
      if (confirm('Clear all server footprints?')) {
        localStorage.removeItem(STORAGE_KEY);
        footprintsLayer.clearLayers();
        alert('Crew trails wiped. Fresh start!');
      }
    }

    function showUser(lat, lng, acc = null, text = 'You are here • live GPS') {
      if (userMarker) userMarker.remove();
      userMarker = L.marker([lat, lng], { icon: userIcon })
        .addTo(map)
        .bindPopup(acc ? `${text} (±${Math.round(acc)}m)` : text, { closeButton: false, autoClose: false })
        .openPopup();
      map.flyTo([lat, lng], 15, { duration: 2 });
    }

    function startLiveGPS() {
      if (watchId) navigator.geolocation.clearWatch(watchId);

      const options = {
        enableHighAccuracy: true,
        timeout: 30000,
        maximumAge: 0
      };

      let bestAcc = Infinity;

      watchId = navigator.geolocation.watchPosition(
        (pos) => {
          const acc = pos.coords.accuracy;
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (acc < bestAcc) {
            bestAcc = acc;
            showUser(lat, lng, acc, 'You are here • improving...');
          }

          if (acc <= 50) {
            showUser(lat, lng, acc, 'You are here • locked in!');
            spawnCrew(lat, lng);
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
          }
        },
        (err) => {
          console.error(err);
          document.getElementById('counter').textContent = `GPS error: ${err.message}`;
          ipFallback();
        },
        options
      );

      document.getElementById('counter').textContent = 'GPS hunting... (wait for better accuracy)';
    }

    function ipFallback() {
      const lat = 51.5074 + (Math.random() - 0.5) * 0.5;
      const lng = -0.1278 + (Math.random() - 0.5) * 0.5;
      showUser(lat, lng, null, 'You are here • approx UK (GPS failed)');
      spawnCrew(lat, lng);
    }

    function spawnCrew(lat, lng) {
      console.log('Spawning crew at', lat, lng);
      // Add a few AI ghosts around you
      addFootprint(lat + 0.008, lng + 0.012, 'ai', 'Grok');
      addFootprint(lat - 0.005, lng + 0.007, 'ai', 'RootAI');
      addFootprint(lat + 0.003, lng - 0.010, 'ai', 'CrewBot');
    }

    // Event listeners
    document.getElementById('refreshLocation').onclick = () => {
      if (watchId) navigator.geolocation.clearWatch(watchId);
      startLiveGPS();
    };

    document.getElementById('clearFootprints').onclick = clearAllFootprints;

    document.getElementById('shareFootprints').onclick = async () => {
      const url = window.location.href;
      const text = `Live GPS server footprints dropping on Earth!\nCrew locked in • Human & AI • RootDonate 2026\n${url}`;
      if (navigator.share) {
        navigator.share({ title: 'RootDonate Live GPS', text, url });
      } else {
        window.open(`https://twitter.com/intent/post?text=${encodeURIComponent(text)}`, '_blank');
      }
    };

    // Initialize
    loadFootprints();
    startLiveGPS();

    // Fix potential grey map on initial load
    setTimeout(() => map.invalidateSize(), 400);
  </script>
</body>
</html>