<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RootDonate ‚Ä¢ Live GPS Posts Map ‚Äì Carrick Era #MUFC</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5p5QbskXk=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <style>
    body, html { margin:0; height:100%; background:#000; color:#eee; font-family:system-ui,sans-serif; }
    #map { height:100%; }
    .overlay {
      position: absolute; top:10px; left:50%; transform:translateX(-50%);
      z-index:1000; background:rgba(0,0,0,0.7); padding:12px 20px; border-radius:12px;
      text-align:center; pointer-events:all; max-width:90%;
    }
    h1 { margin:0 0 8px; font-size:2.4rem; background:linear-gradient(90deg,#0af,#0f5,#f90); -webkit-background-clip:text; background-clip:text; color:transparent; }
    input, button { margin:6px 4px; padding:8px 14px; border-radius:8px; border:1px solid #444; background:#222; color:#fff; }
    button { background:#1d9bf0; border:none; cursor:pointer; font-weight:600; }
    button:hover { background:#0c85d0; }
    #status, #gpsStatus { font-size:0.9rem; color:#0f5; margin:4px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="overlay">
    <h1>RootDonate</h1>
    <div>
      <input id="keyword" placeholder="Filter e.g. training, Amad, Carrington" />
      <button id="filterBtn">Filter</button>
      <button id="clearFilter">Clear</button>
    </div>
    <div>
      <input id="postText" placeholder="Your shoutout..." style="width:240px;" />
      <label><input type="checkbox" id="hasMedia"> + Media?</label>
      <button id="addPostButton">Drop on Map & Email</button>
    </div>
    <div>
      <button id="refreshEmailPosts">Refresh Email Posts</button>
      <button id="zoomButton">Zoom Carrington</button>
      <span id="gpsStatus">GPS: checking...</span>
    </div>
    <div id="status">Jan 21, 2026 ‚Ä¢ @iandreme ‚Ä¢ Email ‚Üí GPS Nodes ‚Ä¢ #MUFC</div>
  </div>

  <script>
    emailjs.init({ publicKey: "1oXeNo5ZXiRcipyWo" }); // ‚Üê keep yours or generate new one

    const map = L.map('map').setView([53.4631, -2.2913], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap & CARTO'
    }).addTo(map);

    const markers = L.markerClusterGroup({ maxClusterRadius: 60 });
    map.addLayer(markers);

    const emailIcon = L.divIcon({
      className: 'email-marker',
      html: '<div style="background:#0f5;width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 0 8px #0f5;"></div>',
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    let userLat = 53.4631, userLng = -2.2913;
    let gpsOK = false;

    // GPS
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        userLat = pos.coords.latitude;
        userLng = pos.coords.longitude;
        gpsOK = true;
        document.getElementById('gpsStatus').textContent = `GPS: ${userLat.toFixed(4)}, ${userLng.toFixed(4)}`;
      }, () => {
        document.getElementById('gpsStatus').textContent = 'GPS off / denied ‚Äì using default';
      }, { enableHighAccuracy: true, timeout: 8000 });
    }

    function cleanCoords(latStr, lngStr) {
      if (!latStr || !lngStr) return { lat: userLat, lng: userLng };
      latStr = latStr.replace(/[^0-9.-]/g, '').trim();
      lngStr = lngStr.replace(/[^0-9.-]/g, '').trim();
      let lat = parseFloat(latStr) || userLat;
      let lng = parseFloat(lngStr) || userLng;
      if (Math.abs(lat) > 90 || Math.abs(lng) > 180) return { lat: userLat, lng: userLng };
      return { lat: +lat.toFixed(6), lng: +lng.toFixed(6) };
    }

    function addMarker(lat, lng, user, text, hasMedia = false) {
      const popup = `
        <b>${user}</b><br>
        ${text || '(no text)'}<br>
        ${hasMedia ? 'üì∏ Has media' : ''}<br>
        <small>${new Date().toLocaleString()}</small>
      `;
      L.marker([lat, lng], { icon: emailIcon })
        .addTo(markers)
        .bindPopup(popup);
    }

    async function loadEmailPosts(filter = '') {
      try {
        // Replace with your real JSON endpoint when ready (e.g. rootdonate.com/api/posts.json)
        const resp = await fetch('https://rootdonate.com'); // or a real CORS-enabled JSON
        if (!resp.ok) throw new Error('fetch failed');
        const posts = await resp.json();

        markers.clearLayers();

        posts.forEach(p => {
          const txt = (p.t || '').toLowerCase();
          if (filter && !txt.includes(filter.toLowerCase())) return;

          const { lat, lng } = cleanCoords(p.lat, p.lng);
          addMarker(lat, lng, p.u || 'Email Node', p.t || '‚Äî', p.hasMedia);
        });

        document.getElementById('status').textContent += ' ‚Ä¢ Loaded!';
      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent += ' ‚Ä¢ Load failed (check endpoint)';
      }
    }

    // Add post
    document.getElementById('addPostButton').onclick = () => {
      const text = document.getElementById('postText').value.trim();
      if (!text) return alert('Type something first!');

      const hasMedia = document.getElementById('hasMedia').checked;

      addMarker(userLat, userLng, '@iandreme', text, hasMedia);

      emailjs.send('service_amql3dos', 'template_cyl5hjt', {
        text,
        lat: userLat.toFixed(6),
        lng: userLng.toFixed(6),
        hasMedia: hasMedia ? 'Yes' : 'No',
        from_name: 'RootDonate Drop'
      }).then(() => {
        alert('Dropped on map + emailed!');
        document.getElementById('postText').value = '';
      }).catch(err => {
        alert('EmailJS failed: ' + (err.text || 'check console'));
        console.error(err);
      });
    };

    // Filter
    document.getElementById('filterBtn').onclick = () => {
      const kw = document.getElementById('keyword').value.trim();
      loadEmailPosts(kw);
    };
    document.getElementById('clearFilter').onclick = () => {
      document.getElementById('keyword').value = '';
      loadEmailPosts();
    };

    document.getElementById('refreshEmailPosts').onclick = () => loadEmailPosts(document.getElementById('keyword').value);
    document.getElementById('zoomButton').onclick = () => map.setView([53.4631, -2.2913], 15);

    // Start
    loadEmailPosts();
  </script>
</body>
</html>