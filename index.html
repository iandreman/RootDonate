<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Root Donate â€¢ Auto-Nearby GPS Pins â€¢ Swagga Rico</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    body {
      background:#0a0a12;
      color:#e0e0ff;
      font-family:'Inter',system-ui,sans-serif;
      margin:0;
      padding:20px;
      min-height:100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(120,80,255,0.07) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(52,211,153,0.06) 0%, transparent 40%);
    }
    .container { max-width:1000px; margin:0 auto; }
    h1.glow {
      font-family:'Orbitron',sans-serif;
      font-size:clamp(2.8rem,9vw,5rem);
      font-weight:900;
      text-align:center;
      margin:40px 0 10px;
      background:linear-gradient(90deg,#a78bfa,#7dd3fc,#34d399);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow:0 0 25px rgba(52,211,153,0.4);
    }
    .subtitle { text-align:center; color:#a0a0ff; margin-bottom:20px; font-size:1.1rem; }
    #status {
      padding:12px;
      margin:15px 0;
      border-radius:10px;
      text-align:center;
      display:none;
    }
    #status.success { background:rgba(52,211,153,0.25); color:#34d399; }
    #status.error   { background:rgba(239,68,68,0.25); color:#ef4444; }
    .info-bar {
      background:rgba(255,255,255,0.04);
      padding:12px 18px;
      border-radius:12px;
      margin-bottom:20px;
      text-align:center;
      font-size:0.98rem;
      border:1px solid rgba(52,211,153,0.2);
    }
    .pin-list { display:grid; gap:16px; }
    .pin {
      background:rgba(255,255,255,0.03);
      padding:18px;
      border-radius:12px;
      border:1px solid rgba(120,80,255,0.15);
      backdrop-filter:blur(6px);
    }
    .from { font-weight:600; color:#a78bfa; margin-bottom:6px; }
    .msg { margin:8px 0 12px; color:#d0d0ff; white-space:pre-wrap; word-break:break-word; }
    .meta { font-size:0.92rem; color:#a0a0a0; }
    .coords-link { color:#4cc9ff; text-decoration:none; }
    .coords-link:hover { text-decoration:underline; }
    .distance { color:#34d399; font-weight:600; }
    .no-pins { text-align:center; color:#777; padding:60px 20px; font-size:1.2rem; }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="glow">AUTO-NEARBY PINS</h1>
    <div class="subtitle">Using your existing Root Donate pins â€¢ Radius auto-adapts to density around you</div>

    <div id="status"></div>

    <div id="info-bar" class="info-bar">Waiting for location & calculating adaptive radiusâ€¦</div>

    <div id="pin-list" class="pin-list"></div>
  </div>

  <script>
    const STORAGE_KEY = 'root_donate_pins';
    let userLat = null;
    let userLng = null;

    function showStatus(msg, type = 'success') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = type;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    function getPins() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // meters
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function calculateAdaptiveRadius(centerLat, centerLng) {
      const pins = getPins();
      if (pins.length === 0) return 800; // default when empty

      const MAX_CHECK = 6000; // meters â€” broad area to sense density
      let countInArea = 0;

      pins.forEach(p => {
        const dist = haversineDistance(centerLat, centerLng, p.lat, p.lng);
        if (dist <= MAX_CHECK) countInArea++;
      });

      // Adaptive logic (more generous than before)
      if (countInArea >= 25) return 350;      // very dense â†’ tight focus
      if (countInArea >= 12) return 550;
      if (countInArea >= 5)  return 900;
      if (countInArea >= 2)  return 1300;
      return 2000;                            // sparse â†’ wide view
    }

    function renderNearby() {
      const pins = getPins();
      const container = document.getElementById('pin-list');
      const infoBar = document.getElementById('info-bar');
      container.innerHTML = '';

      if (pins.length === 0) {
        container.innerHTML = '<div class="no-pins">No pins saved in Root Donate yet ðŸŒ±</div>';
        infoBar.textContent = 'No data found in localStorage';
        return;
      }

      if (!userLat || !userLng) {
        container.innerHTML = '<div class="no-pins">Waiting for your current location...<br><small>Allow location access if prompted</small></div>';
        infoBar.textContent = 'Waiting for GPS...';
        return;
      }

      const radius = calculateAdaptiveRadius(userLat, userLng);

      const nearby = pins
        .map(p => ({
          ...p,
          distance: haversineDistance(userLat, userLng, p.lat, p.lng)
        }))
        .filter(p => p.distance <= radius)
        .sort((a, b) => a.distance - b.distance);

      if (nearby.length === 0) {
        container.innerHTML = `<div class="no-pins">No pins within adaptive radius (~${Math.round(radius)} m)<br>Try moving closer or dropping more pins</div>`;
        infoBar.innerHTML = `Current position â€¢ Adaptive radius ~${Math.round(radius)} m â€¢ No nearby roots yet`;
        return;
      }

      nearby.forEach(p => {
        const dt = new Date(p.time).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
        const name = escapeHTML(p.name || 'Anonymous');
        const msg = escapeHTML(p.msg || '(no message)');
        const coords = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
        const apple = `https://maps.apple.com/?ll=${p.lat},${p.lng}&q=${encodeURIComponent(name)}`;
        const google = `https://www.google.com/maps?q=${p.lat},${p.lng}`;

        const div = document.createElement('div');
        div.className = 'pin';
        div.innerHTML = `
          <div class="from">${name}${p.auto ? ' [auto]' : ''}</div>
          <div class="msg">${msg}</div>
          <div class="meta">
            <span class="distance">${Math.round(p.distance)} m away</span> â€¢ ${dt}<br>
            <a href="${apple}" target="_blank" class="coords-link">${coords} (Apple Maps)</a>
            <br><small><a href="${google}" target="_blank" style="color:#888;">(Google Maps)</a></small>
          </div>
        `;
        container.appendChild(div);
      });

      const densityText = nearby.length >= 15 ? 'dense hot zone' :
                          nearby.length >= 6  ? 'active flow' : 'emerging roots';

      infoBar.innerHTML = `Your position â€¢ Adaptive radius ~${Math.round(radius)} m â€¢ ${densityText} (${nearby.length} pins)`;

      showStatus(`Showing ${nearby.length} nearby pin${nearby.length === 1 ? '' : 's'}`, 'success');
    }

    // Get continuous location updates
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          renderNearby();
        },
        err => {
          showStatus(`Location error: ${err.message}`, 'error');
          renderNearby();
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    } else {
      showStatus('Geolocation not supported in this browser', 'error');
    }

    // Initial render
    renderNearby();
  </script>
</body>
</html>