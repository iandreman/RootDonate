<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nearby Pins ‚Ä¢ Shared + AI ‚Ä¢ Root Donate</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0a0a12;
      --text: #e0e0ff;
      --text-muted: #a0a0ff;
      --accent: #34d399;
      --accent-dark: #2aa980;
      --purple: #a78bfa;
      --purple-dark: #8b5cf6;
      --card-bg: rgba(255,255,255,0.03);
      --border: rgba(120,80,255,0.18);
      --glow: rgba(52,211,153,0.4);
      --ai-bg: rgba(167,139,250,0.12);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(120,80,255,0.08) 0%, transparent 45%),
        radial-gradient(circle at 90% 80%, rgba(52,211,153,0.07) 0%, transparent 45%);
      line-height: 1.5;
    }

    .container { max-width: 1100px; margin: 0 auto; }
    h1.glow {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(2.8rem, 8.5vw, 4.8rem);
      font-weight: 900;
      text-align: center;
      margin: 2rem 0 0.5rem;
      background: linear-gradient(90deg, var(--purple), #7dd3fc, var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 30px var(--glow);
    }
    .subtitle { text-align: center; color: var(--text-muted); font-size: 1.1rem; margin: 0 0 2rem; }

    #status {
      padding: 12px 20px;
      margin: 1rem 0;
      border-radius: 10px;
      text-align: center;
      display: none;
      font-weight: 500;
    }
    #status.success { background: rgba(52,211,153,0.22); color: var(--accent); }
    #status.error   { background: rgba(239,68,68,0.22); color: #f87171; }

    .info-bar {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(52,211,153,0.18);
      border-radius: 12px;
      padding: 14px 20px;
      margin: 1.5rem 0;
      text-align: center;
      font-size: 0.98rem;
    }

    .post-section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(8px);
    }
    .post-section h2 { margin: 0 0 1rem; font-size: 1.25rem; color: var(--purple); }

    .form-group { margin-bottom: 1rem; }
    input, textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(52,211,153,0.15);
    }
    textarea { min-height: 90px; resize: vertical; }

    button {
      padding: 12px 24px;
      font-weight: 600;
      font-size: 1rem;
      color: white;
      background: linear-gradient(45deg, #7c3aed, #3b82f6);
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.25s ease;
      margin: 0 8px 12px 0;
    }
    button:hover { transform: translateY(-1px); opacity: 0.95; box-shadow: 0 6px 20px rgba(59,130,246,0.3); }
    button:active { transform: translateY(0); }

    button.ai-btn {
      background: linear-gradient(45deg, #8b5cf6, #c084fc);
    }

    .search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }
    #search-input {
      width: 100%;
      padding: 14px 16px 14px 40px;
      font-size: 1rem;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 999px;
      color: white;
    }
    #search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(52,211,153,0.15);
    }
    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }

    #suggestions {
      position: absolute;
      top: 100%;
      left: 0; right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 220px;
      overflow-y: auto;
      z-index: 1000;
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      display: none;
      margin-top: 4px;
    }
    #suggestions div {
      padding: 10px 16px;
      cursor: pointer;
      color: var(--text);
      border-bottom: 1px solid var(--border);
    }
    #suggestions div:last-child { border-bottom: none; }
    #suggestions div:hover, #suggestions div.selected { background: rgba(52,211,153,0.2); }

    .pin-list { display: grid; gap: 16px; }
    .pin {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      backdrop-filter: blur(6px);
    }
    .pin.ai-pin { background: var(--ai-bg); border-color: rgba(167,139,250,0.3); }
    .from { font-weight: 600; color: var(--purple); margin-bottom: 0.5rem; }
    .from.ai { color: #c084fc; }
    .msg { margin: 0.6rem 0 1rem; color: #d0d0ff; white-space: pre-wrap; word-break: break-word; }
    .meta { font-size: 0.92rem; color: #a0a0a0; }
    .coords-link { color: #60a5fa; text-decoration: none; }
    .coords-link:hover { text-decoration: underline; }
    .distance { color: var(--accent); font-weight: 600; }

    .share-btn, .import-btn {
      margin-top: 1rem;
      width: 100%;
      padding: 12px;
      background: linear-gradient(45deg, #6366f1, var(--purple));
    }
    .share-btn:hover, .import-btn:hover { box-shadow: 0 6px 20px rgba(139,92,246,0.3); }

    .no-pins {
      text-align: center;
      color: #777;
      padding: 80px 20px;
      font-size: 1.25rem;
    }

    .actions { text-align: center; margin: 1.5rem 0; }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="glow">NEARBY PINS</h1>
    <div class="subtitle">Human notes ‚Ä¢ AI observations ‚Ä¢ Share anywhere</div>

    <div id="status"></div>
    <div id="info-bar" class="info-bar">Acquiring location‚Ä¶</div>

    <div class="post-section">
      <h2>Drop a Pin</h2>
      <div class="form-group">
        <input type="text" id="new-name" placeholder="Your name (optional)">
      </div>
      <div class="form-group">
        <textarea id="new-msg" placeholder="Message or note‚Ä¶"></textarea>
      </div>
      <button onclick="postNewPin()">Post My Pin</button>
      <button class="ai-btn" onclick="postAIPin()">AI Auto-Pin</button>
    </div>

    <div class="search-container">
      <span class="search-icon">üîç</span>
      <input type="search" id="search-input" placeholder="Search places, addresses, postcodes‚Ä¶">
      <div id="suggestions"></div>
    </div>

    <div class="actions">
      <button onclick="shareAllNearby()">Share All Nearby Pins</button>
      <button class="import-btn" onclick="importFromURL()">Import from Shared Link</button>
    </div>

    <div id="pin-list" class="pin-list"></div>
  </div>

  <script>
    const STORAGE_KEY = 'nearby_pins_shared_ai';
    let userLat = null;
    let userLng = null;

    const MAX_ACCEPTABLE_ACCURACY = 60;
    const MIN_MOVEMENT_THRESHOLD = 4;
    const EMA_ALPHA = 0.18;

    let smoothedLat = null;
    let smoothedLng = null;
    let lastReportedLat = null;
    let lastReportedLng = null;

    function showStatus(msg, type = 'success') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = type;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    function getPins() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }

    function savePins(pins) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function calculateAdaptiveRadius(lat, lng) {
      const pins = getPins();
      if (!pins.length) return 1000;
      let count = pins.filter(p => haversineDistance(lat, lng, p.lat, p.lng) < 6000).length;
      if (count >= 30) return 400;
      if (count >= 15) return 600;
      if (count >= 6)  return 1000;
      return 1800;
    }

    function generateShareUrl(pinsArray) {
      try {
        const encoded = btoa(JSON.stringify(pinsArray));
        const base = window.location.href.split('?')[0].split('#')[0];
        return `${base}?pins=${encodeURIComponent(encoded)}`;
      } catch {
        return '';
      }
    }

    function copyShareLink(url) {
      if (!url) return showStatus('Link creation failed', 'error');
      navigator.clipboard.writeText(url)
        .then(() => showStatus('Link copied to clipboard!', 'success'))
        .catch(() => {
          showStatus('Copy failed ‚Äî select manually', 'error');
          prompt('Copy this link:', url);
        });
    }

    function renderNearby() {
      const pins = getPins();
      const container = document.getElementById('pin-list');
      const infoBar = document.getElementById('info-bar');
      container.innerHTML = '';

      if (!pins.length) {
        container.innerHTML = '<div class="no-pins">No pins yet ‚Äî drop one!</div>';
        infoBar.textContent = 'No pins saved';
        return;
      }

      if (!userLat || !userLng) {
        container.innerHTML = '<div class="no-pins">Waiting for GPS‚Ä¶</div>';
        infoBar.textContent = 'Getting location';
        return;
      }

      const radius = calculateAdaptiveRadius(userLat, userLng);
      const nearby = pins
        .map(p => ({ ...p, distance: haversineDistance(userLat, userLng, p.lat, p.lng) }))
        .filter(p => p.distance <= radius)
        .sort((a, b) => a.distance - b.distance);

      if (!nearby.length) {
        container.innerHTML = `<div class="no-pins">Nothing within ‚âà${Math.round(radius)} m</div>`;
        infoBar.innerHTML = `‚âà${Math.round(radius)} m ‚Ä¢ Empty area`;
        return;
      }

      nearby.forEach(p => {
        const dt = new Date(p.time).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
        const name = escapeHTML(p.name || 'Anonymous');
        const msg = escapeHTML(p.msg || '(no message)');
        const coords = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
        const apple = `https://maps.apple.com/?ll=${p.lat},${p.lng}&q=${encodeURIComponent(name)}`;
        const google = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
        const isAI = p.source === 'ai';
        const pinClass = isAI ? 'pin ai-pin' : 'pin';

        const div = document.createElement('div');
        div.className = pinClass;
        div.innerHTML = `
          <div class="from ${isAI ? 'ai' : ''}">${name}${isAI ? ' ‚Ä¢ AI' : ''}${p.auto ? ' ‚Ä¢ auto' : ''}</div>
          <div class="msg">${msg}</div>
          <div class="meta">
            <span class="distance">${Math.round(p.distance)} m away</span> ‚Ä¢ ${dt}<br>
            <a href="${apple}" target="_blank" class="coords-link">${coords} (Apple)</a><br>
            <small><a href="${google}" target="_blank" style="color:#888;">Google Maps</a></small>
          </div>
          <button class="share-btn" onclick="copyShareLink('${generateShareUrl([p]).replace(/'/g,"\\'")}')">Share This Pin</button>
        `;
        container.appendChild(div);
      });

      const density = nearby.length >= 12 ? 'Busy zone' : nearby.length >= 5 ? 'Active' : 'Quiet';
      infoBar.innerHTML = `‚âà${Math.round(radius)} m ‚Ä¢ ${density} (${nearby.length} pin${nearby.length === 1 ? '' : 's'})`;
    }

    function postNewPin() {
      if (!userLat || !userLng) return showStatus('Waiting for location‚Ä¶', 'error');
      const name = document.getElementById('new-name').value.trim();
      const msg = document.getElementById('new-msg').value.trim();

      const pin = {
        lat: userLat,
        lng: userLng,
        name: name || 'Anonymous',
        msg: msg || '',
        time: new Date().toISOString(),
        source: 'human',
        auto: false
      };

      const pins = getPins();
      pins.push(pin);
      savePins(pins);
      document.getElementById('new-name').value = '';
      document.getElementById('new-msg').value = '';
      showStatus('Pin added!', 'success');
      renderNearby();
    }

    function postAIPin() {
      if (!userLat || !userLng) return showStatus('Waiting for location‚Ä¶', 'error');

      const aiMessages = [
        `AI note: Local time is ${new Date().toLocaleTimeString()}`,
        `AI: ${Math.round(Math.random() * 30 + 5)}¬∞C feels like today`,
        `AI observation: Popular time for visits here`,
        `AI: Moon phase ‚Äî ${['New', 'Waxing Crescent', 'First Quarter', 'Waxing Gibbous', 'Full', 'Waning Gibbous', 'Last Quarter', 'Waning Crescent'][Math.floor(Math.random()*8)]}`,
        `AI: This spot has good energy today`
      ];

      const pin = {
        lat: userLat,
        lng: userLng,
        name: 'AI',
        msg: aiMessages[Math.floor(Math.random() * aiMessages.length)],
        time: new Date().toISOString(),
        source: 'ai',
        auto: true
      };

      const pins = getPins();
      pins.push(pin);
      savePins(pins);
      showStatus('AI note added ü§ñ', 'success');
      renderNearby();
    }

    function shareAllNearby() {
      const pins = getPins();
      if (!userLat || !userLng) return showStatus('Need location first', 'error');
      const radius = calculateAdaptiveRadius(userLat, userLng);
      const nearby = pins.filter(p => haversineDistance(userLat, userLng, p.lat, p.lng) <= radius);
      if (!nearby.length) return showStatus('No nearby pins to share', 'error');

      const url = generateShareUrl(nearby);
      copyShareLink(url);
    }

    function importFromURL() {
      const params = new URLSearchParams(window.location.search);
      const encoded = params.get('pins');
      if (!encoded) return showStatus('No shared pins in URL', 'error');

      try {
        const imported = JSON.parse(atob(encoded));
        if (!Array.isArray(imported)) throw new Error();

        const pins = getPins();
        const existing = new Set(pins.map(p => `${p.lat.toFixed(6)}|${p.lng.toFixed(6)}|${p.time}`));
        const newPins = imported.filter(p => !existing.has(`${p.lat.toFixed(6)}|${p.lng.toFixed(6)}|${p.time}`));

        if (!newPins.length) return showStatus('No new pins found', 'success');

        pins.push(...newPins);
        savePins(pins);
        showStatus(`Imported ${newPins.length} pin${newPins.length === 1 ? '' : 's'}`, 'success');
        renderNearby();
      } catch {
        showStatus('Invalid shared link', 'error');
      }
    }

    // GPS
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          if (pos.coords.accuracy > MAX_ACCEPTABLE_ACCURACY) return;
          const rawLat = pos.coords.latitude;
          const rawLng = pos.coords.longitude;

          if (lastReportedLat !== null) {
            if (haversineDistance(lastReportedLat, lastReportedLng, rawLat, rawLng) < MIN_MOVEMENT_THRESHOLD) return;
          }

          smoothedLat = smoothedLat === null ? rawLat : EMA_ALPHA * rawLat + (1 - EMA_ALPHA) * smoothedLat;
          smoothedLng = smoothedLng === null ? rawLng : EMA_ALPHA * rawLng + (1 - EMA_ALPHA) * smoothedLng;

          lastReportedLat = rawLat;
          lastReportedLng = rawLng;
          userLat = smoothedLat;
          userLng = smoothedLng;

          renderNearby();
        },
        err => showStatus(`Location error: ${err.message}`, 'error'),
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }

    // Place search (Nominatim) ‚Äî unchanged from your original
    const provider = {
      search: async (query) => {
        if (query.length < 3) return [];
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=6&countrycodes=gb&q=${encodeURIComponent(query)}`);
          const data = await res.json();
          return data.map(item => ({
            label: item.display_name,
            lat: parseFloat(item.lat),
            lng: parseFloat(item.lon)
          }));
        } catch {
          return [];
        }
      }
    };

    const input = document.getElementById('search-input');
    const suggestionsDiv = document.getElementById('suggestions');
    let selectedIndex = -1;

    function showSuggestions(results) {
      suggestionsDiv.innerHTML = '';
      if (!results.length) return suggestionsDiv.style.display = 'none';
      results.forEach((r, i) => {
        const div = document.createElement('div');
        div.textContent = r.label;
        div.dataset.lat = r.lat;
        div.dataset.lng = r.lng;
        div.dataset.index = i;
        div.onclick = () => {
          userLat = r.lat;
          userLng = r.lng;
          input.value = r.label;
          suggestionsDiv.style.display = 'none';
          renderNearby();
          showStatus(`Viewing area: ${r.label}`, 'success');
        };
        suggestionsDiv.appendChild(div);
      });
      suggestionsDiv.style.display = 'block';
      selectedIndex = -1;
    }

    let debounce;
    input.addEventListener('input', () => {
      clearTimeout(debounce);
      debounce = setTimeout(async () => {
        const q = input.value.trim();
        if (q.length < 3) return suggestionsDiv.style.display = 'none';
        showSuggestions(await provider.search(q));
      }, 350);
    });

    input.addEventListener('keydown', e => {
      const items = suggestionsDiv.querySelectorAll('div');
      if (!items.length) return;
      if (e.key === 'ArrowDown') {
        selectedIndex = (selectedIndex + 1) % items.length;
        items.forEach((el, i) => el.classList.toggle('selected', i === selectedIndex));
      } else if (e.key === 'ArrowUp') {
        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        items.forEach((el, i) => el.classList.toggle('selected', i === selectedIndex));
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        const item = items[selectedIndex];
        userLat = parseFloat(item.dataset.lat);
        userLng = parseFloat(item.dataset.lng);
        input.value = item.textContent;
        suggestionsDiv.style.display = 'none';
        renderNearby();
      } else if (e.key === 'Escape') {
        suggestionsDiv.style.display = 'none';
      }
    });

    document.addEventListener('click', e => {
      if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.style.display = 'none';
      }
    });

    // Auto-import shared pins on load
    if (window.location.search.includes('pins=')) importFromURL();

    renderNearby();
  </script>
</body>
</html>