<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Root Donate â€¢ Nearby Pins â€¢ Swagga Rico</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0a0a12;
      --text: #e0e0ff;
      --text-muted: #a0a0ff;
      --accent: #34d399;
      --accent-dark: #2aa980;
      --purple: #a78bfa;
      --purple-dark: #8b5cf6;
      --card-bg: rgba(255,255,255,0.03);
      --border: rgba(120,80,255,0.18);
      --glow: rgba(52,211,153,0.4);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(120,80,255,0.08) 0%, transparent 45%),
        radial-gradient(circle at 90% 80%, rgba(52,211,153,0.07) 0%, transparent 45%);
      line-height: 1.5;
    }

    .container { max-width: 1100px; margin: 0 auto; }
    h1.glow {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(2.8rem, 8.5vw, 4.8rem);
      font-weight: 900;
      text-align: center;
      margin: 2rem 0 0.5rem;
      background: linear-gradient(90deg, var(--purple), #7dd3fc, var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 30px var(--glow);
    }
    .subtitle { text-align: center; color: var(--text-muted); font-size: 1.1rem; margin: 0 0 2rem; }

    #status {
      padding: 12px 20px;
      margin: 1rem 0;
      border-radius: 10px;
      text-align: center;
      display: none;
      font-weight: 500;
    }
    #status.success { background: rgba(52,211,153,0.22); color: var(--accent); }
    #status.error   { background: rgba(239,68,68,0.22); color: #f87171; }

    .info-bar {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(52,211,153,0.18);
      border-radius: 12px;
      padding: 14px 20px;
      margin: 1.5rem 0;
      text-align: center;
      font-size: 0.98rem;
    }

    .post-section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(8px);
    }
    .post-section h2 { margin: 0 0 1rem; font-size: 1.25rem; color: var(--purple); }

    .form-group { margin-bottom: 1rem; }
    input, textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(52,211,153,0.15);
    }
    textarea { min-height: 90px; resize: vertical; }

    button {
      padding: 14px 28px;
      font-weight: 600;
      font-size: 1rem;
      color: white;
      background: linear-gradient(45deg, #7c3aed, #3b82f6);
      border: none;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    button:hover {
      transform: translateY(-1px);
      opacity: 0.95;
      box-shadow: 0 6px 20px rgba(59,130,246,0.3);
    }
    button:active { transform: translateY(0); }

    .search-container {
      display: flex;
      gap: 12px;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    #search-input { flex: 1; min-width: 240px; }

    .pin-list { display: grid; gap: 16px; }
    .pin {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      backdrop-filter: blur(6px);
    }
    .from { font-weight: 600; color: var(--purple); margin-bottom: 0.5rem; }
    .msg { margin: 0.6rem 0 1rem; color: #d0d0ff; white-space: pre-wrap; word-break: break-word; }
    .meta { font-size: 0.92rem; color: #a0a0a0; }
    .coords-link { color: #60a5fa; text-decoration: none; }
    .coords-link:hover { text-decoration: underline; }
    .distance { color: var(--accent); font-weight: 600; }
    .share-btn {
      margin-top: 1rem;
      width: 100%;
      background: linear-gradient(45deg, #6366f1, var(--purple));
      padding: 12px;
    }
    .share-btn:hover { box-shadow: 0 6px 20px rgba(139,92,246,0.3); }

    .no-pins {
      text-align: center;
      color: #777;
      padding: 80px 20px;
      font-size: 1.25rem;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="glow">NEARBY PINS</h1>
    <div class="subtitle">Discover â€¢ Search â€¢ Share â€¢ Create location pins</div>

    <div id="status"></div>
    <div id="info-bar" class="info-bar">Acquiring stable locationâ€¦</div>

    <div class="post-section">
      <h2>Create New Pin</h2>
      <div class="form-group">
        <input type="text" id="new-name" placeholder="Your name (optional)" aria-label="Your name">
      </div>
      <div class="form-group">
        <textarea id="new-msg" placeholder="Message or note (optional)" aria-label="Message"></textarea>
      </div>
      <button onclick="postNewPin()">Post Pin at Current Location</button>
    </div>

    <div class="search-container">
      <input type="search" id="search-input" placeholder="Search pins by name, message or coordinatesâ€¦" aria-label="Search pins">
      <button onclick="renderSearchResults()">Search</button>
    </div>

    <div id="pin-list" class="pin-list"></div>
  </div>

  <script>
    const STORAGE_KEY = 'root_donate_pins';
    let userLat = null;
    let userLng = null;

    // â”€â”€ GPS SMOOTHING TUNABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const MAX_ACCEPTABLE_ACCURACY = 60;      // meters â€” ignore worse than this
    const MIN_MOVEMENT_THRESHOLD = 4;        // meters â€” ignore smaller changes
    const EMA_ALPHA = 0.18;                  // 0.1 = very smooth / slow, 0.3 = responsive
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let smoothedLat = null;
    let smoothedLng = null;
    let lastReportedLat = null;
    let lastReportedLng = null;

    const ROOT_DONATE_BASE_URL = 'https://rootdonate.co.uk';

    function showStatus(msg, type = 'success') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = type;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    function getPins() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }

    function savePins(pins) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function calculateAdaptiveRadius(lat, lng) {
      const pins = getPins();
      if (!pins.length) return 800;

      const MAX_CHECK = 6000;
      let count = 0;
      for (const p of pins) {
        if (haversineDistance(lat, lng, p.lat, p.lng) <= MAX_CHECK) count++;
      }

      if (count >= 25) return 350;
      if (count >= 12) return 550;
      if (count >= 5)  return 900;
      if (count >= 2)  return 1300;
      return 2000;
    }

    function generateShareUrl(pin) {
      try {
        const encoded = btoa(JSON.stringify(pin));
        return `${ROOT_DONATE_BASE_URL}#pin=${encodeURIComponent(encoded)}`;
      } catch {
        return '';
      }
    }

    function copyShareLink(url) {
      if (!url) return showStatus('Could not generate share link', 'error');

      navigator.clipboard.writeText(url)
        .then(() => showStatus('Share link copied!', 'success'))
        .catch(() => {
          showStatus('Copy failed â€” select & copy manually', 'error');
          prompt('Copy this link:', url);
        });
    }

    function renderNearby() {
      const pins = getPins();
      const container = document.getElementById('pin-list');
      const infoBar = document.getElementById('info-bar');
      container.innerHTML = '';

      if (!pins.length) {
        container.innerHTML = '<div class="no-pins">No pins saved yet</div>';
        infoBar.textContent = 'No pins in storage';
        return;
      }

      if (!userLat || !userLng) {
        container.innerHTML = '<div class="no-pins">Waiting for stable GPSâ€¦</div>';
        infoBar.textContent = 'Acquiring location';
        return;
      }

      const radius = calculateAdaptiveRadius(userLat, userLng);
      const nearby = pins
        .map(p => ({ ...p, distance: haversineDistance(userLat, userLng, p.lat, p.lng) }))
        .filter(p => p.distance <= radius)
        .sort((a, b) => a.distance - b.distance);

      if (!nearby.length) {
        container.innerHTML = `<div class="no-pins">No pins within â‰ˆ${Math.round(radius)} m<br>(move or drop new pins)</div>`;
        infoBar.innerHTML = `â‰ˆ${Math.round(radius)} m â€¢ Nothing nearby`;
        return;
      }

      nearby.forEach(p => {
        const dt = new Date(p.time).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
        const name = escapeHTML(p.name || 'Anonymous');
        const msg = escapeHTML(p.msg || '(no message)');
        const coords = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
        const appleMaps = `https://maps.apple.com/?ll=${p.lat},${p.lng}&q=${encodeURIComponent(name)}`;
        const googleMaps = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
        const shareUrl = generateShareUrl(p);

        const div = document.createElement('div');
        div.className = 'pin';
        div.innerHTML = `
          <div class="from">${name}${p.auto ? ' â€¢ auto' : ''}</div>
          <div class="msg">${msg}</div>
          <div class="meta">
            <span class="distance">${Math.round(p.distance)} m away</span> â€¢ ${dt}<br>
            <a href="${appleMaps}" target="_blank" rel="noopener noreferrer" class="coords-link">${coords} (Apple Maps)</a><br>
            <small><a href="${googleMaps}" target="_blank" rel="noopener noreferrer" style="color:#888;">Google Maps</a></small>
          </div>
          ${shareUrl && `<button class="share-btn" onclick="copyShareLink('${shareUrl.replace(/'/g,"\\'")}')">Share Pin</button>`}
        `;
        container.appendChild(div);
      });

      const density = nearby.length >= 15 ? 'High-density zone' :
                      nearby.length >= 6  ? 'Active zone' : 'Growing zone';

      infoBar.innerHTML = `â‰ˆ${Math.round(radius)} m adaptive â€¢ ${density} (${nearby.length} pin${nearby.length === 1 ? '' : 's'})`;
      showStatus(`Found ${nearby.length} nearby pin${nearby.length === 1 ? '' : 's'}`, 'success');
    }

    function renderSearchResults() {
      const term = document.getElementById('search-input').value.trim().toLowerCase();
      if (!term) return showStatus('Enter something to search', 'error');

      const pins = getPins();
      const container = document.getElementById('pin-list');
      container.innerHTML = '';

      const filtered = pins.filter(p =>
        (p.name || '').toLowerCase().includes(term) ||
        (p.msg || '').toLowerCase().includes(term) ||
        `${p.lat?.toFixed(6) || ''},${p.lng?.toFixed(6) || ''}`.includes(term)
      );

      if (!filtered.length) {
        container.innerHTML = '<div class="no-pins">No matching pins</div>';
        return showStatus('No results', 'error');
      }

      filtered.sort((a, b) => new Date(b.time) - new Date(a.time));

      filtered.forEach(p => {
        const dt = new Date(p.time).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
        const name = escapeHTML(p.name || 'Anonymous');
        const msg = escapeHTML(p.msg || '(no message)');
        const coords = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
        const appleMaps = `https://maps.apple.com/?ll=${p.lat},${p.lng}&q=${encodeURIComponent(name)}`;
        const googleMaps = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
        const shareUrl = generateShareUrl(p);

        const div = document.createElement('div');
        div.className = 'pin';
        div.innerHTML = `
          <div class="from">${name}${p.auto ? ' â€¢ auto' : ''}</div>
          <div class="msg">${msg}</div>
          <div class="meta">
            ${dt} â€¢ 
            <a href="${appleMaps}" target="_blank" rel="noopener noreferrer" class="coords-link">${coords} (Apple Maps)</a><br>
            <small><a href="${googleMaps}" target="_blank" rel="noopener noreferrer" style="color:#888;">Google Maps</a></small>
          </div>
          ${shareUrl && `<button class="share-btn" onclick="copyShareLink('${shareUrl.replace(/'/g,"\\'")}')">Share Pin</button>`}
        `;
        container.appendChild(div);
      });

      showStatus(`Found ${filtered.length} matching pin${filtered.length === 1 ? '' : 's'}`, 'success');
      document.getElementById('info-bar').innerHTML = 'Search results â€” all pins';
    }

    function postNewPin() {
      if (!userLat || !userLng) {
        return showStatus('No stable location yet â€” wait for GPS', 'error');
      }

      const name = document.getElementById('new-name').value.trim();
      const msg = document.getElementById('new-msg').value.trim();

      const newPin = {
        lat: userLat,
        lng: userLng,
        name: name || 'Anonymous',
        msg: msg || '',
        time: new Date().toISOString(),
        auto: false
      };

      const pins = getPins();
      pins.push(newPin);
      savePins(pins);

      document.getElementById('new-name').value = '';
      document.getElementById('new-msg').value = '';

      showStatus('Pin dropped ðŸ”¥', 'success');
      renderNearby();
    }

    // â”€â”€ GPS with smoothing & filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          const acc = pos.coords.accuracy;

          // 1. Ignore bad accuracy
          if (acc > MAX_ACCEPTABLE_ACCURACY) {
            console.log(`Ignored low-accuracy fix: ${acc.toFixed(1)}m`);
            return;
          }

          const rawLat = pos.coords.latitude;
          const rawLng = pos.coords.longitude;

          // 2. Skip tiny movements (likely jitter)
          if (lastReportedLat !== null) {
            const moved = haversineDistance(lastReportedLat, lastReportedLng, rawLat, rawLng);
            if (moved < MIN_MOVEMENT_THRESHOLD) {
              return;
            }
          }

          // 3. Apply EMA smoothing
          if (smoothedLat === null) {
            smoothedLat = rawLat;
            smoothedLng = rawLng;
          } else {
            smoothedLat = EMA_ALPHA * rawLat + (1 - EMA_ALPHA) * smoothedLat;
            smoothedLng = EMA_ALPHA * rawLng + (1 - EMA_ALPHA) * smoothedLng;
          }

          lastReportedLat = rawLat;
          lastReportedLng = rawLng;

          userLat = smoothedLat;
          userLng = smoothedLng;

          renderNearby();
        },
        err => {
          showStatus(`GPS error: ${err.message}`, 'error');
          renderNearby();
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    } else {
      showStatus('Geolocation not supported in this browser', 'error');
    }

    window.copyShareLink = copyShareLink;

    // Initial render
    renderNearby();

    // Search on Enter
    document.getElementById('search-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        renderSearchResults();
      }
    });
  </script>
</body>
</html>