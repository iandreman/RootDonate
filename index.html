<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS Pins – Private Location Markers</title>
  <meta name="description" content="Save private GPS locations with notes and threaded comments. 100% local storage, offline-capable, no account required." />

  <style>
    :root {
      --bg:        #0a0e1a;
      --surface:   #141822;
      --text:      #e0e7ff;
      --muted:     #8899aa;
      --accent:    #00d4ff;
      --accent-dim:#00ff9d;
      --purple:    #bb86fc;
      --danger:    #ff5555;
      --border:    rgba(0,212,255,0.18);
      --shadow:    0 4px 20px rgba(0,0,0,0.4);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', Courier, monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem 1.4rem;
      background: rgba(0,0,0,0.6);
      border-bottom: 1px solid var(--border);
      text-align: center;
    }
    h1 {
      font-size: 2.1rem;
      background: linear-gradient(90deg, var(--purple), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .subtitle { color: var(--muted); font-size: 0.95rem; margin-top: 0.5rem; }
    .tabs {
      margin: 1.2rem 0 0.8rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 0.7rem 1.6rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      cursor: pointer;
      font-weight: bold;
      transition: all 0.18s;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--purple), var(--accent));
      color: #000;
      border-color: transparent;
    }
    .tab-content {
      flex: 1;
      display: none;
      overflow: hidden;
      flex-direction: column;
    }
    .tab-content.active { display: flex; }

    /* Terminal */
    #terminal-tab .terminal {
      flex: 1;
      padding: 1.3rem 1.8rem;
      overflow-y: auto;
      line-height: 1.55;
      font-size: 1rem;
    }
    .line { margin: 0.5rem 0; white-space: pre-wrap; word-break: break-word; }
    .prompt    { color: var(--accent-dim); }
    .ai        { color: #00ffea; }
    .system    { color: #778899; }
    .error     { color: var(--danger); }
    .input-line {
      display: flex;
      align-items: flex-start;
      padding: 1rem 1.8rem;
      background: rgba(0,0,0,0.4);
      border-top: 1px solid var(--border);
    }
    .input-line .prompt { margin-right: 1rem; flex-shrink: 0; }
    #input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--accent);
      font: inherit;
      outline: none;
      caret-color: var(--accent);
    }
    .cursor {
      display: inline-block;
      width: 10px;
      height: 1.3em;
      background: var(--accent);
      animation: blink 1.2s step-end infinite;
      margin-left: 5px;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* My Pins */
    #pins-tab {
      padding: 1.5rem;
      overflow-y: auto;
    }
    .collection-header {
      text-align: center;
      margin: 0 0 1.6rem;
      color: var(--accent);
      font-size: 1.5rem;
    }
    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 6rem 1.5rem;
      font-size: 1.15rem;
      line-height: 1.7;
    }
    .card {
      background: rgba(20,24,34,0.97);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.3rem 0;
      box-shadow: var(--shadow);
    }
    .pin-title { color: var(--accent); font-size: 1.4rem; margin-bottom: 0.7rem; }
    .meta {
      color: var(--muted);
      font-size: 0.95rem;
      margin: 0.8rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 1.6rem;
    }
    .saved-label { color: #00ff9d; font-weight: bold; }
    .note { margin: 1.2rem 0; white-space: pre-wrap; line-height: 1.5; }
    .comments {
      margin-top: 1.6rem;
      padding: 1rem;
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .comments-header {
      margin-bottom: 1rem;
      color: var(--accent-dim);
      font-size: 1.1rem;
    }
    .comment {
      margin: 1.1rem 0;
      padding: 0.9rem 1.1rem;
      background: rgba(0,212,255,0.06);
      border-radius: 6px;
      border-left: 3px solid var(--accent-dim);
    }
    .comment-text {
      line-height: 1.45;
      margin-bottom: 0.5rem;
    }
    .comment-meta {
      font-size: 0.82rem;
      color: var(--muted);
      opacity: 0.9;
    }
    #search {
      width: 100%;
      max-width: 500px;
      padding: 0.9rem;
      margin: 0 auto 1.8rem;
      display: block;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
    }
    .share-row {
      margin-top: 1.8rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .action-btn {
      padding: 0.6rem 1.4rem;
      background: rgba(0,212,255,0.18);
      border: 1px solid var(--accent-dim);
      border-radius: 8px;
      color: var(--accent);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }
    .action-btn:hover { background: rgba(0,212,255,0.35); }
    .action-btn.copied,
    .action-btn.saved {
      background: rgba(0,255,157,0.3);
      color: #00ff9d;
      border-color: #00ff9d;
    }

    /* Floating new pin button */
    #fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--purple), var(--accent));
      color: #000;
      border: none;
      border-radius: 50%;
      font-size: 2.2rem;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(0,0,0,0.5);
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    #fab:hover { transform: scale(1.1); }
    #fab:active { transform: scale(0.95); }

    @media (max-width: 560px) {
      .tabs { flex-direction: column; gap: 0.6rem; }
      .tab-btn { width: 100%; }
      .share-row { flex-direction: column; align-items: stretch; }
      .action-btn { width: 100%; text-align: center; }
      #fab { bottom: 16px; right: 16px; width: 56px; height: 56px; font-size: 2rem; }
    }
  </style>
</head>
<body>

<header>
  <h1>GPS Pins</h1>
  <div class="subtitle">Private location markers with notes & threaded comments — fully local storage</div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="terminal">Terminal</button>
    <button class="tab-btn" data-tab="pins">My Pins</button>
  </div>
</header>

<!-- Terminal Tab -->
<div id="terminal-tab" class="tab-content active">
  <div class="terminal" id="terminal"></div>
  <div class="input-line">
    <span class="prompt">></span>
    <input id="input" type="text" autocomplete="off" spellcheck="false" autofocus>
    <span class="cursor"></span>
  </div>
</div>

<!-- My Pins Tab -->
<div id="pins-tab" class="tab-content">
  <div class="collection-header">My Saved Pins</div>
  <input type="text" id="search" placeholder="Search name, note, comment, coordinates…">
  <div id="pins-container"></div>
</div>

<!-- Floating Action Button -->
<button id="fab" title="Create new pin at current location">+</button>

<script>
// ────────────────────────────────────────────────
// Shared
// ────────────────────────────────────────────────
const STORAGE_KEY = 'gps-pins-v3';
let lastUsedName = localStorage.getItem('gps-pins-last-name') || '';

function escapeHTML(str = '') {
  const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
  return str.replace(/[&<>"']/g, m => map[m]);
}

function getPins() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch { return []; }
}

function savePins(pins) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
}

function getPinShareUrl(pin) {
  // Only public-safe fields are shared
  const publicPin = {
    id: pin.id,
    lat: pin.lat,
    lng: pin.lng,
    name: pin.name,
    time: pin.time
    // note (msg) and comments are deliberately NOT included
  };
  return `${location.origin}${location.pathname}#p=${btoa(JSON.stringify(publicPin))}`;
}

function pinAlreadySaved(pinId) {
  return getPins().some(p => p.id === pinId);
}

// ────────────────────────────────────────────────
// Terminal & Pin Creation
// ────────────────────────────────────────────────
const terminal = document.getElementById('terminal');
const inputEl  = document.getElementById('input');

function println(txt, cls = 'line') {
  const div = document.createElement('div');
  div.className = cls;
  div.innerHTML = txt;
  terminal.appendChild(div);
  terminal.scrollTop = terminal.scrollHeight;
}

function printAI(txt) { println(txt, 'line ai'); }
function printError(txt) { println(txt, 'line error'); }
function clearScreen() { terminal.innerHTML = ''; }

async function createAndSavePin(usePrompts = true) {
  let name = lastUsedName || 'Pin ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  let note = '';
  let comment = '';

  if (usePrompts) {
    const nameInput = prompt("Pin name:", name)?.trim();
    if (nameInput === null) return;
    name = nameInput || 'Untitled';

    note   = prompt("Note / description (optional):")?.trim() || '';
    comment = prompt("Initial comment (optional):")?.trim() || '';
  }

  localStorage.setItem('gps-pins-last-name', name);

  if (!navigator.geolocation) {
    printError("Geolocation not supported.");
    return;
  }

  try {
    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej, {
        enableHighAccuracy: true,
        timeout: 12000,
        maximumAge: 0
      })
    );

    const lat = Number(pos.coords.latitude.toFixed(6));
    const lng = Number(pos.coords.longitude.toFixed(6));

    const pin = {
      id: crypto.randomUUID(),
      lat,
      lng,
      name,
      msg: note,
      time: new Date().toISOString(),
      comments: comment ? [{ text: comment, author: name, time: new Date().toISOString() }] : []
    };

    const pins = getPins();
    pins.push(pin);
    savePins(pins);

    const shareUrl = getPinShareUrl(pin);

    printAI(`Pin saved → <strong>${escapeHTML(name)}</strong>`);
    println(`Location: ${lat}, ${lng}`, 'line ai');
    println(`Share link (name + coords only): <a href="${shareUrl}" style="color:var(--accent); word-break:break-all;">${shareUrl}</a>`, 'line ai');
    println(`→ See it in "My Pins" tab`, 'line ai');
  } catch (err) {
    let msg = "Could not get location.";
    if (err.code === 1) msg += " → Permission denied";
    if (err.code === 3) msg += " → Timed out";
    printError(msg);
  }
}

function generateResponse(text) {
  const lower = text.toLowerCase().trim();
  const pins = getPins();

  // ── Clear ────────────────────────────────────────────────
  if (["clear", "cls"].includes(lower)) {
    clearScreen();
    return null;
  }

  // ── Help ─────────────────────────────────────────────────
  if (lower === "help" || lower === "?" || lower === "commands") {
    return `GPS Pins Terminal – Commands:

  + / save / new / drop / create pin    → Add pin at current location
  list / pins / my pins / saved         → Quick list of all pins
  recent / latest                       → 5–6 most recent pins
  count                                 → Number of saved pins
  search <keyword>                      → Find in name/note/comments/coords
  show <name>                           → Detailed view of pin(s) by name
  import pin                            → Import a shared pin you just opened
  clear / cls                           → Clear screen
  help / ? / commands                   → This help

Examples:
  search coffee
  show home
  recent
  list
  import pin
  count

100% local – private – offline.`;
  }

  // ── Count ────────────────────────────────────────────────
  if (lower === "count") {
    const cnt = pins.length;
    return `You have **${cnt}** pin${cnt === 1 ? '' : 's'} saved.`;
  }

  // ── List ─────────────────────────────────────────────────
  if (["list", "pins", "my pins", "saved"].some(w => lower.includes(w))) {
    if (pins.length === 0) return "No pins yet.\nType + or save pin to start.";

    let out = `Your pins (${pins.length} total):\n\n`;
    pins.forEach((p, i) => {
      out += `${String(i+1).padStart(2,' ')}. ${escapeHTML(p.name || 'Unnamed')}   (${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})\n`;
      if (p.msg) out += `      ${escapeHTML(p.msg.slice(0, 60))}${p.msg.length > 60 ? '…' : ''}\n`;
      out += "\n";
    });
    return out + "→ Full view + comments in \"My Pins\" tab";
  }

  // ── Recent ───────────────────────────────────────────────
  if (lower === "recent" || lower === "latest") {
    if (pins.length === 0) return "No pins saved yet.";

    const sorted = [...pins].sort((a,b) => new Date(b.time) - new Date(a.time));
    let out = "Recent pins:\n\n";
    sorted.slice(0, 6).forEach(p => {
      out += `• ${escapeHTML(p.name || 'Unnamed')}   •   ${new Date(p.time).toLocaleString([], {
        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      })}\n   ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}\n`;
      if (p.msg) out += `   ${escapeHTML(p.msg.slice(0, 65))}${p.msg.length > 65 ? '…' : ''}\n`;
      out += "\n";
    });
    if (sorted.length > 6) out += `… ${sorted.length - 6} more pins`;
    return out;
  }

  // ── Search ───────────────────────────────────────────────
  if (lower.startsWith("search ")) {
    const term = lower.slice(7).trim();
    if (!term) return "Example:\n  search coffee\n  search 51.507\n  search beach";

    const matches = pins.filter(p => {
      const hay = [
        (p.name || '').toLowerCase(),
        (p.msg || '').toLowerCase(),
        ...p.comments.map(c => (c.text || '').toLowerCase()),
        p.lat.toFixed(6), p.lng.toFixed(6),
        new Date(p.time).toISOString().slice(0,10)
      ].join(' ');
      return hay.includes(term);
    });

    if (matches.length === 0) return `No matches for "${escapeHTML(term)}"`;

    let out = `Found **${matches.length}** result${matches.length === 1 ? '' : 's'} for "${escapeHTML(term)}":\n\n`;
    matches.forEach(p => {
      out += `→ ${escapeHTML(p.name || 'Unnamed')}\n   ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}  •  ${new Date(p.time).toLocaleDateString()}\n`;
      if (p.msg) out += `   ${escapeHTML(p.msg.slice(0, 70))}${p.msg.length > 70 ? '…' : ''}\n`;
      out += "\n";
    });
    return out + "→ Details + comments in \"My Pins\" tab";
  }

  // ── Show ─────────────────────────────────────────────────
  if (lower.startsWith("show ")) {
    const query = lower.slice(5).trim();
    if (!query) return "Example:\n  show home\n  show coffee shop";

    const matches = pins.filter(p => (p.name || '').toLowerCase().includes(query));

    if (matches.length === 0) return `No pin found matching "${escapeHTML(query)}"`;
    if (matches.length > 4) return `Too many matches (${matches.length}). Try a more specific name.`;

    let out = "";
    matches.forEach(p => {
      out += `**${escapeHTML(p.name || 'Unnamed Pin')}**\n`;
      out += `Coords:   ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}\n`;
      out += `Added:    ${new Date(p.time).toLocaleString([], {
        weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      })}\n`;

      if (p.msg) out += `\nNote:\n${escapeHTML(p.msg)}\n\n`;
      if (p.comments.length) {
        out += `Comments (${p.comments.length}):\n`;
        p.comments.forEach(c => {
          out += `• ${escapeHTML(c.text)}  (${c.author || 'anon'}, ${new Date(c.time).toLocaleDateString()})\n`;
        });
        out += "\n";
      }
      out += "──────────────────────────────\n\n";
    });
    return out.trim();
  }

  // ── Import shared pin ────────────────────────────────────────
  if (lower === "import pin" || lower.startsWith("import ")) {
    const pending = sessionStorage.getItem('pending-shared-pin');
    if (!pending) return "No pending shared pin.\nOpen a share link first, then type 'import pin'.";

    try {
      const pin = JSON.parse(pending);
      sessionStorage.removeItem('pending-shared-pin');

      if (pinAlreadySaved(pin.id)) {
        return "This pin is already in your collection.";
      }

      // We only have public fields → prompt for note & comment if desired
      const addNote = confirm(`Import "${pin.name || 'Unnamed'}" (${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)})\n\nWould you like to add your own note?`);
      let msg = '';
      if (addNote) {
        msg = prompt("Enter your private note (optional):")?.trim() || '';
      }

      const fullPin = {
        ...pin,
        msg,
        comments: msg ? [{ text: "Imported pin — starting fresh note", author: "You", time: new Date().toISOString() }] : []
      };

      const pins = getPins();
      pins.push(fullPin);
      savePins(pins);

      return `Pin imported → ${escapeHTML(pin.name || 'Unnamed')}\n` +
             `Now visible in "My Pins" tab (your note is private).`;
    } catch (e) {
      return "Failed to import pin (data may be corrupted).";
    }
  }

  // ── Fallback ─────────────────────────────────────────────
  const vibes = [
    "Pins grid online. Ready.",
    "Local vault responsive.",
    "Coordinates secured.",
    "Terminal standing by.",
    "Database nominal. Query me."
  ];
  return vibes[Math.floor(Math.random() * vibes.length)];
}

inputEl.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  e.preventDefault();
  const text = inputEl.value.trim();
  if (!text) return;

  println('> ' + escapeHTML(text), 'line prompt');

  const reply = generateResponse(text);
  if (reply) printAI(reply);

  inputEl.value = '';
  inputEl.focus();
});

// Floating button quick-create
document.getElementById('fab').addEventListener('click', () => {
  createAndSavePin(true);
  document.querySelector('[data-tab="terminal"]').click();
});

// ────────────────────────────────────────────────
// My Pins Rendering (no shared preview anymore)
// ────────────────────────────────────────────────
function renderMyPins(pinsToShow = getPins()) {
  const container = document.getElementById('pins-container');
  container.innerHTML = '';

  if (pinsToShow.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        No pins yet.<br><br>
        Create one:<br>
        • tap the <strong style="color:var(--accent);">+</strong> button<br>
        • or type “+” or “save pin” in Terminal
      </div>
    `;
    return;
  }

  pinsToShow.forEach(pin => {
    const shareUrl = getPinShareUrl(pin);

    let emailBody = `GPS Pin: ${pin.name || 'Unnamed'}\n\n`;
    emailBody += `Coordinates: ${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)}\n\n`;
    if (pin.msg) emailBody += `Note:\n${pin.msg}\n\n`;
    if (pin.comments.length) {
      emailBody += `Comments (${pin.comments.length}):\n`;
      pin.comments.forEach(c => {
        emailBody += `• ${c.text}  (${c.author || 'anon'}, ${new Date(c.time).toLocaleString()})\n`;
      });
      emailBody += '\n';
    }
    emailBody += `Share link (public view): ${shareUrl}\n`;

    const encodedSubject = encodeURIComponent(`GPS Pin: ${pin.name || 'Unnamed'}`);
    const encodedBody = encodeURIComponent(emailBody);
    const mailtoLink = `mailto:?subject=${encodedSubject}&body=${encodedBody}`;

    let html = `
      <div class="card">
        <div class="pin-title">${escapeHTML(pin.name || 'Unnamed')}</div>
        <div class="meta">
          <span>${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)}</span>
          ${pin.time ? `<span class="saved-label">Added ${new Date(pin.time).toLocaleDateString()}</span>` : ''}
        </div>
        ${pin.msg ? `<div class="note">${escapeHTML(pin.msg)}</div>` : ''}
        ${pin.comments.length ? `
          <div class="comments">
            <div class="comments-header">Comments (${pin.comments.length})</div>
            ${pin.comments.map(c => `
              <div class="comment">
                <div class="comment-text">${escapeHTML(c.text)}</div>
                <div class="comment-meta">— ${escapeHTML(c.author || 'anonymous')} • ${new Date(c.time).toLocaleString()}</div>
              </div>
            `).join('')}
          </div>
        ` : ''}
        <div class="share-row">
          <button class="action-btn" onclick="navigator.clipboard.writeText('${shareUrl}').then(()=> {this.textContent='Copied!'; setTimeout(()=>this.textContent='Copy share link',2000)})">
            Copy share link
          </button>
          <a href="${mailtoLink}" class="action-btn" target="_blank">Email this pin</a>
        </div>
      </div>`;
    container.insertAdjacentHTML('beforeend', html);
  });
}

// Search in My Pins tab
document.getElementById('search').addEventListener('input', e => {
  const term = e.target.value.toLowerCase().trim();
  if (!term) return renderMyPins();
  const filtered = getPins().filter(p => {
    const hay = [
      (p.name||'').toLowerCase(),
      (p.msg||'').toLowerCase(),
      ...p.comments.map(c => (c.text||'').toLowerCase()),
      p.lat.toFixed(6),
      p.lng.toFixed(6)
    ].join(' ');
    return hay.includes(term);
  });
  renderMyPins(filtered);
});

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    const tabId = btn.dataset.tab + '-tab';
    document.getElementById(tabId).classList.add('active');

    if (btn.dataset.tab === 'terminal') {
      inputEl.focus();
    } else if (btn.dataset.tab === 'pins') {
      renderMyPins();
    }
  });
});

// Handle shared pin links → go to terminal + offer import
window.addEventListener('hashchange', () => {
  const hash = location.hash.slice(1);
  if (hash.startsWith('p=')) {
    try {
      const publicPin = JSON.parse(atob(hash.slice(2)));

      // Switch to terminal
      document.querySelector('[data-tab="terminal"]').click();

      printAI(`Shared pin received: <strong>${escapeHTML(publicPin.name || 'Unnamed')}</strong>`);
      println(`Location: ${publicPin.lat.toFixed(6)}, ${publicPin.lng.toFixed(6)}`, 'line ai');
      println(`Type <strong>import pin</strong> to add it to your private collection.`, 'line system');
      println(`(Notes & comments are not shared — only you can add them.)`);

      // Store temporarily for import command
      sessionStorage.setItem('pending-shared-pin', JSON.stringify(publicPin));

      // Clean URL
      history.replaceState(null, null, ' ');
    } catch (e) {
      println("Invalid shared pin link.", 'line error');
    }
  }
});
if (location.hash) window.dispatchEvent(new HashChangeEvent('hashchange'));

// Boot message
println("GPS Pins — London 2026", "system");
println("100% local • Private • Offline", "system");
println("────────────────────────────────────────", "system");
println("");
printAI("Ready. Type <strong>help</strong> or tap + to drop a pin.");
println("");
</script>
</body>
</html>
