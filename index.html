<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nearby Pins ‚Ä¢ Share via URL ‚Ä¢ Smart Import</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0a0a12;
      --text: #e0e0ff;
      --text-muted: #a0a0ff;
      --accent: #34d399;
      --accent-dark: #2aa980;
      --purple: #a78bfa;
      --purple-dark: #8b5cf6;
      --card-bg: rgba(255,255,255,0.03);
      --border: rgba(120,80,255,0.18);
      --glow: rgba(52,211,153,0.4);
      --ai-bg: rgba(167,139,250,0.12);
      --imported: rgba(59,130,246,0.15);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(120,80,255,0.08) 0%, transparent 45%),
        radial-gradient(circle at 90% 80%, rgba(52,211,153,0.07) 0%, transparent 45%);
      line-height: 1.5;
    }

    .container { max-width: 1100px; margin: 0 auto; }
    h1.glow {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(2.8rem, 8.5vw, 4.8rem);
      font-weight: 900;
      text-align: center;
      margin: 2rem 0 0.5rem;
      background: linear-gradient(90deg, var(--purple), #7dd3fc, var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 30px var(--glow);
    }
    .subtitle { text-align: center; color: var(--text-muted); font-size: 1.1rem; margin: 0 0 2rem; }

    #status {
      padding: 12px 20px;
      margin: 1rem 0;
      border-radius: 10px;
      text-align: center;
      display: none;
      font-weight: 500;
    }
    #status.success { background: rgba(52,211,153,0.22); color: var(--accent); }
    #status.error   { background: rgba(239,68,68,0.22); color: #f87171; }

    .info-bar {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(52,211,153,0.18);
      border-radius: 12px;
      padding: 14px 20px;
      margin: 1.5rem 0;
      text-align: center;
      font-size: 0.98rem;
    }

    .post-section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(8px);
    }

    input, textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: white;
      font-size: 1rem;
    }
    input:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(52,211,153,0.15);
    }
    textarea { min-height: 90px; resize: vertical; }

    button {
      padding: 12px 24px;
      font-weight: 600;
      font-size: 1rem;
      color: white;
      background: linear-gradient(45deg, #7c3aed, #3b82f6);
      border: none;
      border-radius: 999px;
      cursor: pointer;
      margin: 0 8px 12px 0;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(59,130,246,0.3); }

    button.ai-btn { background: linear-gradient(45deg, #8b5cf6, #c084fc); }
    button.share-all { background: linear-gradient(45deg, #ec4899, #f43f5e); }

    .search-container { position: relative; margin-bottom: 1.5rem; }
    #search-input {
      padding-left: 40px;
    }
    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    #suggestions {
      position: absolute;
      top: 100%;
      left: 0; right: 0;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 220px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    #suggestions div {
      padding: 10px 16px;
      cursor: pointer;
    }
    #suggestions div:hover { background: rgba(52,211,153,0.2); }

    .pin-list { display: grid; gap: 16px; }
    .pin {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }
    .pin.imported { background: var(--imported); border-color: #60a5fa; }
    .pin.ai-pin { background: var(--ai-bg); }
    .from { font-weight: 600; color: var(--purple); }
    .from.ai { color: #c084fc; }
    .msg { margin: 0.6rem 0; color: #d0d0ff; white-space: pre-wrap; }
    .meta { font-size: 0.92rem; color: #a0a0a0; }
    .distance { color: var(--accent); font-weight: 600; }

    .share-btn {
      margin-top: 1rem;
      width: 100%;
      background: linear-gradient(45deg, #6366f1, var(--purple));
    }

    .no-pins { text-align: center; color: #777; padding: 80px 20px; font-size: 1.25rem; }

    .actions { text-align: center; margin: 1.5rem 0; }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="glow">NEARBY PINS</h1>
    <div class="subtitle">Drop pins ‚Ä¢ Share via link ‚Ä¢ Anyone can import & see</div>

    <div id="status"></div>
    <div id="info-bar" class="info-bar">Acquiring location‚Ä¶</div>

    <div class="post-section">
      <h2>Drop Pin Here</h2>
      <input type="text" id="new-name" placeholder="Name (optional)">
      <textarea id="new-msg" placeholder="Message / note‚Ä¶"></textarea>
      <button onclick="postNewPin()">Post My Pin</button>
      <button class="ai-btn" onclick="postAIPin()">AI Suggestion Pin</button>
    </div>

    <div class="search-container">
      <span class="search-icon">üîç</span>
      <input type="search" id="search-input" placeholder="Search places or addresses‚Ä¶">
      <div id="suggestions"></div>
    </div>

    <div class="actions">
      <button onclick="shareAllNearbyPins()">Share All Nearby Pins (Link)</button>
      <button onclick="importPinsFromURL()">Import Pins from URL</button>
    </div>

    <div id="pin-list" class="pin-list"></div>
  </div>

  <script>
    const STORAGE_KEY = 'nearby_pins_url_share';
    let userLat = null, userLng = null;
    const MAX_ACC = 60;
    const MIN_MOVE = 4;
    const EMA = 0.18;
    let smoothLat = null, smoothLng = null;
    let lastLat = null, lastLng = null;

    function showStatus(msg, type = 'success') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = type;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function escape(s) { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function getPins() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; } }
    function savePins(p) { localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }

    function dist(lat1, lon1, lat2, lon2) {
      const R = 6371000, dLat = (lat2-lat1)*Math.PI/180, dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function adaptiveRadius() {
      const pins = getPins();
      if (!pins.length || !userLat) return 1200;
      let c = pins.filter(p => dist(userLat,userLng,p.lat,p.lng) < 7000).length;
      return c > 25 ? 400 : c > 12 ? 700 : c > 5 ? 1100 : 1800;
    }

    function renderPins() {
      const pins = getPins(), cont = document.getElementById('pin-list'), ib = document.getElementById('info-bar');
      cont.innerHTML = '';

      if (!pins.length) {
        cont.innerHTML = '<div class="no-pins">No pins ‚Äî drop or import some!</div>';
        ib.textContent = 'No pins';
        return;
      }

      if (!userLat) {
        cont.innerHTML = '<div class="no-pins">Waiting for location‚Ä¶</div>';
        ib.textContent = 'Getting GPS';
        return;
      }

      const rad = adaptiveRadius();
      const nearby = pins.map(p => ({...p, d: dist(userLat,userLng,p.lat,p.lng)}))
        .filter(p => p.d <= rad)
        .sort((a,b) => a.d - b.d);

      if (!nearby.length) {
        cont.innerHTML = `<div class="no-pins">No pins in ‚âà${Math.round(rad)} m</div>`;
        ib.innerHTML = `‚âà${Math.round(rad)} m ‚Ä¢ Empty`;
        return;
      }

      nearby.forEach(p => {
        const dt = new Date(p.time).toLocaleString('en-GB',{dateStyle:'medium',timeStyle:'short'});
        const cl = p.imported ? 'pin imported' : p.source === 'ai' ? 'pin ai-pin' : 'pin';
        const from = `<div class="from ${p.source === 'ai' ? 'ai' : ''}">${escape(p.name || 'Anon')}${p.source === 'ai' ? ' ‚Ä¢ AI' : ''}</div>`;
        const meta = `<div class="meta"><span class="distance">${Math.round(p.d)} m</span> ‚Ä¢ ${dt}<br>${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}</div>`;

        const div = document.createElement('div');
        div.className = cl;
        div.innerHTML = `${from}<div class="msg">${escape(p.msg || '(empty)')}</div>${meta}`;
        cont.appendChild(div);
      });

      ib.innerHTML = `‚âà${Math.round(rad)} m ‚Ä¢ ${nearby.length} pin${nearby.length>1?'s':''}`;
    }

    function postPin(source = 'human') {
      if (!userLat) return showStatus('No location yet', 'error');
      const name = document.getElementById('new-name').value.trim() || 'Anon';
      const msg = document.getElementById('new-msg').value.trim() || '';

      const pin = { lat: userLat, lng: userLng, name, msg, time: new Date().toISOString(), source, imported: false };
      const pins = getPins();
      pins.push(pin);
      savePins(pins);

      document.getElementById('new-name').value = '';
      document.getElementById('new-msg').value = '';
      showStatus(source === 'ai' ? 'AI pin added ü§ñ' : 'Pin added!', 'success');
      renderPins();
    }

    window.postNewPin = () => postPin('human');
    window.postAIPin = () => {
      const msgs = [
        `AI: Time here ‚âà ${new Date().toLocaleTimeString()}`,
        `AI: Nice spot ‚Äî elevation ~${Math.round(Math.random()*300)}m`,
        `AI: Good vibes detected`,
        `AI: Weather-friendly area today`
      ];
      document.getElementById('new-msg').value = msgs[Math.floor(Math.random()*msgs.length)];
      postPin('ai');
    };

    function generateShareLink() {
      const pins = getPins().filter(p => dist(userLat,userLng,p.lat,p.lng) <= adaptiveRadius());
      if (!pins.length) return showStatus('No nearby pins to share', 'error');
      const enc = btoa(JSON.stringify(pins));
      const url = `${location.origin}${location.pathname}?pins=${encodeURIComponent(enc)}`;
      navigator.clipboard.writeText(url).then(() => showStatus('Share link copied! Send to anyone.', 'success'))
        .catch(() => prompt('Copy this share link:', url));
    }

    window.shareAllNearbyPins = generateShareLink;

    function importPinsFromURL() {
      const p = new URLSearchParams(location.search).get('pins');
      if (!p) return showStatus('No pins in URL ‚Äî share one first!', 'error');

      try {
        const imported = JSON.parse(atob(p));
        if (!Array.isArray(imported)) throw 0;

        const pins = getPins();
        const seen = new Set(pins.map(p => `${p.lat.toFixed(6)}|${p.lng.toFixed(6)}|${p.time.slice(0,19)}`));
        const added = imported.filter(i => {
          const key = `${i.lat.toFixed(6)}|${i.lng.toFixed(6)}|${(i.time||'').slice(0,19)}`;
          return !seen.has(key);
        }).map(i => ({...i, imported: true}));

        if (!added.length) return showStatus('No new pins to import', 'success');

        pins.push(...added);
        savePins(pins);
        showStatus(`Imported ${added.length} new pin${added.length>1?'s':''} ‚Äî marked blue`, 'success');

        // Smart: if no GPS yet, center on first imported pin
        if (!userLat && added[0]) {
          userLat = added[0].lat;
          userLng = added[0].lng;
        }

        renderPins();
      } catch {
        showStatus('Invalid pin data in link', 'error');
      }
    }

    window.importPinsFromURL = importPinsFromURL;

    // GPS
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(pos => {
        if (pos.coords.accuracy > MAX_ACC) return;
        const rl = pos.coords.latitude, rg = pos.coords.longitude;
        if (lastLat && dist(lastLat, lastLng, rl, rg) < MIN_MOVE) return;

        smoothLat = smoothLat ? EMA * rl + (1-EMA) * smoothLat : rl;
        smoothLng = smoothLng ? EMA * rg + (1-EMA) * smoothLng : rg;
        lastLat = rl; lastLng = rg;
        userLat = smoothLat; userLng = smoothLng;
        renderPins();
      }, e => showStatus('GPS issue: ' + e.message, 'error'), {enableHighAccuracy:true});
    }

    // Initial
    if (location.search.includes('pins=')) importPinsFromURL();
    renderPins();
  </script>
</body>
</html>