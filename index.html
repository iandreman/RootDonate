<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Root Donate ‚Ä¢ Nearby + Search + Share ‚Ä¢ Swagga Rico</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">

  <style>
    body {
      background:#0a0a12;
      color:#e0e0ff;
      font-family:'Inter',system-ui,sans-serif;
      margin:0;
      padding:20px;
      min-height:100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(120,80,255,0.07) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(52,211,153,0.06) 0%, transparent 40%);
    }
    .container { max-width:1100px; margin:0 auto; }
    h1.glow {
      font-family:'Orbitron',sans-serif;
      font-size:clamp(2.8rem,9vw,5rem);
      font-weight:900;
      text-align:center;
      margin:40px 0 10px;
      background:linear-gradient(90deg,#a78bfa,#7dd3fc,#34d399);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow:0 0 25px rgba(52,211,153,0.4);
    }
    .subtitle { text-align:center; color:#a0a0ff; margin-bottom:20px; font-size:1.1rem; }
    #status {
      padding:12px; margin:15px 0; border-radius:10px; text-align:center; display:none;
    }
    #status.success { background:rgba(52,211,153,0.25); color:#34d399; }
    #status.error   { background:rgba(239,68,68,0.25); color:#ef4444; }
    .info-bar {
      background:rgba(255,255,255,0.04);
      padding:12px 18px;
      border-radius:12px;
      margin:20px 0;
      text-align:center;
      font-size:0.98rem;
      border:1px solid rgba(52,211,153,0.2);
    }
    .search-container {
      display:flex;
      gap:12px;
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    #search-input {
      flex:1;
      min-width:220px;
      padding:14px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      color:white;
      font-size:1rem;
    }
    button {
      padding:14px 24px;
      background:linear-gradient(45deg,#7c3aed,#3b82f6);
      border:none;
      border-radius:999px;
      color:white;
      font-weight:600;
      cursor:pointer;
      transition:all 0.3s;
    }
    button:hover { transform:translateY(-2px); opacity:0.95; }
    .pin-list { display:grid; gap:16px; }
    .pin {
      background:rgba(255,255,255,0.03);
      padding:18px;
      border-radius:12px;
      border:1px solid rgba(120,80,255,0.15);
      backdrop-filter:blur(6px);
    }
    .from { font-weight:600; color:#a78bfa; margin-bottom:6px; }
    .msg { margin:8px 0 12px; color:#d0d0ff; white-space:pre-wrap; word-break:break-word; }
    .meta { font-size:0.92rem; color:#a0a0a0; }
    .coords-link { color:#4cc9ff; text-decoration:none; }
    .coords-link:hover { text-decoration:underline; }
    .distance { color:#34d399; font-weight:600; }
    button.share-btn {
      margin-top:12px;
      width:100%;
      padding:10px;
      background:linear-gradient(45deg,#6366f1,#a78bfa);
      border:none;
      border-radius:999px;
      color:white;
      font-weight:600;
      cursor:pointer;
    }
    button.share-btn:hover { transform:translateY(-2px); }
    .no-pins { text-align:center; color:#777; padding:60px 20px; font-size:1.2rem; }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="glow">NEARBY + SEARCH + SHARE</h1>
    <div class="subtitle">Your existing pins ‚Ä¢ Auto radius nearby ‚Ä¢ Search all ‚Ä¢ Share any</div>

    <div id="status"></div>

    <div id="info-bar" class="info-bar">Waiting for location & calculating adaptive radius‚Ä¶</div>

    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search all pins (name / msg / coords)...">
      <button onclick="renderSearchResults()">Search All</button>
    </div>

    <div id="pin-list" class="pin-list"></div>
  </div>

  <script>
    const STORAGE_KEY = 'root_donate_pins';
    let userLat = null;
    let userLng = null;

    // CHANGE THIS to match your main Root Donate page URL
    const ROOT_DONATE_BASE_URL = 'https://rootdonate.co.uk';  
    // or: window.location.origin + '/root-donate.html'
    // or local: 'file:///C:/path/to/root-donate.html'

    function showStatus(msg, type = 'success') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = type;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }

    function getPins() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function calculateAdaptiveRadius(lat, lng) {
      const pins = getPins();
      if (pins.length === 0) return 800;

      const MAX_CHECK = 6000;
      let count = 0;
      pins.forEach(p => {
        if (haversineDistance(lat, lng, p.lat, p.lng) <= MAX_CHECK) count++;
      });

      if (count >= 25) return 350;
      if (count >= 12) return 550;
      if (count >= 5)  return 900;
      if (count >= 2)  return 1300;
      return 2000;
    }

    function generateShareUrl(pin) {
      try {
        const encoded = btoa(JSON.stringify(pin));
        return `${ROOT_DONATE_BASE_URL}#pin=${encodeURIComponent(encoded)}`;
      } catch {
        return '';
      }
    }

    function copyShareLink(url) {
      if (!url) return showStatus('Share link failed', 'error');
      navigator.clipboard.writeText(url).then(() => {
        showStatus('Share link copied! Paste to Root Donate page', 'success');
      }).catch(() => {
        showStatus('Copy failed ‚Äî manual copy', 'error');
        prompt('Copy this link:', url);
      });
    }

    function renderNearby() {
      const pins = getPins();
      const container = document.getElementById('pin-list');
      const infoBar = document.getElementById('info-bar');
      container.innerHTML = '';

      if (pins.length === 0) {
        container.innerHTML = '<div class="no-pins">No pins saved yet</div>';
        infoBar.textContent = 'No data in localStorage';
        return;
      }

      if (!userLat || !userLng) {
        container.innerHTML = '<div class="no-pins">Waiting for location‚Ä¶ allow access</div>';
        infoBar.textContent = 'Waiting for GPS';
        return;
      }

      const radius = calculateAdaptiveRadius(userLat, userLng);
      const nearby = pins
        .map(p => ({ ...p, distance: haversineDistance(userLat, userLng, p.lat, p.lng) }))
        .filter(p => p.distance <= radius)
        .sort((a,b) => a.distance - b.distance);

      if (nearby.length === 0) {
        container.innerHTML = `<div class="no-pins">No pins in ~${Math.round(radius)} m<br>(move or add pins)</div>`;
        infoBar.innerHTML = `~${Math.round(radius)} m adaptive ‚Ä¢ No nearby pins`;
        return;
      }

      nearby.forEach(p => {
        const dt = new Date(p.time).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
        const name = escapeHTML(p.name || 'Anonymous');
        const msg = escapeHTML(p.msg || '(no message)');
        const coords = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
        const apple = `https://maps.apple.com/?ll=${p.lat},${p.lng}&q=${encodeURIComponent(name)}`;
        const google = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
        const shareUrl = generateShareUrl(p);

        const div = document.createElement('div');
        div.className = 'pin';
        div.innerHTML = `
          <div class="from">${name}${p.auto ? ' [auto]' : ''}</div>
          <div class="msg">${msg}</div>
          <div class="meta">
            <span class="distance">${Math.round(p.distance)} m away</span> ‚Ä¢ ${dt}<br>
            <a href="${apple}" target="_blank" class="coords-link">${coords} (Apple)</a>
            <br><small><a href="${google}" target="_blank" style="color:#888;">(Google)</a></small>
          </div>
          ${shareUrl ? `<button class="share-btn" onclick="copyShareLink('${shareUrl.replace(/'/g,'\\\'')}')">Share this pin üìç</button>` : ''}
        `;
        container.appendChild(div);
      });

      const density = nearby.length >= 15 ? 'dense zone' :
                      nearby.length >= 6  ? 'active flow' : 'emerging roots';

      infoBar.innerHTML = `~${Math.round(radius)} m adaptive ‚Ä¢ ${density} (${nearby.length} pins)`;
      showStatus(`Nearby: ${nearby.length} pins`, 'success');
    }

    function renderSearchResults() {
      const term = document.getElementById('search-input').value.trim().toLowerCase();
      if (!term) return showStatus('Enter search term', 'error');

      const pins = getPins();
      const container = document.getElementById('pin-list');
      container.innerHTML = '';

      const filtered = pins.filter(p =>
        p.name.toLowerCase().includes(term) ||
        (p.msg || '').toLowerCase().includes(term) ||
        `${p.lat?.toFixed(6) || ''},${p.lng?.toFixed(6) || ''}`.includes(term)
      );

      if (filtered.length === 0) {
        container.innerHTML = '<div class="no-pins">No matching pins found</div>';
        return showStatus('No results', 'error');
      }

      filtered.sort((a,b) => new Date(b.time) - new Date(a.time));

      filtered.forEach(p => {
        const dt = new Date(p.time).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
        const name = escapeHTML(p.name || 'Anonymous');
        const msg = escapeHTML(p.msg || '(no message)');
        const coords = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
        const apple = `https://maps.apple.com/?ll=${p.lat},${p.lng}&q=${encodeURIComponent(name)}`;
        const google = `https://www.google.com/maps?q=${p.lat},${p.lng}`;
        const shareUrl = generateShareUrl(p);

        const div = document.createElement('div');
        div.className = 'pin';
        div.innerHTML = `
          <div class="from">${name}${p.auto ? ' [auto]' : ''}</div>
          <div class="msg">${msg}</div>
          <div class="meta">
            ${dt} ‚Ä¢ 
            <a href="${apple}" target="_blank" class="coords-link">${coords} (Apple)</a>
            <br><small><a href="${google}" target="_blank" style="color:#888;">(Google)</a></small>
          </div>
          ${shareUrl ? `<button class="share-btn" onclick="copyShareLink('${shareUrl.replace(/'/g,'\\\'')}')">Share this pin üìç</button>` : ''}
        `;
        container.appendChild(div);
      });

      showStatus(`Found ${filtered.length} pins matching "${term}"`, 'success');
      document.getElementById('info-bar').innerHTML = 'Search results (all pins)';
    }

    // Live location
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          renderNearby();
        },
        err => {
          showStatus(`Location error: ${err.message}`, 'error');
          renderNearby();
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    } else {
      showStatus('Geolocation not supported', 'error');
    }

    window.copyShareLink = copyShareLink;

    // Initial render (nearby view)
    renderNearby();

    // Optional: search on Enter
    document.getElementById('search-input').addEventListener('keypress', e => {
      if (e.key === 'Enter') renderSearchResults();
    });
  </script>
</body>
</html>