<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Root Drops + Phone GPS History â€¢ ~500 m</title>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#eee; font-family:Arial,Helvetica,sans-serif; }
    .container { max-width:600px; margin:0 auto; padding:20px; }
    h1 { text-align:center; color:#00ff55; margin:10px 0 16px; }
    input, textarea { width:100%; padding:12px; margin:8px 0; border:1px solid #444; border-radius:8px; background:#111; color:white; font-size:1em; box-sizing:border-box; }
    textarea { resize:vertical; min-height:90px; }
    .buttons { display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin:16px 0; }
    button { padding:13px 24px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; transition:all 0.2s; min-width:160px; }
    #dropBtn   { background:#00cc44; color:black; }
    #dropBtn:hover   { background:#00ff55; }
    #clearBtn  { background:#cc0000; color:white; }
    #clearBtn:hover  { background:#ff3333; }
    #reloadHistoryBtn { background:#1e90ff; color:white; }
    #reloadHistoryBtn:hover { background:#4169e1; }
    #status { text-align:center; margin:12px 0; min-height:1.4em; font-size:0.95em; }
    .success { color:#0f5; }
    .error   { color:#f66; }
    .pin-list { margin-top:16px; }
    .location-group { margin-bottom:28px; }
    .location-header { background:#1a1a1a; padding:10px 14px; border-radius:8px 8px 0 0; font-weight:bold; color:#0f5; border:1px solid #333; border-bottom:none; font-size:1.05em; }
    .pin { background:#111; border:1px solid #333; border-top:none; padding:14px 16px; margin:0; }
    .pin:not(:last-child) { border-bottom:1px solid #222; }
    .pin-header { font-weight:bold; color:#55ff99; margin-bottom:6px; }
    .pin-msg { margin:8px 0 10px; white-space:pre-wrap; line-height:1.4; }
    .pin-time { font-size:0.82em; color:#777; text-align:right; margin-top:6px; }
    .info-box { background:#222; padding:12px; border-radius:8px; margin:12px 0; font-size:0.95em; line-height:1.4; }
    .section-title { color:#00ff55; font-size:1.2em; margin:20px 0 8px; text-align:center; }
    #dropZone { border:2px dashed #00ff55; border-radius:12px; padding:40px; text-align:center; margin:20px 0; cursor:pointer; transition:all 0.3s; background:#111; }
    #dropZone.dragover { background:#222; border-color:#00cc44; }
    #dropZone p { margin:10px 0; color:#aaa; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Root Drops + Phone GPS History âš½ #MUFC (~500 m)</h1>

    <div class="info-box" id="locationInfo">Waiting for location...</div>

    <div class="section-title">Post a New Drop (~500 m visibility)</div>
    <input type="text" id="name" placeholder="Name / @handle" value="@iandreme" />
    <textarea id="msg" placeholder="Your message / shoutout..."></textarea>

    <div class="buttons">
      <button id="dropBtn">Drop Message</button>
      <button id="clearBtn">Clear Drops ~500 m</button>
    </div>

    <div class="section-title">Load Phone GPS Timeline</div>
    <div id="dropZone">
      <p>Drag & drop Timeline.json here<br>or click to select file</p>
      <input type="file" id="fileInput" accept=".json" style="display:none;">
    </div>

    <div class="buttons" style="margin-top: -8px;">
      <button id="reloadHistoryBtn">â†» Re-load previous GPS history</button>
    </div>

    <div id="status"></div>

    <div class="section-title">Nearby Drops & Historical Pins</div>
    <div class="pin-list" id="pinList"></div>
  </div>

  <script>
    const STORAGE_KEY = 'root-donate-drops-local';
    const COORD_PRECISION = 5;
    const MATCH_TOLERANCE = 0.0045;           // ~500 m
    const FILE_HANDLE_KEY = 'timelineFileHandle'; // in IndexedDB or localStorage fallback

    let userLat = null, userLng = null;
    let timelinePoints = [];

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Helpers
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function coordsMatch(aLat, aLng, bLat, bLng) {
      return Math.abs(aLat - bLat) <= MATCH_TOLERANCE && Math.abs(aLng - bLng) <= MATCH_TOLERANCE;
    }
    function roundCoord(n) { return Number(n.toFixed(COORD_PRECISION)); }

    function showStatus(text, cls = '') {
      const el = document.getElementById('status');
      el.textContent = text; el.className = cls;
      setTimeout(() => { el.textContent = ''; el.className = ''; }, 7000);
    }

    const locInfoEl = document.getElementById('locationInfo');
    function updateLocationInfo() {
      if (userLat == null || userLng == null) {
        locInfoEl.innerHTML = 'Waiting for GPS... (allow location access)';
        locInfoEl.style.color = '#777';
      } else {
        locInfoEl.innerHTML = `ğŸ“ ${userLat.toFixed(5)}, ${userLng.toFixed(5)} â€” ~500 m radius`;
        locInfoEl.style.color = '#0f5';
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Parse Timeline JSON (Google format 2025â€“2026)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function parseTimelineJson(json) {
      const points = [];
      if (json.semanticSegments) {
        json.semanticSegments.forEach(seg => {
          if (seg.timelinePath) {
            seg.timelinePath.forEach(p => {
              let lat, lng;
              if (typeof p.point === 'string') {
                const [latStr, lngStr] = p.point.split(',').map(s => s.trim());
                lat = parseFloat(latStr); lng = parseFloat(lngStr);
              } else if (p.latE7 && p.lngE7) {
                lat = p.latE7 / 1e7; lng = p.lngE7 / 1e7;
              } else if (p.point?.latE7 && p.point?.lngE7) {
                lat = p.point.latE7 / 1e7; lng = p.point.lngE7 / 1e7;
              }
              if (!isNaN(lat) && !isNaN(lng)) {
                points.push({
                  lat, lng,
                  timestamp: p.time || seg.startTime || seg.endTime || '',
                  accuracy: p.accuracyMeters || seg.accuracyMeters || '?',
                  type: 'history'
                });
              }
            });
          }
        });
      } else if (json.locations) { // old Takeout
        json.locations.forEach(loc => {
          if (loc.latitudeE7 && loc.longitudeE7) {
            points.push({
              lat: loc.latitudeE7 / 1e7,
              lng: loc.longitudeE7 / 1e7,
              timestamp: loc.timestampMs ? new Date(Number(loc.timestampMs)).toISOString() : '',
              accuracy: loc.accuracy || '?',
              type: 'history'
            });
          }
        });
      }
      points.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
      return points;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // LocalStorage drops
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getDrops() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; }
    }
    function saveDrops(drops) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(drops));
      window.dispatchEvent(new Event('storage'));
    }
    function addDrop(name, msg, lat, lng) {
      const drops = getDrops();
      drops.push({ name: name || 'Anonymous', msg: msg || '(no msg)', lat: roundCoord(lat), lng: roundCoord(lng), timestamp: new Date().toISOString(), type: 'drop' });
      saveDrops(drops);
    }
    function clearDropsNear(lat, lng) {
      const drops = getDrops().filter(d => !coordsMatch(d.lat, d.lng, lat, lng));
      saveDrops(drops);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Render pins
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAll() {
      const listEl = document.getElementById('pinList');
      if (userLat == null || userLng == null) {
        listEl.innerHTML = '<p style="text-align:center;color:#555;padding:20px;">Waiting for GPSâ€¦</p>';
        return;
      }
      const drops = getDrops().filter(d => coordsMatch(d.lat, d.lng, userLat, userLng));
      const hist  = timelinePoints.filter(p => coordsMatch(p.lat, p.lng, userLat, userLng));
      if (drops.length + hist.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#555;padding:20px;">Nothing nearby â€” drop something or load GPS history</p>';
        return;
      }
      listEl.innerHTML = '';
      const all = [...drops, ...hist];
      const groups = {};
      all.forEach(item => {
        const key = `${roundCoord(item.lat)},${roundCoord(item.lng)}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(item);
      });
      Object.entries(groups).forEach(([key, group]) => {
        const [lat, lng] = key.split(',').map(Number);
        const div = document.createElement('div');
        div.className = 'location-group';
        div.innerHTML = `<div class="location-header">ğŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)}  (${group.length})</div>`;
        group.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        group.forEach(item => {
          const pin = document.createElement('div');
          pin.className = 'pin';
          const header = item.type === 'drop' ? item.name : 'History';
          const msg   = item.type === 'drop' ? item.msg : `Â±${item.accuracy}m`;
          pin.innerHTML = `<div class="pin-header">${header}</div><div class="pin-msg">${msg}</div><div class="pin-time">${new Date(item.timestamp).toLocaleString()}</div>`;
          div.appendChild(pin);
        });
        listEl.appendChild(div);
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // File â†’ JSON â†’ points
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadFile(fileOrHandle) {
      let file;
      if (fileOrHandle.kind === 'file') { // FileSystemFileHandle
        try {
          file = await fileOrHandle.getFile();
        } catch (err) {
          showStatus("Permission denied or file gone", 'error');
          return false;
        }
      } else {
        file = fileOrHandle;
      }

      if (!file.name?.toLowerCase().endsWith('.json')) {
        showStatus("Please select a .json file", 'error');
        return false;
      }

      try {
        const text = await file.text();
        const json = JSON.parse(text);
        timelinePoints = parseTimelineJson(json);
        showStatus(`Loaded ${timelinePoints.length} GPS points âœ“`, 'success');
        renderAll();
        return true;
      } catch (err) {
        showStatus("Invalid JSON file", 'error');
        console.error(err);
        return false;
      }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Try to auto-reopen previous file (modern browsers)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function tryReloadPreviousFile() {
      if (!('showOpenFilePicker' in window)) {
        showStatus("Auto-reopen not supported in this browser", 'error');
        return;
      }

      try {
        const handle = await getPreviousFileHandle();
        if (handle) {
          const success = await loadFile(handle);
          if (success) {
            showStatus("Previous GPS history auto-loaded!", 'success');
          }
        } else {
          showStatus("No previous file found", '');
        }
      } catch (err) {
        if (err.name === 'NotAllowedError') {
          showStatus("Permission required â€” click 'Re-load previousâ€¦'", '');
        } else {
          console.error(err);
        }
      }
    }

    // Very simple localStorage based handle storage (not ideal, but works)
    async function saveFileHandle(handle) {
      try {
        const token = await handle.createSyncAccessHandle?.() || null; // dummy check
        localStorage.setItem(FILE_HANDLE_KEY, 'has-handle'); // we only remember we had one
        // Note: real handle storage needs IndexedDB + structured clone (more complex)
      } catch {}
    }

    async function getPreviousFileHandle() {
      // In real app you'd store handle in IndexedDB
      // Here we just show the picker again (user must confirm)
      const [handle] = await window.showOpenFilePicker({
        types: [{
          description: 'JSON Files',
          accept: { 'application/json': ['.json'] }
        }],
        multiple: false,
        excludeAcceptAllOption: true
      }).catch(() => []);
      if (handle) await saveFileHandle(handle);
      return handle || null;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Drag & drop + classic picker
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('click', () => document.getElementById('fileInput').click());

    ['dragover', 'dragenter'].forEach(ev => 
      dropZone.addEventListener(ev, e => { 
        e.preventDefault(); 
        dropZone.classList.add('dragover'); 
      })
    );
    ['dragleave', 'drop'].forEach(ev => 
      dropZone.addEventListener(ev, e => { 
        e.preventDefault(); 
        dropZone.classList.remove('dragover'); 
      })
    );

    dropZone.addEventListener('drop', e => {
      const file = e.dataTransfer?.files?.[0];
      if (file) loadFile(file);
    });

    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files?.[0];
      if (file) loadFile(file);
    });

    // Re-load button (asks permission again if needed)
    document.getElementById('reloadHistoryBtn').onclick = async () => {
      await tryReloadPreviousFile();
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Drop / Clear
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('dropBtn').onclick = () => {
      if (!userLat || !userLng) return showStatus('No GPS fix yet', 'error');
      const name = document.getElementById('name').value.trim();
      const msg = document.getElementById('msg').value.trim();
      if (!msg) return showStatus('Write something âš½', 'error');
      addDrop(name, msg, userLat, userLng);
      document.getElementById('msg').value = '';
      renderAll();
      showStatus('Dropped! Visible ~500 m', 'success');
    };

    document.getElementById('clearBtn').onclick = () => {
      if (!userLat || !userLng) return showStatus('No GPS', 'error');
      if (!confirm('Delete all drops in ~500 m?')) return;
      clearDropsNear(userLat, userLng);
      renderAll();
      showStatus('Drops cleared ğŸ—‘ï¸', 'success');
    };

    window.addEventListener('storage', renderAll);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // GPS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startWatching() {
      if (!navigator.geolocation) {
        showStatus('Geolocation not supported', 'error');
        return;
      }
      navigator.geolocation.watchPosition(
        pos => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          updateLocationInfo();
          renderAll();
        },
        err => showStatus('Location access denied', 'error'),
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 10000 }
      );
    }

    // Init
    startWatching();
    updateLocationInfo();
    renderAll();

    // Try to reload history automatically on page load (will prompt if needed)
    setTimeout(tryReloadPreviousFile, 1200);
  </script>
</body>
</html>