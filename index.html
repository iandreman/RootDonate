<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Root Drops ‚Ä¢ Local Echoes (~500 m) ‚Äî Timeless Pins</title>
  <meta name="description" content="Drop messages tied to your exact location. Visible only within ~500 m. Load GPS history to see your past footsteps."/>

  <style>
    :root {
      --bg: #000;
      --text: #e0e0e0;
      --accent: #00ff55;
      --accent-dark: #00cc44;
      --danger: #ff3333;
      --info: #1e90ff;
      --export: #ff6600;
      --surface: #111;
      --surface-alt: #1a1a1a;
      --border: #333;
    }

    * { box-sizing: border-box; margin:0; padding:0; }
    html, body { height:100%; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, sans-serif; line-height:1.5; }
    .container { max-width:640px; margin:0 auto; padding:1.5rem; }

    h1 {
      text-align:center; color:var(--accent); margin:1rem 0 1.5rem;
      font-size:1.8rem; letter-spacing:-0.02em; font-weight:700;
      text-shadow:0 0 20px rgba(0,255,85,0.15);
    }

    input, textarea {
      width:100%; padding:0.9rem 1rem; margin:0.6rem 0;
      background:#0d0d0d; border:1px solid var(--border); border-radius:12px;
      color:white; font-size:1rem; transition:border-color 0.2s;
    }
    input:focus, textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,255,85,0.12); }

    textarea { min-height:100px; resize:vertical; }

    .buttons {
      display:flex; flex-wrap:wrap; gap:0.8rem; justify-content:center;
      margin:1.2rem 0;
    }
    button {
      padding:0.85rem 1.8rem; border:none; border-radius:12px;
      font-weight:600; cursor:pointer; transition:all 0.22s ease;
      min-width:140px; font-size:0.95rem;
    }
    button:hover { transform:translateY(-1px); }
    #dropBtn   { background:var(--accent-dark); color:#000; }
    #dropBtn:hover   { background:var(--accent); }
    #clearBtn  { background:#991111; color:white; }
    #clearBtn:hover  { background:var(--danger); }
    #reloadHistoryBtn { background:var(--info); color:white; }
    #exportJsonBtn    { background:var(--export); color:white; }

    #status {
      text-align:center; min-height:1.3em; font-size:0.92rem; margin:0.8rem 0;
      opacity:0; transition:opacity 0.4s;
    }
    #status.visible { opacity:1; }
    .success { color:#0f5; }
    .error   { color:#f66; }

    .section-title {
      color:var(--accent); font-size:1.15rem; font-weight:600;
      text-align:center; margin:2rem 0 0.8rem;
      opacity:0.9;
    }

    #dropZone {
      border:2px dashed var(--accent); border-radius:16px;
      padding:3rem 1rem; text-align:center; margin:1.5rem 0;
      cursor:pointer; background:#0a0a0a; transition:all 0.25s;
    }
    #dropZone.dragover {
      background:#111; border-color:var(--accent-dark);
      box-shadow:0 0 25px rgba(0,255,85,0.08);
    }
    #dropZone p { color:#888; margin:0.5rem 0; }

    .info-box {
      background:#181818; padding:1rem 1.2rem; border-radius:12px;
      margin:1rem 0; font-size:0.95rem; line-height:1.45; border:1px solid #222;
    }

    .pin-list { margin-top:1.5rem; }
    .location-group { margin-bottom:2rem; }
    .location-header {
      background:var(--surface-alt); padding:0.8rem 1.1rem;
      border-radius:12px 12px 0 0; font-weight:600; color:var(--accent);
      border:1px solid var(--border); border-bottom:none;
    }
    .pin {
      background:var(--surface); border:1px solid var(--border); border-top:none;
      padding:1.1rem 1.3rem;
    }
    .pin:not(:last-child) { border-bottom:1px solid #1e1e1e; }
    .pin-header { font-weight:600; color:#88ffbb; margin-bottom:0.4rem; }
    .pin-msg { white-space:pre-wrap; line-height:1.45; margin:0.5rem 0; }
    .pin-time { font-size:0.82rem; color:#666; text-align:right; margin-top:0.5rem; }

    @media (max-width:500px) {
      .container { padding:1rem; }
      h1 { font-size:1.5rem; }
      button { min-width:120px; padding:0.8rem 1.4rem; }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Root Drops ‚Ä¢ Local Echoes (~500 m)</h1>

    <div class="info-box" id="locationInfo">Waiting for location‚Ä¶</div>

    <div class="section-title">Leave a Message (Visible ~500 m)</div>
    <input type="text" id="name" placeholder="Name / @handle" value="@iandreme" />
    <textarea id="msg" placeholder="Your shout, memory, warning‚Ä¶"></textarea>

    <div class="buttons">
      <button id="dropBtn">Drop Message</button>
      <button id="clearBtn">Clear Drops (~500 m)</button>
    </div>

    <div class="section-title">Load Your Footprints (Timeline.json)</div>
    <div id="dropZone">
      <p>Drag & drop Timeline.json here<br>or tap to choose file</p>
      <input type="file" id="fileInput" accept=".json" hidden>
    </div>

    <div class="buttons" style="margin-top:0.4rem;">
      <button id="reloadHistoryBtn">‚Üª Reopen Previous Timeline</button>
      <button id="exportJsonBtn">‚Üì Export Nearby Echoes (JSON)</button>
    </div>

    <div id="status"></div>

    <div class="section-title">Nearby Echoes & Footprints (~500 m)</div>
    <div class="pin-list" id="pinList"></div>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Config
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const STORAGE_KEY       = 'root-donate-drops-v2';
    const COORD_PRECISION   = 6;
    const MATCH_TOLERANCE   = 0.0045; // ‚âà500 m at equator (conservative)

    const DB_NAME    = 'RootEchoDB';
    const STORE_NAME = 'files';
    const HANDLE_KEY = 'lastTimelineHandle';

    let userLat = null, userLng = null;
    let timelinePoints = [];
    let db = null;

    // ‚îÄ‚îÄ‚îÄ IndexedDB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function openDB() {
      if (db) return db;
      return new Promise((res, rej) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME);
        req.onsuccess = e => { db = e.target.result; res(db); };
        req.onerror = e => rej(e.target.error);
      });
    }

    async function saveHandle(handle) {
      const d = await openDB();
      const tx = d.transaction(STORE_NAME, 'readwrite');
      await tx.objectStore(STORE_NAME).put(handle, HANDLE_KEY);
      await tx.done;
    }

    async function getSavedHandle() {
      try {
        const d = await openDB();
        const tx = d.transaction(STORE_NAME, 'readonly');
        return await tx.objectStore(STORE_NAME).get(HANDLE_KEY);
      } catch { return null; }
    }

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const round = n => Number(n.toFixed(COORD_PRECISION));
    const coordsMatch = (a,b,c,d) => Math.abs(a-c) <= MATCH_TOLERANCE && Math.abs(b-d) <= MATCH_TOLERANCE;

    function showStatus(msg, type = '') {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = type ? `visible ${type}` : 'visible';
      setTimeout(() => el.className = '', 7000);
    }

    function updateLocInfo() {
      const el = document.getElementById('locationInfo');
      if (userLat == null) {
        el.textContent = 'Waiting for location‚Ä¶ (allow access)';
        el.style.color = '#777';
      } else {
        el.innerHTML = `üìç ${userLat.toFixed(6)}, ${userLng.toFixed(6)} <small>(~500 m radius)</small>`;
        el.style.color = 'var(--accent)';
      }
    }

    // ‚îÄ‚îÄ‚îÄ Parse Google Timeline JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function parseTimeline(json) {
      const pts = [];
      if (json?.semanticSegments) {
        json.semanticSegments.forEach(s => {
          s.timelinePath?.forEach(p => {
            let lat, lng;
            if (p.latE7 && p.lngE7) {
              lat = p.latE7 / 1e7; lng = p.lngE7 / 1e7;
            } else if (typeof p.point === 'string') {
              [lat, lng] = p.point.split(',').map(Number);
            }
            if (lat && lng) {
              pts.push({
                type: 'history',
                lat, lng,
                timestamp: p.time || s.startTime || s.endTime || '',
                accuracy: p.accuracyMeters || s.accuracyMeters || '?'
              });
            }
          });
        });
      } else if (json?.locations) {
        json.locations.forEach(l => {
          if (l.latitudeE7 && l.longitudeE7) {
            pts.push({
              type: 'history',
              lat: l.latitudeE7 / 1e7,
              lng: l.longitudeE7 / 1e7,
              timestamp: l.timestampMs ? new Date(+l.timestampMs).toISOString() : '',
              accuracy: l.accuracy || '?'
            });
          }
        });
      }
      pts.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
      return pts;
    }

    // ‚îÄ‚îÄ‚îÄ File Loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadFile(src) {
      let file;
      try {
        file = src.kind === 'file' ? await src.getFile() : src;
      } catch {
        showStatus('File access denied', 'error');
        return false;
      }

      if (!file.name?.toLowerCase().endsWith('.json')) {
        showStatus('Please select a .json file', 'error');
        return false;
      }

      try {
        const text = await file.text();
        const data = JSON.parse(text);
        timelinePoints = parseTimeline(data);
        showStatus(`Loaded ${timelinePoints.length} history points`, 'success');
        renderAll();
        return true;
      } catch (err) {
        showStatus('Invalid or corrupted JSON', 'error');
        console.error(err);
        return false;
      }
    }

    async function tryReopen() {
      if (!('showOpenFilePicker' in window)) return false;

      let handle = await getSavedHandle();
      if (handle) {
        if (await loadFile(handle)) {
          showStatus('Re-opened previous timeline', 'success');
          return true;
        }
      }

      try {
        [handle] = await window.showOpenFilePicker({
          types: [{ description:'JSON', accept:{'application/json':['.json']} }],
          multiple: false
        });
        if (await loadFile(handle)) {
          await saveHandle(handle);
          return true;
        }
      } catch (e) {
        if (e.name !== 'AbortError') showStatus('File picker cancelled', '');
      }
      return false;
    }

    // ‚îÄ‚îÄ‚îÄ Drop / Clear ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function getDrops() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
      catch { return []; }
    }

    function saveDrops(drops) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(drops));
      window.dispatchEvent(new Event('storage'));
    }

    function addDrop(name, msg, lat, lng) {
      const drops = getDrops();
      drops.push({
        type: 'drop',
        name: name.trim() || 'Anonymous',
        msg: msg.trim() || '(empty)',
        lat: round(lat),
        lng: round(lng),
        timestamp: new Date().toISOString()
      });
      saveDrops(drops);
    }

    function clearNearby(lat, lng) {
      const kept = getDrops().filter(d => !coordsMatch(d.lat, d.lng, lat, lng));
      saveDrops(kept);
    }

    // ‚îÄ‚îÄ‚îÄ Export JSON ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function exportJson() {
      if (!userLat) return showStatus('No location yet', 'error');

      const drops = getDrops().filter(d => coordsMatch(d.lat, d.lng, userLat, userLng));
      const hist  = timelinePoints.filter(p => coordsMatch(p.lat, p.lng, userLat, userLng));
      const all   = [...drops, ...hist];

      if (!all.length) return showStatus('Nothing nearby to export', 'error');

      const data = {
        metadata: {
          exported: new Date().toISOString(),
          center: { lat: round(userLat), lng: round(userLng), radius_m: 500 },
          counts: { total: all.length, drops: drops.length, history: hist.length }
        },
        pins: all.map(p => {
          const base = {
            type: p.type,
            lat: round(p.lat),
            lng: round(p.lng),
            timestamp: p.timestamp || null
          };
          if (p.type === 'drop') {
            base.name = p.name;
            base.message = p.msg;
          } else {
            base.accuracy_m = p.accuracy !== '?' ? Number(p.accuracy) : null;
          }
          return base;
        }).sort((a,b) => new Date(b.timestamp||0) - new Date(a.timestamp||0))
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `root-echo_${new Date().toISOString().slice(0,10)}_500m.json`;
      a.click();
      URL.revokeObjectURL(url);

      showStatus(`Exported ${all.length} echoes`, 'success');
    }

    // ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderAll() {
      const list = document.getElementById('pinList');
      if (!userLat) {
        list.innerHTML = '<p style="text-align:center;color:#555;padding:2rem;">Waiting for location‚Ä¶</p>';
        return;
      }

      const drops = getDrops().filter(d => coordsMatch(d.lat, d.lng, userLat, userLng));
      const hist  = timelinePoints.filter(p => coordsMatch(p.lat, p.lng, userLat, userLng));

      if (!drops.length && !hist.length) {
        list.innerHTML = '<p style="text-align:center;color:#555;padding:2rem;">No echoes nearby yet</p>';
        return;
      }

      list.innerHTML = '';
      const groups = {};
      [...drops, ...hist].forEach(p => {
        const k = `${round(p.lat)},${round(p.lng)}`;
        groups[k] = groups[k] || [];
        groups[k].push(p);
      });

      Object.entries(groups).forEach(([k, items]) => {
        const [lat, lng] = k.split(',').map(Number);
        const group = document.createElement('div');
        group.className = 'location-group';
        group.innerHTML = `<div class="location-header">üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}  (${items.length})</div>`;

        items.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(p => {
          const pin = document.createElement('div');
          pin.className = 'pin';
          const isDrop = p.type === 'drop';
          pin.innerHTML = `
            <div class="pin-header">${isDrop ? p.name : 'Footprint'}</div>
            <div class="pin-msg">${isDrop ? p.msg : `Accuracy ‚âà${p.accuracy}m`}</div>
            <div class="pin-time">${new Date(p.timestamp).toLocaleString([], {dateStyle:'medium', timeStyle:'short'})}</div>
          `;
          group.appendChild(pin);
        });

        list.appendChild(group);
      });
    }

    // ‚îÄ‚îÄ‚îÄ Event Listeners ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('dropBtn').onclick = () => {
      if (!userLat) return showStatus('Waiting for GPS‚Ä¶', 'error');
      const name = document.getElementById('name').value.trim();
      const msg  = document.getElementById('msg').value.trim();
      if (!msg) return showStatus('Message required', 'error');
      addDrop(name, msg, userLat, userLng);
      document.getElementById('msg').value = '';
      renderAll();
      showStatus('Dropped ‚Äî visible ~500 m', 'success');
    };

    document.getElementById('clearBtn').onclick = () => {
      if (!userLat) return showStatus('No location fix', 'error');
      if (!confirm('Erase all drops in this ~500 m area?')) return;
      clearNearby(userLat, userLng);
      renderAll();
      showStatus('Area cleared', 'success');
    };

    document.getElementById('exportJsonBtn').onclick = exportJson;

    // File drop / click
    const zone = document.getElementById('dropZone');
    zone.onclick = () => document.getElementById('fileInput').click();
    zone.ondragover = zone.ondragenter = e => { e.preventDefault(); zone.classList.add('dragover'); };
    zone.ondragleave = zone.ondrop = e => { e.preventDefault(); zone.classList.remove('dragover'); };
    zone.ondrop = e => { const f = e.dataTransfer?.files?.[0]; if (f) loadFile(f); };
    document.getElementById('fileInput').onchange = e => { const f = e.target.files?.[0]; if (f) loadFile(f); };

    document.getElementById('reloadHistoryBtn').onclick = tryReopen;

    window.addEventListener('storage', renderAll);

    // GPS
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        pos => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          updateLocInfo();
          renderAll();
        },
        () => showStatus('Location permission denied', 'error'),
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 4000 }
      );
    } else {
      showStatus('Geolocation not available', 'error');
    }

    // Init
    updateLocInfo();
    renderAll();
    setTimeout(tryReopen, 800);
  </script>
</body>
</html>