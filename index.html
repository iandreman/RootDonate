<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RootDonate • We Are All Here</title>
  <meta name="description" content="A quiet work of art about being human on the same internet." />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{--blue:#0a84ff;--green:#30d158;--orange:#ff9f0a;}
    *{box-sizing:border-box;}
    body,html{margin:0;padding:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:-apple-system,system-ui,sans-serif;}
    #map{width:100%;height:100%;background:#000;filter:brightness(0.92) contrast(1.12);}
    .header{position:absolute;top:0;left:0;right:0;padding:3rem 2rem 2rem;text-align:center;z-index:1000;background:linear-gradient(180deg,rgba(0,0,0,0.9),transparent);backdrop-filter:blur(30px);pointer-events:none;}
    h1{margin:0;font-size:4.5rem;font-weight:900;letter-spacing:-2.5px;background:linear-gradient(90deg,var(--blue),var(--green),var(--orange));-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 50px rgba(10,132,255,0.4);}
    .poem{margin-top:1.8rem;font-size:1.55rem;font-weight:300;opacity:0.9;line-height:1.7;letter-spacing:0.6px;}
    footer{position:absolute;bottom:0;left:0;right:0;padding:1.2rem;text-align:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(20px);font-size:0.92rem;opacity:0.75;z-index:1000;}
    
    .user-marker, .other-marker{
      background:var(--blue);border:3px solid #fff;border-radius:50%;width:18px;height:18px;
      box-shadow:0 0 25px #0a84ff;animation:pulse 2.2s infinite;
    }
    .other-marker{background:var(--green);box-shadow:0 0 25px #30d158;animation:pulse 3s infinite;}
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(10,132,255,0.8);}
      70%{box-shadow:0 0 0 22px rgba(10,132,255,0);}
      100%{box-shadow:0 0 0 0 rgba(10,132,255,0);}
    }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="header">
    <h1>RootDonate</h1>
    <div class="poem">
      We are all here • together<br>
      One planet • one quiet network<br>
      Breathing the same invisible light
    </div>
  </div>

  <footer>
    <span id="counter">Thousands of humans breathing with you right now</span> • 2025 • Forever free
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←
    //  PUT YOUR SUPABASE KEYS HERE
    const SUPABASE_URL = 'https://ekdiarbztipvogxversx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrZGlhcmJ6dGlwdm9neHZlcnN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNTk1MzgsImV4cCI6MjA4MDczNTUzOH0.dxIG7ABT8YqNe2mnbfNcgqf3cUTE3l4YdFpSiidHk4I';
    // ←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←←

    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const map = L.map('map', {
      zoomControl: false,
      minZoom: 2.5,
      maxZoom: 18,
      worldCopyJump: true
    }).setView([20, 0], 2.8);

    L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
      attribution: '',
      maxZoom: 20
    }).addTo(map);

    const userIcon = L.divIcon({className:'user-marker', iconSize:[18,18]});
    const otherIcon = L.divIcon({className:'other-marker', iconSize:[15,15]});

    let userMarker = null;
    const othersLayer = L.layerGroup().addTo(map);

    // Update live counter
    async function updateCounter() {
      const { count } = await supabase.from('visitors').select('*', { count: 'exact', head: true })
        .gte('created_at', new Date(Date.now() - 24*60*60*1000).toISOString()); // last 24h
      document.getElementById('counter').textContent = 
        count ? `${count.toLocaleString()}+ humans breathing with you right now` : 'You are the first today';
    }

    // Show current user
    function showUser(lat, lon, popup = 'You are here • right now') {
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat, lon], {icon: userIcon}).addTo(map)
        .bindPopup(popup, {closeButton:false, autoClose:false}).openPopup();
      map.setView([lat, lon], 5, {animate:true, duration:2.5});
    }

    // Add or update another visitor
    function addOtherVisitor({lat, lng, city, country}) {
      const key = `${lat.toFixed(4)},${lng.toFixed(4)}`;
      if (othersLayer._keyedLayers?.[key]) return; // avoid duplicates

      const text = city ? `${city}, ${country}` : 'Somewhere on Earth';
      L.marker([lat, lng], {icon: otherIcon})
        .addTo(othersLayer)
        .bindPopup(text, {closeButton:false, autoClose:false});
    }

    // Load all recent visitors
    async function loadAllVisitors() {
      const { data } = await supabase
        .from('visitors')
        .select('lat,lng,city,country')
        .gte('created_at', new Date(Date.now() - 24*60*60*1000).toISOString());
      
      othersLayer.clearLayers();
      data?.forEach(addOtherVisitor);
      updateCounter();
    }

    // Push current user to the shared table
    async function pushMyLocation(lat, lon, city = '', country = '') {
      await supabase.from('visitors').insert({
        lat, lng: lon, city, country
      });
      loadAllVisitors(); // refresh everyone
    }

    // ——— Geolocation ———
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const {latitude, longitude} = pos.coords;
          showUser(latitude, longitude);
          pushMyLocation(latitude, longitude);
        },
        () => fallbackIP(),
        {timeout:12000, maximumAge:300000, enableHighAccuracy:true}
      );
    } else {
      fallbackIP();
    }

    function fallbackIP() {
      fetch('https://ipapi.co/json/')
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(d => {
          const lat = d.latitude, lon = d.longitude;
          const city = d.city || '';
          const country = d.country_name || 'Earth';
          showUser(lat, lon, `You are here • ${city}, ${country}`);
          pushMyLocation(lat, lon, city, country);
        })
        .catch(() => map.setView([20,0], 2.8));
    }

    // Real-time listener — new dots appear instantly
    supabase.channel('visitors')
      .on('postgres_changes', {event:'INSERT', schema:'public', table:'visitors'}, payload => {
        addOtherVisitor(payload.new);
        updateCounter();
      })
      .subscribe();

    // Initial load
    loadAllVisitors();
    setInterval(loadAllVisitors, 5*60*1000); // refresh every 5 min just in case
  </script>
</body>
</html>