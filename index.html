<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Root Donate Drops ‚Ä¢ Real-Time #MUFC</title>

  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#eee; font-family:Arial,Helvetica,sans-serif; }
    .container { max-width:580px; margin:0 auto; padding:20px; }
    h1 { text-align:center; color:#00ff55; margin:10px 0 16px; }
    input, textarea { width:100%; padding:12px; margin:10px 0; border:1px solid #444; border-radius:8px; background:#111; color:white; font-size:1em; box-sizing:border-box; }
    textarea { resize:vertical; min-height:100px; }
    .buttons { text-align:center; margin:20px 0; display:flex; flex-wrap:wrap; justify-content:center; gap:12px; }
    button { padding:13px 24px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; transition:all 0.2s; min-width:140px; }
    #dropBtn   { background:#00cc44; color:black; }
    #dropBtn:hover   { background:#00ff55; }
    #clearBtn  { background:#cc0000; color:white; }
    #clearBtn:hover  { background:#ff3333; }
    #status { text-align:center; margin:12px 0; min-height:1.4em; font-size:0.95em; }
    .success { color:#0f5; }
    .error   { color:#f66; }
    .pin-list { margin-top:16px; }
    .location-group { margin-bottom:28px; }
    .location-header { 
      background:#1a1a1a; 
      padding:10px 14px; 
      border-radius:8px 8px 0 0; 
      font-weight:bold; 
      color:#0f5; 
      border:1px solid #333; 
      border-bottom:none; 
      font-size:1.05em; 
    }
    .pin { 
      background:#111; 
      border:1px solid #333; 
      border-top:none; 
      padding:14px 16px; 
      margin:0; 
    }
    .pin:not(:last-child) { border-bottom:1px solid #222; }
    .pin-header { font-weight:bold; color:#55ff99; margin-bottom:6px; }
    .pin-msg { margin:8px 0 10px; white-space:pre-wrap; line-height:1.4; }
    .pin-time { font-size:0.82em; color:#777; text-align:right; margin-top:6px; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Root Donate Drops ‚öΩ #MUFC (Real-Time)</h1>

    <input type="text" id="name" placeholder="Name / @handle" value="@iandreme" />
    <textarea id="msg" placeholder="Your message / donation note / shoutout..."></textarea>
    
    <div class="buttons">
      <button id="dropBtn">Drop Message</button>
      <button id="clearBtn">Clear All (Local Only)</button>
    </div>
    
    <div id="status"></div>

    <div class="pin-list" id="pinList"></div>
  </div>

  <script>
    // ‚îÄ‚îÄ‚îÄ Supabase Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SUPABASE_URL  = 'https://ekdiarbztipvogxversx.supabase.co';
    const SUPABASE_ANON = 'sb_publishable_b_PuReasRGPXbHcbmY8xTA_6CoxfEgH';  // ‚Üê Replace with your real anon key

    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ‚îÄ‚îÄ‚îÄ IndexedDB (local fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const DB_NAME = 'RootDonateDropsDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'drops';
    let db;

    function openDB() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => reject(req.error);
        req.onsuccess = () => { db = req.result; resolve(); };
        req.onupgradeneeded = e => {
          const store = e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
          store.createIndex('gps', ['lat', 'lng']);
          store.createIndex('timestamp', 'timestamp');
        };
      });
    }

    async function addLocalDrop(drop) {
      const tx = db.transaction(STORE_NAME, 'readwrite');
      await tx.objectStore(STORE_NAME).add(drop);
      return new Promise(r => tx.oncomplete = r);
    }

    async function getLocalDrops() {
      const tx = db.transaction(STORE_NAME, 'readonly');
      const drops = await tx.objectStore(STORE_NAME).getAll();
      return drops;
    }

    function roundCoord(n) { return Number(n.toFixed(6)); }

    // ‚îÄ‚îÄ‚îÄ Real-time local sync across tabs (Broadcast Channel) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const channel = new BroadcastChannel('root-donate-drops-local');

    channel.onmessage = async (event) => {
      if (event.data === 'local-updated') {
        await renderDrops();
        showStatus('Local drop updated from another tab ‚ö°', 'success');
      }
    };

    function broadcastLocalUpdate() {
      channel.postMessage('local-updated');
    }

    // ‚îÄ‚îÄ‚îÄ Render (shared + local) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function renderDrops() {
      const listEl = document.getElementById('pinList');
      listEl.innerHTML = '<p style="text-align:center;color:#555;padding:20px;">Loading drops...</p>';

      try {
        let { data: sharedDrops, error } = await supabase
          .from('drops')
          .select('*')
          .order('timestamp', { ascending: false });

        if (error) throw error;

        const local = await getLocalDrops();
        const allDrops = [...(sharedDrops || []), ...local.filter(l => !sharedDrops?.some(s => s.timestamp === l.timestamp))];

        listEl.innerHTML = allDrops.length === 0 
          ? '<p style="text-align:center;color:#555;padding:20px;">No drops yet ‚Äî be the first! ‚öΩ</p>'
          : '';

        const groups = {};
        allDrops.forEach(d => {
          const key = `${d.lat},${d.lng}`;
          groups[key] = groups[key] || [];
          groups[key].push(d);
        });

        const sortedGroups = Object.entries(groups)
          .sort(([,a], [,b]) => Math.max(...b.map(d=> new Date(d.timestamp))) - Math.max(...a.map(d=> new Date(d.timestamp))));

        sortedGroups.forEach(([key, group]) => {
          const [lat, lng] = key.split(',').map(Number);
          const groupDiv = document.createElement('div');
          groupDiv.className = 'location-group';

          groupDiv.innerHTML = `
            <div class="location-header">üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
          `;

          group.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

          group.forEach(drop => {
            const pin = document.createElement('div');
            pin.className = 'pin';
            pin.innerHTML = `
              <div class="pin-header">${drop.name || 'Anonymous'}</div>
              <div class="pin-msg">${drop.msg || '(no message)'}</div>
              <div class="pin-time">${new Date(drop.timestamp).toLocaleString()}</div>
            `;
            groupDiv.appendChild(pin);
          });

          listEl.appendChild(groupDiv);
        });

      } catch (err) {
        console.error(err);
        listEl.innerHTML = '<p style="text-align:center;color:#f66;">Error loading drops ‚Äî check connection</p>';
      }
    }

    // ‚îÄ‚îÄ‚îÄ UI Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const statusEl = document.getElementById('status');
    function showStatus(text, cls='') {
      statusEl.textContent = text;
      statusEl.className = cls;
      setTimeout(() => { statusEl.textContent = ''; statusEl.className = ''; }, 5000);
    }

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (async () => {
      try {
        await openDB();
        await renderDrops();
        broadcastLocalUpdate();  // Let other tabs know we loaded (optional but nice)

        // Real-time Supabase subscription
        supabase
          .channel('drops-channel')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'drops' }, payload => {
            renderDrops();
            showStatus('New drop received! ‚öΩ', 'success');
          })
          .subscribe();

      } catch (err) {
        showStatus('Failed to connect ‚Äî check Supabase config', 'error');
      }
    })();

    // ‚îÄ‚îÄ‚îÄ Location ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let userLat = 53.4631, userLng = -2.2913;
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => { 
          userLat = pos.coords.latitude; 
          userLng = pos.coords.longitude; 
          showStatus('Location acquired!', 'success'); 
        },
        () => showStatus('Location access denied ‚Äî using Old Trafford fallback', 'error')
      );
    }

    // ‚îÄ‚îÄ‚îÄ Drop Message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('dropBtn').addEventListener('click', async () => {
      const name = document.getElementById('name').value.trim() || 'Anonymous';
      const msg  = document.getElementById('msg').value.trim();

      if (!msg) return showStatus('Please write a message first ‚öΩ', 'error');

      const lat = roundCoord(userLat);
      const lng = roundCoord(userLng);
      const timestamp = new Date().toISOString();

      const drop = { name, msg, lat, lng, timestamp };

      try {
        const { error } = await supabase.from('drops').insert([drop]);
        if (error) throw error;

        await addLocalDrop({ ...drop, id: Date.now() });
        broadcastLocalUpdate();  // Notify other tabs instantly

        document.getElementById('msg').value = '';
        await renderDrops();
        showStatus('Message dropped live! ‚öΩ', 'success');
      } catch (err) {
        console.error(err);
        showStatus('Failed to drop message ‚Äî try again', 'error');
      }
    });

    // ‚îÄ‚îÄ‚îÄ Clear Local Only ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('clearBtn').addEventListener('click', async () => {
      if (!confirm('Clear local drops only? (Server drops stay)')) return;
      const tx = db.transaction(STORE_NAME, 'readwrite');
      tx.objectStore(STORE_NAME).clear();
      await new Promise(r => tx.oncomplete = r);
      broadcastLocalUpdate();  // Notify other tabs
      await renderDrops();
      showStatus('Local drops cleared', 'success');
    });
  </script>
</body>
</html>