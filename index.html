<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS Pins • 2026</title>
  <meta name="description" content="Private GPS pins with notes & comments + retro terminal AI chat. 100% local." />

  <style>
    :root {
      --bg:        #0a0e1a;
      --surface:   #141822;
      --text:      #e0e7ff;
      --muted:     #8899aa;
      --accent:    #00d4ff;
      --accent-dim:#00ff9d;
      --purple:    #bb86fc;
      --danger:    #ff5555;
      --border:    rgba(0,212,255,0.16);
      --shadow:    0 4px 16px rgba(0,0,0,0.35);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', Courier, monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem 1.4rem;
      background: rgba(0,0,0,0.55);
      border-bottom: 1px solid var(--border);
      text-align: center;
    }
    h1 {
      font-size: 2rem;
      background: linear-gradient(90deg, var(--purple), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin: 0;
    }
    .subtitle { color: var(--muted); font-size: 0.9rem; margin-top: 0.4rem; }
    .tabs {
      margin: 0.8rem 0 0.4rem;
      display: flex;
      justify-content: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 0.5rem 1.2rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      cursor: pointer;
      font-weight: bold;
      transition: all 0.16s;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--purple), var(--accent));
      color: #000;
      border-color: transparent;
    }
    .tab-content {
      flex: 1;
      display: none;
      overflow: hidden;
      flex-direction: column;
    }
    .tab-content.active { display: flex; }

    /* Terminal */
    #terminal-tab .terminal {
      flex: 1;
      padding: 1rem 1.4rem;
      overflow-y: auto;
      line-height: 1.48;
      font-size: 0.95rem;
    }
    .line { margin: 0.32rem 0; white-space: pre-wrap; word-break: break-word; }
    .prompt    { color: var(--accent-dim); }
    .ai        { color: #00ffea; }
    .system    { color: #778899; }
    .error     { color: var(--danger); }
    .input-line {
      display: flex;
      align-items: flex-start;
      padding: 0.6rem 1.4rem;
      background: rgba(0,0,0,0.3);
      border-top: 1px solid var(--border);
    }
    .input-line .prompt { margin-right: 0.7rem; flex-shrink: 0; }
    #input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--accent);
      font: inherit;
      outline: none;
      caret-color: var(--accent);
    }
    .cursor {
      display: inline-block;
      width: 8px;
      height: 1.1em;
      background: var(--accent);
      animation: blink 1.05s step-end infinite;
      margin-left: 4px;
    }
    @keyframes blink { 50% { opacity: 0; } }

    /* Pins tab */
    #pins-tab {
      padding: 1.2rem;
      overflow-y: auto;
    }
    .card {
      background: rgba(20,24,34,0.94);
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 1.3rem;
      margin: 1rem 0;
      box-shadow: var(--shadow);
    }
    .pin-title { color: var(--accent); font-size: 1.3rem; margin-bottom: 0.5rem; }
    .meta { color: var(--muted); font-size: 0.9rem; margin: 0.6rem 0; }
    .note { margin: 1rem 0; white-space: pre-wrap; }
    .comments {
      margin-top: 1.2rem;
      border-top: 1px solid var(--border);
      padding-top: 1rem;
    }
    .comment {
      margin: 0.8rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--accent-dim);
    }
    #search {
      width: 100%;
      max-width: 420px;
      padding: 0.7rem;
      margin: 0 auto 1.2rem;
      display: block;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: inherit;
    }
    .share-row {
      margin-top: 1.2rem;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.8rem;
    }
    .copy-btn {
      padding: 0.45rem 1rem;
      background: rgba(0,212,255,0.15);
      border: 1px solid var(--accent-dim);
      border-radius: 6px;
      color: var(--accent);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.18s;
    }
    .copy-btn:hover {
      background: rgba(0,212,255,0.3);
    }
    .copy-btn.copied {
      background: rgba(0,255,157,0.25);
      color: #00ff9d;
      border-color: #00ff9d;
    }
    .hidden { display: none !important; }

    @media (max-width: 560px) {
      header { padding: 0.8rem; }
      .tabs { flex-direction: column; }
      .tab-btn { width: 100%; margin: 0.3rem 0; }
      .share-row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<header>
  <h1>GPS Pins</h1>
  <div class="subtitle">private locations • threaded comments • local terminal AI</div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="terminal">Terminal</button>
    <button class="tab-btn" data-tab="pins">My Pins</button>
  </div>
</header>

<!-- Terminal Tab -->
<div id="terminal-tab" class="tab-content active">
  <div class="terminal" id="terminal"></div>

  <div class="input-line">
    <span class="prompt">></span>
    <input id="input" type="text" autocomplete="off" spellcheck="false" autofocus>
    <span class="cursor"></span>
  </div>
</div>

<!-- Pins Tab -->
<div id="pins-tab" class="tab-content">
  <input type="text" id="search" placeholder="Search pins (name, note, comment…)">
  <div id="pins-container"></div>
</div>

<script>
// ────────────────────────────────────────────────
// Shared
// ────────────────────────────────────────────────
const STORAGE_KEY = 'gps-pins-v3';

function escapeHTML(str = '') {
  const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
  return str.replace(/[&<>"']/g, m => map[m]);
}

function getPins() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch { return []; }
}

function savePins(pins) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
}

function getPinShareUrl(pin) {
  return `${location.origin}${location.pathname}#p=${btoa(JSON.stringify(pin))}`;
}

// ────────────────────────────────────────────────
// Terminal
// ────────────────────────────────────────────────
const terminal = document.getElementById('terminal');
const inputEl  = document.getElementById('input');

let shortMemory = [];

function println(txt, cls = 'line') {
  const div = document.createElement('div');
  div.className = cls;
  div.innerHTML = txt;  // allow HTML for buttons if needed later
  terminal.appendChild(div);
  terminal.scrollTop = terminal.scrollHeight;
}

function printAI(txt) { println(txt, 'line ai'); }
function printError(txt) { println(txt, 'line error'); }
function clearScreen() { terminal.innerHTML = ''; }

async function createPinFromPrompts() {
  const name = prompt("Pin name (optional):")?.trim() || 'Anonymous';
  const msg  = prompt("Note / description:")?.trim() || '';
  const comm = prompt("First comment (optional):")?.trim() || '';

  if (!navigator.geolocation) {
    printError("Geolocation not supported.");
    return;
  }

  try {
    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 14000 })
    );

    const lat = Number(pos.coords.latitude.toFixed(6));
    const lng = Number(pos.coords.longitude.toFixed(6));

    const pin = {
      id: crypto.randomUUID(),
      lat, lng, name, msg,
      time: new Date().toISOString(),
      comments: comm ? [{ text: comm, author: name, time: new Date().toISOString() }] : []
    };

    const pins = getPins();
    pins.push(pin);
    savePins(pins);

    const shareUrl = getPinShareUrl(pin);

    printAI(`Pin created: ${escapeHTML(name)}`);
    println(`→ <a href="${shareUrl}" style="color:var(--accent);">${shareUrl}</a>`, 'line ai');
    println(`(open link or copy from Pins tab)`);
  } catch (err) {
    let m = "Couldn't get location.";
    if (err.code === 1) m += " Permission denied.";
    if (err.code === 3) m += " Timed out.";
    printError(m);
  }
}

function generateResponse(text) {
  const lower = text.toLowerCase().trim();

  if (["clear", "cls"].includes(lower)) { clearScreen(); return null; }
  if (lower === "help") {
    return [
      "Commands:",
      "  new pin / drop pin     → create pin",
      "  list pins              → show count",
      "  clear / cls            → clear terminal",
      "  help                   → this list",
      "Use 'My Pins' tab to browse, search, copy & share links"
    ].join('\n');
  }

  if (["new pin","drop pin","create pin"].some(w => lower.includes(w))) {
    createPinFromPrompts();
    return null;
  }

  if (["list pins","pins","my pins"].some(w => lower.includes(w))) {
    const count = getPins().length;
    return `You have ${count} pin${count===1?'':'s'}.\nGo to 'My Pins' tab to view & share them.`;
  }

  if (lower.includes("pin") || lower.includes("location")) {
    return "Want to save a spot? Type 'new pin'";
  }

  return ["hmm… tell me more?", "interesting…", "go on", "vibe check passed"][Math.floor(Math.random()*4)];
}

inputEl.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  e.preventDefault();
  const text = inputEl.value.trim();
  if (!text) return;

  println('> ' + escapeHTML(text), 'line prompt');

  const reply = generateResponse(text);
  if (reply) printAI(reply);

  inputEl.value = '';
  inputEl.focus();
});

// ────────────────────────────────────────────────
// Pins Tab + Copy functionality
// ────────────────────────────────────────────────
function copyToClipboard(text, button) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => {
      button.textContent = 'Copied!';
      button.classList.add('copied');
      setTimeout(() => {
        button.textContent = 'Copy URL';
        button.classList.remove('copied');
      }, 2000);
    }).catch(() => fallbackCopy());
  } else {
    fallbackCopy();
  }

  function fallbackCopy() {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    try {
      document.execCommand('copy');
      button.textContent = 'Copied (fallback)';
      button.classList.add('copied');
      setTimeout(() => {
        button.textContent = 'Copy URL';
        button.classList.remove('copied');
      }, 2000);
    } catch (err) {
      button.textContent = 'Copy failed';
      setTimeout(() => { button.textContent = 'Copy URL'; }, 2000);
    }
    document.body.removeChild(textarea);
  }
}

function renderPins(pinsToShow = getPins()) {
  const container = document.getElementById('pins-container');
  container.innerHTML = pinsToShow.length === 0
    ? '<p style="color:var(--muted); text-align:center; margin:4rem 0;">No pins yet. Create one in Terminal tab.</p>'
    : pinsToShow.map(pin => `
        <div class="card">
          <div class="pin-title">${escapeHTML(pin.name || 'Anonymous')}</div>
          <div class="meta">${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)} • ${new Date(pin.time).toLocaleString()}</div>
          ${pin.msg ? `<div class="note">${escapeHTML(pin.msg)}</div>` : ''}
          ${pin.comments.length ? `
            <div class="comments">
              <strong>Comments (${pin.comments.length})</strong>
              ${pin.comments.map(c => `
                <div class="comment">
                  ${escapeHTML(c.text)}<br>
                  <small style="color:var(--muted);">— ${escapeHTML(c.author || 'anon')}, ${new Date(c.time).toLocaleString()}</small>
                </div>
              `).join('')}
            </div>
          ` : ''}
          <div class="share-row">
            <button class="copy-btn" data-url="${getPinShareUrl(pin)}">Copy URL</button>
            <small style="color:var(--muted); opacity:0.8; word-break:break-all;">
              ${getPinShareUrl(pin)}
            </small>
          </div>
        </div>
      `).join('');

  // Attach copy listeners
  container.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const url = btn.getAttribute('data-url');
      copyToClipboard(url, btn);
    });
  });
}

// Search
document.getElementById('search').addEventListener('input', e => {
  const term = e.target.value.toLowerCase().trim();
  if (!term) return renderPins();
  const filtered = getPins().filter(p => {
    const hay = [
      p.name||'',
      p.msg||'',
      ...p.comments.map(c=>c.text||''),
      p.lat.toFixed(6),
      p.lng.toFixed(6)
    ].join(' ').toLowerCase();
    return hay.includes(term);
  });
  renderPins(filtered);
});

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab + '-tab').classList.add('active');

    if (btn.dataset.tab === 'terminal') {
      inputEl.focus();
    } else if (btn.dataset.tab === 'pins') {
      renderPins();
    }
  });
});

// Handle #p=... links (shared pins)
window.addEventListener('hashchange', handleSharedPin);
function handleSharedPin() {
  const hash = location.hash.slice(1);
  if (hash.startsWith('p=')) {
    try {
      const pin = JSON.parse(atob(hash.slice(2)));
      document.querySelector('[data-tab="pins"]').click();
      renderPins([pin]);
      document.getElementById('search').classList.add('hidden');
      document.getElementById('pins-container').insertAdjacentHTML('afterbegin',
        '<p style="color:var(--accent); text-align:center; margin:1rem 0 2rem;">Shared Pin • read-only view</p>'
      );
    } catch {}
  }
}
handleSharedPin(); // check on load

// Boot
println("GPS PINS — 2026", "system");
println("100% local • type help", "system");
println("────────────────────────────────────", "system");
println("");
printAI("ready when you are...");
println("");
</script>
</body>
</html>
