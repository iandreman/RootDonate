<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GPS Pins – Private Markers</title>
  <meta name="description" content="Save private GPS locations. 100% local storage, offline, no account needed." />

  <style>
    :root {
      --bg:        #0a0e1a;
      --surface:   #141822;
      --text:      #e0e7ff;
      --muted:     #8899aa;
      --accent:    #00d4ff;
      --accent-dim:#00ff9d;
      --purple:    #bb86fc;
      --danger:    #ff5555;
      --border:    rgba(0,212,255,0.18);
      --shadow:    0 4px 20px rgba(0,0,0,0.4);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', Courier, monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 1rem 1.4rem;
      background: rgba(0,0,0,0.6);
      border-bottom: 1px solid var(--border);
      text-align: center;
    }
    h1 {
      font-size: 2.1rem;
      background: linear-gradient(90deg, var(--purple), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .subtitle { color: var(--muted); font-size: 0.95rem; margin-top: 0.5rem; }
    .tabs {
      margin: 1.2rem 0 0.8rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .tab-btn {
      padding: 0.7rem 1.6rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      cursor: pointer;
      font-weight: bold;
      transition: all 0.18s ease;
    }
    .tab-btn.active {
      background: linear-gradient(135deg, var(--purple), var(--accent));
      color: #000;
      border-color: transparent;
    }
    .tab-content {
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }
    .tab-content.active { display: flex; }

    #terminal-tab .terminal {
      flex: 1;
      padding: 1.3rem 1.8rem;
      overflow-y: auto;
      line-height: 1.55;
      font-size: 1rem;
    }
    .line { margin: 0.5rem 0; white-space: pre-wrap; word-break: break-word; }
    .prompt    { color: var(--accent-dim); }
    .info      { color: #00ffea; }
    .system    { color: #778899; }
    .error     { color: var(--danger); }

    .input-line {
      display: flex;
      align-items: flex-start;
      padding: 1rem 1.8rem;
      background: rgba(0,0,0,0.4);
      border-top: 1px solid var(--border);
    }
    .input-line .prompt { margin-right: 1rem; flex-shrink: 0; }
    #input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--accent);
      font: inherit;
      outline: none;
      caret-color: var(--accent);
    }
    .cursor {
      display: inline-block;
      width: 10px;
      height: 1.3em;
      background: var(--accent);
      animation: blink 1.2s step-end infinite;
      margin-left: 5px;
    }
    @keyframes blink { 50% { opacity: 0; } }

    #pins-tab {
      padding: 1.5rem;
      overflow-y: auto;
    }
    .collection-header {
      text-align: center;
      margin: 0 0 1.6rem;
      color: var(--accent);
      font-size: 1.5rem;
    }
    .empty-state {
      text-align: center;
      color: var(--muted);
      padding: 6rem 1.5rem;
      font-size: 1.15rem;
      line-height: 1.7;
    }
    .card {
      background: rgba(20,24,34,0.97);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.3rem 0;
      box-shadow: var(--shadow);
    }
    .pin-title { color: var(--accent); font-size: 1.4rem; margin-bottom: 0.7rem; }
    .meta {
      color: var(--muted);
      font-size: 0.95rem;
      margin: 0.8rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 1.6rem;
    }
    #search {
      width: 100%;
      max-width: 500px;
      padding: 0.9rem;
      margin: 0 auto 1.8rem;
      display: block;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: inherit;
      font-size: 1rem;
    }
    .share-row {
      margin-top: 1.2rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: center;
    }
    .action-btn, .copy-btn, .email-btn {
      padding: 0.6rem 1.1rem;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      border: 1px solid;
      font-size: 0.9rem;
    }
    .action-btn {
      background: rgba(0,212,255,0.18);
      border-color: var(--accent-dim);
      color: var(--accent);
    }
    .action-btn:hover { background: rgba(0,212,255,0.35); }
    .copy-btn {
      background: rgba(187,134,252,0.18);
      border-color: var(--purple);
      color: var(--purple);
    }
    .copy-btn:hover { background: rgba(187,134,252,0.35); }
    .copy-btn.copied {
      background: rgba(0,255,157,0.3);
      color: #00ff9d;
      border-color: #00ff9d;
    }
    .email-btn {
      background: rgba(187,134,252,0.25);
      border-color: var(--purple);
      color: var(--purple);
    }
    .email-btn:hover { background: rgba(187,134,252,0.45); }

    #fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--purple), var(--accent));
      color: #000;
      border: none;
      border-radius: 50%;
      font-size: 2.2rem;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(0,0,0,0.5);
      cursor: pointer;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }
    #fab:hover { transform: scale(1.1); }
    #fab:active { transform: scale(0.95); }

    @media (max-width: 560px) {
      .tabs { flex-direction: column; gap: 0.6rem; }
      .tab-btn { width: 100%; }
      .share-row { flex-direction: column; align-items: stretch; }
      .action-btn, .copy-btn, .email-btn { width: 100%; text-align: center; }
      #fab { bottom: 16px; right: 16px; width: 56px; height: 56px; font-size: 2rem; }
    }
    .line.system.live {
      background: rgba(0, 180, 120, 0.15);
      border-left: 4px solid #00ff9d;
      padding-left: 1rem;
      margin: 0.6rem 0;
    }
  </style>
</head>
<body>

<header>
  <h1>GPS Pins</h1>
  <div class="subtitle">Private markers • 100% offline • No account</div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="terminal">Terminal</button>
    <button class="tab-btn" data-tab="pins">My Pins</button>
  </div>
</header>

<div id="terminal-tab" class="tab-content active">
  <div class="terminal" id="terminal"></div>
  <div class="input-line">
    <span class="prompt">></span>
    <input id="input" type="text" autocomplete="off" spellcheck="false" autofocus>
    <span class="cursor"></span>
  </div>
</div>

<div id="pins-tab" class="tab-content">
  <div class="collection-header">My Saved Pins</div>
  <input type="text" id="search" placeholder="Search name or coordinates…">
  <div id="pins-container"></div>
</div>

<button id="fab" title="Drop pin at current location">+</button>

<script>
// ────────────────────────────────────────────────
// Utilities
// ────────────────────────────────────────────────
const STORAGE_KEY = 'gps-pins-v4';
let lastUsedName = localStorage.getItem('gps-pins-last-name') || '';

function escapeHTML(str = '') {
  const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
  return str.replace(/[&<>"']/g, m => map[m]);
}

function getPins() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  catch { return []; }
}

function savePins(pins) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
}

function getPinShareUrl(pin) {
  const publicPin = { id: pin.id, lat: pin.lat, lng: pin.lng, name: pin.name, time: pin.time };
  return `${location.origin}${location.pathname}#p=${btoa(JSON.stringify(publicPin))}`;
}

async function copyToClipboard(text, btn) {
  try {
    await navigator.clipboard.writeText(text);
    const original = btn.textContent;
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = original;
      btn.classList.remove('copied');
    }, 1800);
  } catch (err) {
    console.error('Clipboard copy failed', err);
    alert('Could not copy — please select manually.');
  }
}

// ────────────────────────────────────────────────
// Terminal helpers
// ────────────────────────────────────────────────
const terminal = document.getElementById('terminal');
const inputEl  = document.getElementById('input');

function println(html, cls = 'line') {
  const div = document.createElement('div');
  div.className = cls;
  div.innerHTML = html;
  terminal.appendChild(div);
  terminal.scrollTop = terminal.scrollHeight;
}

function printInfo(html)  { println(html, 'line info'); }
function printError(html) { println(html, 'line error'); }
function printSystem(html){ println(html, 'line system'); }
function clearScreen()    { terminal.innerHTML = ''; }

// ────────────────────────────────────────────────
// Live GPS tracking
// ────────────────────────────────────────────────
let watchId = null;
const liveStatusLine = document.createElement('div');
liveStatusLine.className = 'line system';
liveStatusLine.innerHTML = 'Live GPS: <span id="live-gps">—</span>  (accuracy: <span id="live-acc">—</span>m)  |  Time: <span id="live-time">—</span>';
liveStatusLine.style.position = 'sticky';
liveStatusLine.style.top = '0';
liveStatusLine.style.background = 'rgba(0,0,0,0.7)';
liveStatusLine.style.padding = '0.4rem 1rem';
liveStatusLine.style.zIndex = '10';
liveStatusLine.style.borderBottom = '1px solid var(--border)';

// We'll append this once when terminal becomes visible

function startLiveGPS() {
  if (watchId !== null) return; // already watching

  if (!navigator.geolocation) {
    printError("Geolocation not supported by this browser.");
    return;
  }

  printSystem("Starting live GPS tracking... (updates every few seconds)");

  watchId = navigator.geolocation.watchPosition(
    (position) => {
      const lat = position.coords.latitude.toFixed(6);
      const lng = position.coords.longitude.toFixed(6);
      const acc = Math.round(position.coords.accuracy);

      document.getElementById('live-gps').textContent = `${lat}, ${lng}`;
      document.getElementById('live-acc').textContent = acc;

      // Optional: small log line every ~10–15 seconds (not every update)
      if (Math.random() < 0.3) {
        println(`Live update: ${lat}, ${lng}  (±${acc}m)`, 'line info');
      }
    },
    (err) => {
      let msg = "Live GPS error";
      if (err.code === 1) msg += " → permission denied";
      if (err.code === 3) msg += " → timeout";
      printError(msg);
      stopLiveGPS();
    },
    {
      enableHighAccuracy: true,
      timeout: 8000,
      maximumAge: 3000
    }
  );
}

function stopLiveGPS() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    document.getElementById('live-gps').textContent = '—';
    document.getElementById('live-acc').textContent = '—';
    printSystem("Live GPS tracking stopped.");
  }
}

let clockInterval = null;

function startLiveClock() {
  if (clockInterval !== null) return; // already running

  updateClock(); // initial update
  clockInterval = setInterval(updateClock, 1000); // update every second
}

function updateClock() {
  const now = new Date();
  const timeStr = now.toLocaleString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
  document.getElementById('live-time').textContent = timeStr;
}

function stopLiveClock() {
  if (clockInterval !== null) {
    clearInterval(clockInterval);
    clockInterval = null;
    document.getElementById('live-time').textContent = '—';
  }
}

// ────────────────────────────────────────────────
// Command handler
// ────────────────────────────────────────────────
function handleCommand(text) {
  const cmd = text.trim().toLowerCase();

  if (!cmd || cmd === 'clear' || cmd === 'cls') {
    clearScreen();
    return;
  }

  if (cmd === 'help' || cmd === '?' || cmd === 'h') {
    printInfo(`
Available commands:
  help / ? / h          → show this help
  clear / cls           → clear screen
  save / drop / + / new → save current location
  list / pins           → list all saved pins
  count                 → show number of pins
  recent                → show 5 most recent pins
  live / track / startlive  → start continuous GPS + time updates
  stoplive / stop           → stop live tracking + clock
  clock / time              → start live time updates only
  stopclock                 → stop live clock
  whereami / pos            → get current position (one-shot)

Type a command and press Enter.
Use the + button to quickly drop a pin.
    `);
    return;
  }

  if (['save','drop','+','new'].includes(cmd)) {
    document.getElementById('fab').click();
    return;
  }

  if (cmd === 'count') {
    const count = getPins().length;
    printInfo(`You have ${count} pin${count === 1 ? '' : 's'} saved.`);
    return;
  }

  if (['list','pins'].includes(cmd)) {
    const pins = getPins();
    if (!pins.length) {
      printInfo("No pins saved yet. Tap + or type 'save'.");
      return;
    }
    let out = `Saved pins (${pins.length}):\n\n`;
    pins.forEach((p,i) => {
      out += `${i+1}. ${escapeHTML(p.name || 'Unnamed')}  (${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}) — ${new Date(p.time).toLocaleString()}\n`;
    });
    printInfo(out);
    return;
  }

  if (cmd === 'recent') {
    const recent = getPins().slice().reverse().slice(0,5);
    if (!recent.length) {
      printInfo("No pins yet.");
      return;
    }
    let out = "Most recent pins:\n\n";
    recent.forEach((p,i) => {
      out += `${i+1}. ${escapeHTML(p.name || 'Unnamed')}  (${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}) — ${new Date(p.time).toLocaleString()}\n`;
    });
    printInfo(out);
    return;
  }

  if (cmd === 'live' || cmd === 'startlive' || cmd === 'track') {
    startLiveGPS();
    startLiveClock(); // add this
    return;
  }

  if (cmd === 'stoplive' || cmd === 'stop' || cmd === 'nostalk') {
    stopLiveGPS();
    stopLiveClock(); // add this
    return;
  }

  if (cmd === 'clock' || cmd === 'time') {
    startLiveClock();
    printSystem("Live clock started (updates every second).");
    return;
  }

  if (cmd === 'stopclock') {
    stopLiveClock();
    return;
  }

  if (cmd === 'whereami' || cmd === 'pos') {
    if (navigator.geolocation) {
      printSystem("Getting current position...");
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          const acc = Math.round(pos.coords.accuracy);
          printInfo(`Now: ${lat}, ${lng}  (±${acc}m)`);
        },
        err => printError("Position error" + (err.code===1 ? " → permission denied" : ""))
      );
    }
    return;
  }

  printError(`Unknown command: ${escapeHTML(text)}<br>Type <strong>help</strong> for commands.`);
}

// ────────────────────────────────────────────────
// Input handling
// ────────────────────────────────────────────────
inputEl.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  e.preventDefault();
  const text = inputEl.value.trim();
  if (!text) return;

  println('> ' + escapeHTML(text), 'line prompt');
  handleCommand(text);

  inputEl.value = '';
  inputEl.focus();
});

// ────────────────────────────────────────────────
// Save pin (FAB) — now with Email button too
// ────────────────────────────────────────────────
document.getElementById('fab').addEventListener('click', async () => {
  let name = lastUsedName || 'Pin ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  name = prompt("Pin name:", name)?.trim() || 'Untitled';
  localStorage.setItem('gps-pins-last-name', name);

  if (!navigator.geolocation) {
    printError("Geolocation not supported.");
    return;
  }

  try {
    const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, {
      enableHighAccuracy: true,
      timeout: 12000,
      maximumAge: 0
    }));

    const lat = Number(pos.coords.latitude.toFixed(6));
    const lng = Number(pos.coords.longitude.toFixed(6));

    const pin = {
      id: crypto.randomUUID(),
      lat, lng, name,
      time: new Date().toISOString()
    };

    const pins = getPins();
    pins.push(pin);
    savePins(pins);

    const url = getPinShareUrl(pin);

    printInfo(`Saved: <strong>${escapeHTML(name)}</strong>`);
    println(`   ${lat}, ${lng}`, 'line info');

    const coordsTime = `${lat}, ${lng} — ${new Date(pin.time).toLocaleString()}`;
    const emailSubject = encodeURIComponent(`Check out this GPS Pin: ${name}`);
    const emailBody = encodeURIComponent(
      `Hi,\n\n` +
      `Here's a private GPS pin I saved:\n` +
      `Name: ${name}\n` +
      `Coordinates: ${coordsTime}\n` +
      `Share link: ${url}\n\n` +
      `Open it in GPS Pins app to view.\n\n`
    );

    const mailtoLink = `mailto:?subject=${emailSubject}&body=${emailBody}`;

    const linkLine = document.createElement('div');
    linkLine.className = 'line info';
    linkLine.innerHTML = `Share: <a href="${url}" target="_blank" style="color:var(--accent);">${url}</a> `;
    
    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.textContent = 'Copy URL';
    copyBtn.onclick = () => copyToClipboard(url, copyBtn);
    
    const emailBtn = document.createElement('a');
    emailBtn.className = 'email-btn';
    emailBtn.href = mailtoLink;
    emailBtn.textContent = 'Email';
    
    linkLine.appendChild(copyBtn);
    linkLine.appendChild(emailBtn);
    terminal.appendChild(linkLine);
    terminal.scrollTop = terminal.scrollHeight;
  } catch (err) {
    printError("Location error" + (err.code===1 ? " → permission denied" : err.code===3 ? " → timeout" : ""));
  }
});

// ────────────────────────────────────────────────
// My Pins tab — now with Email button per pin
// ────────────────────────────────────────────────
function renderMyPins(pinsToShow = getPins()) {
  const container = document.getElementById('pins-container');
  container.innerHTML = '';

  if (!pinsToShow.length) {
    container.innerHTML = '<div class="empty-state">No pins saved yet.<br>Tap + or type "save" in Terminal.</div>';
    return;
  }

  pinsToShow.forEach(pin => {
    const url = getPinShareUrl(pin);
    const coordsTime = `${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)} — ${new Date(pin.time).toLocaleString()}`;
    const emailSubject = encodeURIComponent(`Check out this GPS Pin: ${pin.name || 'Unnamed'}`);
    const emailBody = encodeURIComponent(
      `Hi,\n\n` +
      `Here's a private GPS pin:\n` +
      `Name: ${pin.name || 'Unnamed'}\n` +
      `Coordinates: ${coordsTime}\n` +
      `Share link: ${url}\n\n` +
      `Open it in GPS Pins app to view.\n\n`
    );
    const mailtoLink = `mailto:?subject=${emailSubject}&body=${emailBody}`;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="pin-title">${escapeHTML(pin.name || 'Unnamed')}</div>
      <div class="meta">
        <span>${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)}</span>
        <span>${new Date(pin.time).toLocaleString()}</span>
      </div>
      <div class="share-row">
        <a href="${url}" class="action-btn" target="_blank">Open / Share</a>
        <button class="copy-btn">Copy URL</button>
        <a href="${mailtoLink}" class="email-btn">Email</a>
      </div>
    `;
    card.querySelector('.copy-btn').onclick = () => copyToClipboard(url, card.querySelector('.copy-btn'));
    container.appendChild(card);
  });
}

document.getElementById('search').addEventListener('input', e => {
  const term = e.target.value.toLowerCase().trim();
  renderMyPins(
    term ? getPins().filter(p =>
      [(p.name||'').toLowerCase(), p.lat.toFixed(6), p.lng.toFixed(6)].join(' ').includes(term)
    ) : getPins()
  );
});

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab + '-tab').classList.add('active');

    if (btn.dataset.tab === 'terminal') {
      inputEl.focus();
      // Add live status bar if not already there
      if (!document.getElementById('live-gps')) {
        const terminalDiv = document.getElementById('terminal');
        terminalDiv.parentElement.insertBefore(liveStatusLine, terminalDiv);
      }
      // Optional: auto-start live tracking when opening terminal
      // startLiveGPS();
      // startLiveClock();   ← uncomment if you want them always on
    }
    else if (btn.dataset.tab === 'pins') {
      renderMyPins();
      stopLiveGPS(); // optional: stop when leaving terminal
      stopLiveClock(); // add this
    }
  });
});

// ────────────────────────────────────────────────
// Shared pin link handler
// ────────────────────────────────────────────────
window.addEventListener('hashchange', () => {
  const hash = location.hash.slice(1);
  if (!hash.startsWith('p=')) return;
  try {
    const pin = JSON.parse(atob(hash.slice(2)));
    document.querySelector('[data-tab="terminal"]').click();
    printInfo(`Received shared pin: <strong>${escapeHTML(pin.name||'Unnamed')}</strong>`);
    println(`   ${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)}`, 'line info');
    println(`Type <strong>save</strong> or tap + to store it.`, 'line system');
    history.replaceState(null, null, ' ');
  } catch {
    printError("Invalid share link.");
  }
});
if (location.hash) window.dispatchEvent(new HashChangeEvent('hashchange'));

// ────────────────────────────────────────────────
// Boot
// ────────────────────────────────────────────────
printSystem("GPS Pins • Private & Local — 2026");
printSystem("100% offline • No tracking • Data stays on device");
printSystem("──────────────────────────────────────────────");
println("");
printInfo("Type <strong>help</strong> to see commands. Tap + to save your location.");
println("");
</script>
</body>
</html>
