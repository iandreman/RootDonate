<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RootDonate • We Are All Here</title>
  <meta name="description" content="A quiet work of art about being human on the same internet." />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root { --blue:#0a84ff; --green:#30d158; --orange:#ff9f0a; }
    * { box-sizing:border-box; margin:0; padding:0; }
    body, html { height:100%; overflow:hidden; background:#000; color:#fff;
                 font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; }

    #map { width:100%; height:100%; filter:brightness(0.92) contrast(1.12); }

    .header {
      position:absolute; top:0; left:0; right:0; padding:3rem 2rem 2rem;
      text-align:center; z-index:1000; pointer-events:none;
      background:linear-gradient(180deg,rgba(0,0,0,0.9),transparent);
      backdrop-filter:blur(30px);
    }
    h1 {
      font-size:clamp(3rem,8vw,5rem); font-weight:900; letter-spacing:-2.5px;
      background:linear-gradient(90deg,var(--blue),var(--green),var(--orange));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 0 50px rgba(10,132,255,0.4);
    }
    .poem {
      margin-top:1.8rem; font-size:1.55rem; font-weight:300; opacity:0.9;
      line-height:1.7; letter-spacing:0.6px;
    }

    /* AI Search */
    #ai-search-container {
      position:absolute; bottom:70px; left:50%; transform:translateX(-50%);
      width:90%; max-width:660px; z-index:1000; pointer-events:all;
    }
    #ai-search {
      width:100%; padding:14px 20px; font-size:1.1rem;
      background:rgba(20,20,30,0.85); border:1.5px solid rgba(255,255,255,0.15);
      border-radius:30px; color:#fff; backdrop-filter:blur(20px);
      outline:none; box-shadow:0 8px 32px rgba(0,0,0,0.4);
      transition:all 0.3s ease;
    }
    #ai-search:focus {
      border-color:var(--blue);
      box-shadow:0 0 0 4px rgba(10,132,255,0.25), 0 12px 40px rgba(0,0,0,0.5);
    }
    #ai-search::placeholder { color:rgba(255,255,255,0.5); }

    #ai-response {
      margin-top:12px; padding:16px 20px;
      background:rgba(15,15,25,0.9); border-radius:16px;
      border-left:4px solid var(--blue); font-size:1rem; line-height:1.6;
      max-height:300px; overflow-y:auto; opacity:0;
      transform:translateY(-10px); transition:all 0.4s ease;
      backdrop-filter:blur(20px);
    }
    #ai-response.visible { opacity:1; transform:translateY(0); }

    footer {
      position:absolute; bottom:0; left:0; right:0; padding:1.2rem;
      text-align:center; font-size:0.92rem; opacity:0.75; z-index:1000;
      background:rgba(0,0,0,0.7); backdrop-filter:blur(20px);
    }

    /* Markers */
    .user-marker  { background:var(--blue); border:3px solid #fff; border-radius:50%; width:18px; height:18px; box-shadow:0 0 25px #0a84ff; animation:pulse-blue 2.2s infinite; }
    .other-marker { background:var(--green); border:2.5px solid #fff; border-radius:50%; width:15px; height:15px; box-shadow:0 0 20px #30d158; animation:pulse-green 3s infinite; }
    @keyframes pulse-blue  { 0%,100% { box-shadow:0 0 0 0 rgba(10,132,255,0.8); } 70% { box-shadow:0 0 0 22px rgba(10,132,255,0); } }
    @keyframes pulse-green { 0%,100% { box-shadow:0 0 0 0 rgba(48,209,88,0.7); } 70% { box-shadow:0 0 0 18px rgba(48,209,88,0); } }
  </style>
</head>
<body>

  <div id="map"></div>

  <div class="header">
    <h1>RootDonate</h1>
    <div class="poem">
      We are all here • together<br>
      One planet • one quiet network<br>
      Breathing the same invisible light
    </div>
  </div>

  <div id="ai-search-container">
    <input type="text" id="ai-search" placeholder="Ask Grok anything… (e.g. Paris, home, where is love?)" autocomplete="off">
    <div id="ai-response"></div>
  </div>

  <footer>
    <span id="counter">Connecting the world...</span> • 2025 • Forever free
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const BACKEND = 'https://weareallhere.deno.dev';

    const map = L.map('map', {
      zoomControl: false, minZoom: 2.5, maxZoom: 18,
      worldCopyJump: true, attributionControl: false
    }).setView([20, 0], 2.8);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd', maxZoom: 19
    }).addTo(map);

    const userIcon  = L.divIcon({ className:'user-marker',  iconSize:[18,18] });
    const otherIcon = L.divIcon({ className:'other-marker', iconSize:[15,15] });
    let userMarker = null;
    let userLocation = null;
    const othersLayer = L.layerGroup().addTo(map);
    const seen = new Set();

    // Counter & visitors
    async function updateCounter() {
      try {
        const {count} = await (await fetch(`${BACKEND}/count`)).json();
        document.getElementById('counter').textContent =
          count > 0 ? `${count.toLocaleString()}+ humans breathing with you right now`
                    : 'You are the first today • welcome home';
      } catch(e) {}
    }

    function showUser(lat, lon, text = 'You are here • right now') {
      if (userMarker) userMarker.remove();
      userMarker = L.marker([lat, lon], {icon: userIcon})
        .addTo(map)
        .bindPopup(text, {closeButton:false, autoClose:false, closeOnEscapeKey:false})
        .openPopup();
      userLocation = [lat, lon];
      map.flyTo([lat, lon], 5, {duration: 2.5});
    }

    function addOther({lat, lng, city, country}) {
      const key = `${lat.toFixed(4)},${lng.toFixed(4)}`;
      if (seen.has(key)) return;
      seen.add(key);
      const label = city && country ? `${city}, ${country}` : 'Somewhere on Earth';
      L.marker([lat, lng], {icon: otherIcon})
        .bindPopup(label, {closeButton:false, autoClose:false})
        .addTo(othersLayer);
    }

    async function loadVisitors() {
      try {
        const visitors = await (await fetch(`${BACKEND}/visitors`)).json();
        othersLayer.clearLayers(); seen.clear();
        visitors.forEach(addOther);
        updateCounter();
      } catch(e) {}
    }

    async function saveMe(lat, lon, city='', country='') {
      try {
        await fetch(`${BACKEND}/visit`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({lat, lng:lon, city, country})
        });
      } catch(e) {}
    }

    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        async pos => {
          const {latitude, longitude} = pos.coords;
          showUser(latitude, longitude);
          await saveMe(latitude, longitude);
          loadVisitors();
        },
        async () => {
          try {
            const d = await (await fetch('https://ipapi.co/json/')).json();
            showUser(d.latitude, d.longitude, `You are here • ${d.city||''}, ${d.country_name||'Earth'}`);
            await saveMe(d.latitude, d.longitude, d.city, d.country_name);
            loadVisitors();
          } catch { document.getElementById('counter').textContent = 'We are all here • somewhere'; }
        },
        {enableHighAccuracy:true, timeout:15000}
      );
    }

    // Live updates
    new EventSource(`${BACKEND}/stream`).onmessage = e => {
      addOther(JSON.parse(e.data));
      updateCounter();
    };

    loadVisitors();
    setInterval(loadVisitors, 5*60*1000);
    updateCounter();

    // ————————————————————————
    // AI MAP SEARCH (updated for auth and latest model)
    // ————————————————————————
    const searchInput = document.getElementById('ai-search');
    const responseDiv = document.getElementById('ai-response');
    let currentRequest = null;

    // REPLACE WITH YOUR ACTUAL API KEY FROM console.x.ai
    const XAI_API_KEY = 'xai-xai-Hf3jv3qCXJSMjZtDJII1w55Uyn38g7BoEtdS3I5AQ3LrTdHiAYHVcueYSexLzxkZuOTx7XDMHYnNEQTj';

    searchInput.addEventListener('keypress', async e => {
      if (e.key !== 'Enter' || !searchInput.value.trim()) return;

      const query = searchInput.value.trim().toLowerCase();
      responseDiv.innerHTML = 'Grok is listening…';
      responseDiv.classList.add('visible');

      if (currentRequest) currentRequest.abort();
      const controller = new AbortController();
      currentRequest = controller;

      // Fast built-in commands
      if (query === 'home' && userLocation) {
        responseDiv.innerHTML = 'Coming home…';
        map.flyTo(userLocation, 6, {duration: 4});
        searchInput.value = '';
        return;
      }
      if (['everyone','all','world','where is everyone'].some(w => query.includes(w))) {
        responseDiv.innerHTML = 'Here we all are… breathing together';
        map.flyTo([20, 0], 2.8, {duration: 4});
        searchInput.value = '';
        return;
      }

      try {
        const res = await fetch('https://api.x.ai/v1/chat/completions', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${XAI_API_KEY}`,  // Updated: Added auth header
            'X-Client': 'grok-web-free'  // Optional: Keeps original client hint
          },
          body: JSON.stringify({
            model: 'grok-4',  // Updated: Use newer model (fallback to 'grok-beta' if unavailable)
            temperature: 0.9,
            max_tokens: 250,  // Slightly increased for better responses
            messages: [
              { role: 'system', content: `You are a poetic cartographer. Reply ONLY with valid JSON:
{ "action": "fly" | "zoom" | "say", "lat": number, "lon": number, "zoom": 2-14, "message": "short poetic text" }

Examples:
- Paris → { "action":"fly", "lat":48.8566, "lon":2.3522, "zoom":11, "message":"City of light" }
- ocean → { "action":"fly", "lat":0, "lon":-160, "zoom":3, "message":"The great quiet" }
- i'm lonely → { "action":"say", "message":"You are never alone here" }

Always ensure lat/lon are real coordinates if flying. Keep messages under 100 chars.` },
              { role: 'user', content: query }
            ]
          }),
          signal: controller.signal
        });

        if (!res.ok) throw new Error('sleep');

        const text = (await res.json()).choices[0].message.content;
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        const parsed = JSON.parse(jsonMatch ? jsonMatch[0] : text);

        if (parsed.action === 'fly' && parsed.lat != null && parsed.lon != null) {
          responseDiv.innerHTML = parsed.message || 'There…';
          map.flyTo([parsed.lat, parsed.lon], parsed.zoom || 9, {duration: 3.8});
        } else if (parsed.action === 'zoom') {
          responseDiv.innerHTML = parsed.message || 'Breathing…';
          map.flyTo(map.getCenter(), parsed.zoom, {duration: 3});
        } else {
          responseDiv.innerHTML = parsed.message || 'We are all here • together';
        }

      } catch (err) {
        if (err.name !== 'AbortError') {
          // Updated: More specific error handling (e.g., for 401 auth issues)
          if (res && res.status === 401) {
            responseDiv.innerHTML = 'Whisper needs a key to unlock the winds... Check API auth.';
          } else {
            responseDiv.innerHTML = 'The wind is quiet tonight… try again softly';
          }
        }
      } finally {
        currentRequest = null;
      }
    });

    searchInput.addEventListener('input', () => {
      if (!searchInput.value.trim()) {
        responseDiv.classList.remove('visible');
        responseDiv.innerHTML = '';
      }
    });

    // Gentle rotating placeholder
    const placeholders = [
      "Ask Grok anything… (e.g. Tokyo, home, where is love?)",
      "Where do you want to go today?",
      "Type a place… or a feeling",
      "We are all here • where are you?"
    ];
    let i = 0;
    setInterval(() => {
      searchInput.placeholder = placeholders[i = (i + 1) % placeholders.length];
    }, 7000);
  </script>
</body>
</html>