<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phone GPS Timeline Pins â€¢ ~500 m Clusters (Local)</title>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#eee; font-family:Arial,Helvetica,sans-serif; }
    .container { max-width:580px; margin:0 auto; padding:20px; }
    h1 { text-align:center; color:#00ff55; margin:10px 0 16px; }
    input, textarea, button { width:100%; padding:12px; margin:10px 0; border:1px solid #444; border-radius:8px; background:#111; color:white; font-size:1em; box-sizing:border-box; }
    button { cursor:pointer; transition:all 0.2s; min-width:140px; font-weight:bold; }
    #uploadBtn { background:#3366ff; color:white; }
    #uploadBtn:hover { background:#6699ff; }
    #status { text-align:center; margin:12px 0; min-height:1.4em; font-size:0.95em; }
    .success { color:#0f5; }
    .error   { color:#f66; }
    .pin-list { margin-top:16px; }
    .location-group { margin-bottom:28px; }
    .location-header { 
      background:#1a1a1a; padding:10px 14px; border-radius:8px 8px 0 0; 
      font-weight:bold; color:#0f5; border:1px solid #333; border-bottom:none; font-size:1.05em; 
    }
    .pin { 
      background:#111; border:1px solid #333; border-top:none; padding:14px 16px; margin:0; 
    }
    .pin:not(:last-child) { border-bottom:1px solid #222; }
    .pin-header { font-weight:bold; color:#55ff99; margin-bottom:6px; }
    .pin-msg { margin:8px 0 10px; white-space:pre-wrap; line-height:1.4; }
    .pin-time { font-size:0.82em; color:#777; text-align:right; margin-top:6px; }
    .info-box { background:#222; padding:12px; border-radius:8px; margin:12px 0; font-size:0.95em; line-height:1.4; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Phone GPS Timeline Pins âš½ #MUFC (~500 m Clusters)</h1>

    <div class="info-box" id="locationInfo">
      Waiting for current location...
    </div>

    <div class="buttons" style="display:flex; flex-wrap:wrap; justify-content:center; gap:12px;">
      <button id="uploadBtn">Upload Timeline JSON</button>
      <input type="file" id="fileInput" accept=".json" style="display:none;">
    </div>
    
    <div id="status"></div>

    <div class="pin-list" id="pinList"></div>
  </div>

  <script>
    const COORD_PRECISION = 5;      // ~1.1 m grouping
    const MATCH_TOLERANCE = 0.0045; // â‰ˆ500 meters

    let userLat = null;
    let userLng = null;
    let timelinePoints = []; // {lat, lng, timestamp, accuracy?}

    // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function coordsMatch(aLat, aLng, bLat, bLng) {
      return Math.abs(aLat - bLat) <= MATCH_TOLERANCE && Math.abs(aLng - bLng) <= MATCH_TOLERANCE;
    }

    function roundCoord(n) {
      return Number(n.toFixed(COORD_PRECISION));
    }

    function showStatus(text, cls = '') {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = cls;
      setTimeout(() => { el.textContent = ''; el.className = ''; }, 6000);
    }

    const locInfoEl = document.getElementById('locationInfo');
    function updateLocationInfo() {
      if (userLat === null || userLng === null) {
        locInfoEl.innerHTML = 'Waiting for precise GPS... (allow location access)';
        locInfoEl.style.color = '#777';
      } else {
        locInfoEl.innerHTML = `ğŸ“ Current: ${userLat.toFixed(5)}, ${userLng.toFixed(5)} â€” showing nearby history (~500 m)`;
        locInfoEl.style.color = '#0f5';
      }
    }

    // â”€â”€â”€ Parse Google Timeline JSON (handles common 2025â€“2026 formats) â”€â”€
    function parseTimelineJson(json) {
      const points = [];

      // 1. Newer on-device export: semanticSegments â†’ timelinePath
      if (json.semanticSegments) {
        json.semanticSegments.forEach(seg => {
          if (seg.timelinePath) {
            seg.timelinePath.forEach(p => {
              let lat, lng;
              // Common: "point": "lat,lng" string
              if (p.point && typeof p.point === 'string') {
                const [latStr, lngStr] = p.point.split(',').map(s => s.trim());
                lat = parseFloat(latStr);
                lng = parseFloat(lngStr);
              }
              // Or latE7 / lngE7 if present
              else if (p.latE7 && p.lngE7) {
                lat = p.latE7 / 1e7;
                lng = p.lngE7 / 1e7;
              }
              // Or nested point {latE7, lngE7}
              else if (p.point && p.point.latE7 && p.point.lngE7) {
                lat = p.point.latE7 / 1e7;
                lng = p.point.lngE7 / 1e7;
              }

              if (!isNaN(lat) && !isNaN(lng)) {
                points.push({
                  lat,
                  lng,
                  timestamp: p.time || seg.startTime || seg.endTime || '',
                  accuracy: p.accuracyMeters || seg.accuracyMeters || '?'
                });
              }
            });
          }
          // Optional: also grab visit/place coords if you want stops (not paths)
        });
      }

      // 2. Older Takeout style: flat "locations" array with latitudeE7
      else if (json.locations) {
        json.locations.forEach(loc => {
          if (loc.latitudeE7 && loc.longitudeE7) {
            points.push({
              lat: loc.latitudeE7 / 1e7,
              lng: loc.longitudeE7 / 1e7,
              timestamp: loc.timestamp || loc.timestampMs ? new Date(Number(loc.timestampMs)).toISOString() : '',
              accuracy: loc.accuracy || '?'
            });
          }
        });
      }

      // Sort newest â†’ oldest
      points.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      return points;
    }

    // â”€â”€â”€ Render nearby historical pins â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPins() {
      const listEl = document.getElementById('pinList');
      if (userLat === null || userLng === null) {
        listEl.innerHTML = '<p style="text-align:center;color:#555;padding:20px;">Waiting for current GPS...</p>';
        return;
      }
      if (timelinePoints.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#555;padding:20px;">No history loaded â€” upload your Timeline JSON âš½</p>';
        return;
      }

      const nearby = timelinePoints.filter(p => coordsMatch(p.lat, p.lng, userLat, userLng));

      if (nearby.length === 0) {
        listEl.innerHTML = '<p style="text-align:center;color:#555;padding:20px;">No historical points within ~500 m of here</p>';
        return;
      }

      listEl.innerHTML = `<p style="text-align:center;color:#0f5;">${nearby.length} historical GPS points near you:</p>`;

      const groups = {};
      nearby.forEach(p => {
        const key = `${roundCoord(p.lat)},${roundCoord(p.lng)}`;
        if (!groups[key]) groups[key] = [];
        groups[key].push(p);
      });

      Object.entries(groups).forEach(([key, group]) => {
        const [lat, lng] = key.split(',').map(Number);
        const groupDiv = document.createElement('div');
        groupDiv.className = 'location-group';
        groupDiv.innerHTML = `
          <div class="location-header">ğŸ“ ${lat.toFixed(5)}, ${lng.toFixed(5)} (~500 m cluster â€¢ ${group.length} points)</div>
        `;

        group.forEach(pt => {
          const pin = document.createElement('div');
          pin.className = 'pin';
          pin.innerHTML = `
            <div class="pin-header">Fix @ ${pt.timestamp ? new Date(pt.timestamp).toLocaleString() : 'Unknown time'}</div>
            <div class="pin-msg">Accuracy: ~${pt.accuracy}m</div>
            <div class="pin-time">${pt.lat.toFixed(6)}, ${pt.lng.toFixed(6)}</div>
          `;
          groupDiv.appendChild(pin);
        });

        listEl.appendChild(groupDiv);
      });
    }

    // â”€â”€â”€ Geolocation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startWatchingLocation() {
      if (!navigator.geolocation) {
        showStatus('Geolocation not supported', 'error');
        return;
      }
      navigator.geolocation.watchPosition(
        pos => {
          userLat = pos.coords.latitude;
          userLng = pos.coords.longitude;
          updateLocationInfo();
          renderPins();
        },
        err => {
          showStatus('Location denied or unavailable â€” check permissions', 'error');
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000 }
      );
    }

    // â”€â”€â”€ File upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('uploadBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const json = JSON.parse(ev.target.result);
          timelinePoints = parseTimelineJson(json);
          showStatus(`Loaded ${timelinePoints.length} GPS points from history!`, 'success');
          renderPins();
        } catch (err) {
          showStatus('Failed to parse JSON â€” check file/format', 'error');
          console.error(err);
        }
      };
      reader.readAsText(file);
    });

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    startWatchingLocation();
    updateLocationInfo();
    renderPins();
  </script>
</body>
</html>