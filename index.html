<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Share Location Pin + Comments</title>
  <style>
    :root {
      --bg: #0a0a15;
      --text: #e0e0ff;
      --accent: #00e0c0;
      --purple: #a78bfa;
      --card: rgba(30, 30, 60, 0.7);
      --border: rgba(167, 139, 250, 0.25);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 1.5rem;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      line-height: 1.6;
    }
    .container { max-width: 700px; margin: 0 auto; }
    h1 {
      text-align: center;
      background: linear-gradient(90deg, var(--purple), var(--accent));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      backdrop-filter: blur(10px);
      margin-bottom: 2rem;
    }
    label { display: block; margin: 1rem 0 0.5rem; color: #ccc; font-weight: 500; }
    input, textarea {
      width: 100%;
      padding: 0.9rem;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      color: white;
      font-size: 1rem;
    }
    textarea { min-height: 90px; }
    button {
      margin-top: 1rem;
      padding: 0.9rem 1.8rem;
      background: linear-gradient(135deg, #7c3aed, #00d4ff);
      border: none;
      border-radius: 999px;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover { opacity: 0.92; }
    .pin {
      background: rgba(30,30,60,0.6);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.8rem;
      margin: 2rem 0;
    }
    .from { color: var(--purple); font-weight: bold; font-size: 1.3rem; }
    .msg { margin: 1rem 0; white-space: pre-wrap; }
    .meta { color: #aaa; font-size: 0.95rem; }
    .comments { margin-top: 1.5rem; }
    .comment {
      background: rgba(167,139,250,0.12);
      padding: 1rem;
      border-radius: 10px;
      margin: 0.8rem 0;
    }
    .comment-meta { font-size: 0.85rem; color: #bbb; margin-top: 0.4rem; }
    .status {
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem 0;
      text-align: center;
      display: none;
    }
    .status.success { background: rgba(0,220,180,0.2); color: #00e0c0; }
    .status.error   { background: rgba(255,80,80,0.2); color: #ff8080; }
    .share-box {
      margin-top: 1.5rem;
      padding: 1rem;
      background: rgba(0,220,180,0.1);
      border-radius: 10px;
      word-break: break-all;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Share Location Pin</h1>

  <div id="status" class="status"></div>

  <div class="card" id="create-section">
    <h2>Create Pin</h2>
    <div>
      <label>Your name (optional)</label>
      <input id="name" placeholder="Anonymous">
    </div>
    <div>
      <label>Message / note (optional)</label>
      <textarea id="msg" placeholder="What's here?"></textarea>
    </div>
    <div>
      <label>First comment (optional)</label>
      <input id="initial-comment" placeholder="Start the conversation...">
    </div>
    <button onclick="createPin()">Create & Get Share Link</button>
  </div>

  <div class="pin" id="pin-view" style="display:none;">
    <div class="from" id="pin-from"></div>
    <div class="msg" id="pin-msg"></div>
    <div class="meta" id="pin-meta"></div>

    <div class="comments" id="comments-list"></div>

    <div>
      <label>Add comment</label>
      <textarea id="new-comment" placeholder="Your thoughts..."></textarea>
      <button onclick="addComment()">Post Comment</button>
    </div>

    <div class="share-box" id="share-url-box" style="display:none;">
      <strong>Share this link:</strong><br>
      <button onclick="copyLink()" style="margin-top:0.8rem;">Copy link</button>
      <span id="share-url"></span>
    </div>
  </div>
</div>

<script>
let currentPin = null;

function showStatus(msg, type = 'success') {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = 'status ' + type;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4500);
}

function renderComments() {
  const container = document.getElementById('comments-list');
  container.innerHTML = '<strong>Comments</strong>';
  if (!currentPin.comments?.length) {
    container.innerHTML += '<p style="color:#888;margin:1rem 0;">No comments yet.</p>';
    return;
  }
  currentPin.comments.forEach(c => {
    const div = document.createElement('div');
    div.className = 'comment';
    div.innerHTML = `
      ${c.text}
      <div class="comment-meta">${c.author || 'Anonymous'} • ${new Date(c.time).toLocaleString()}</div>
    `;
    container.appendChild(div);
  });
}

function updateShareUrl() {
  const encoded = btoa(JSON.stringify(currentPin));
  const url = `${location.origin}${location.pathname}?p=${encodeURIComponent(encoded)}`;
  document.getElementById('share-url').textContent = url;
  document.getElementById('share-url-box').style.display = 'block';
  currentPin.shareUrl = url; // for copy
}

function createPin() {
  if (!navigator.geolocation) return showStatus('Geolocation not supported', 'error');

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    const name  = document.getElementById('name').value.trim() || 'Anonymous';
    const msg   = document.getElementById('msg').value.trim();
    const first = document.getElementById('initial-comment').value.trim();

    currentPin = {
      lat, lng, name, msg,
      time: new Date().toISOString(),
      comments: first ? [{ text: first, author: name, time: new Date().toISOString() }] : []
    };

    document.getElementById('pin-from').textContent = name;
    document.getElementById('pin-msg').textContent = msg || '(no message)';
    document.getElementById('pin-meta').textContent = `${lat}, ${lng} • ${new Date().toLocaleString()}`;
    renderComments();
    document.getElementById('pin-view').style.display = 'block';
    document.getElementById('create-section').style.display = 'none';

    updateShareUrl();
    showStatus('Pin created! Share the link below.');

  }, err => {
    showStatus('Location access denied or failed: ' + err.message, 'error');
  }, { enableHighAccuracy: true });
}

function addComment() {
  const text = document.getElementById('new-comment').value.trim();
  if (!text) return showStatus('Enter a comment first', 'error');
  if (!currentPin) return showStatus('No pin loaded', 'error');

  const author = prompt('Your name (optional)')?.trim() || 'Anonymous';

  currentPin.comments.push({
    text,
    author,
    time: new Date().toISOString()
  });

  renderComments();
  updateShareUrl();
  document.getElementById('new-comment').value = '';
  showStatus('Comment added — link updated!');
}

function copyLink() {
  if (!currentPin?.shareUrl) return;
  navigator.clipboard.writeText(currentPin.shareUrl)
    .then(() => showStatus('Link copied!'))
    .catch(() => showStatus('Copy failed — select text manually', 'error'));
}

// Load shared pin from URL
(function loadShared() {
  const params = new URLSearchParams(location.search);
  const data = params.get('p');
  if (!data) return;

  try {
    currentPin = JSON.parse(atob(data));
    document.getElementById('pin-from').textContent = currentPin.name || 'Anonymous';
    document.getElementById('pin-msg').textContent = currentPin.msg || '(no message)';
    document.getElementById('pin-meta').textContent = `${currentPin.lat}, ${currentPin.lng} • ${new Date(currentPin.time).toLocaleString()}`;
    renderComments();
    document.getElementById('pin-view').style.display = 'block';
    document.getElementById('create-section').style.display = 'none';
    updateShareUrl();
    showStatus('Shared pin loaded');
  } catch (e) {
    showStatus('Invalid link', 'error');
  }
})();
</script>
</body>
</html>