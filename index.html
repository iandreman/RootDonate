<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Share & Search Location Pins (Local)</title>
  <meta name="description" content="Create/share location pins + search your saved ones by keyword â€” all in browser." />
  
  <style>
    :root {
      --bg: #0a0a15;
      --text: #e0e0ff;
      --accent: #00e0c0;
      --purple: #a78bfa;
      --card: rgba(30, 30, 60, 0.75);
      --border: rgba(167, 139, 250, 0.3);
      --success: #00e0c0;
      --error: #ff8080;
    }
    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      line-height: 1.6;
      padding: 1.5rem;
      margin: 0;
    }
    .container { max-width: 740px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 2rem; background: linear-gradient(90deg, var(--purple), var(--accent)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .card, .pin { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.8rem; margin-bottom: 1.8rem; backdrop-filter: blur(10px); }
    label { display: block; margin: 1.2rem 0 0.5rem; color: #bbb; font-weight: 500; }
    input, textarea { width: 100%; padding: 0.95rem; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: inherit; font-size: 1rem; }
    button { margin-top: 0.9rem; padding: 0.95rem 2rem; background: linear-gradient(135deg, #7c3aed, #00d4ff); border: none; border-radius: 999px; color: white; font-weight: 600; cursor: pointer; }
    button:hover { opacity: 0.92; }
    .search-box { margin: 2rem 0; }
    #search-input { font-size: 1.1rem; }
    .pin-list { display: grid; gap: 1.5rem; }
    .pin-item { background: rgba(167,139,250,0.12); padding: 1.4rem; border-radius: 12px; cursor: pointer; }
    .pin-item:hover { background: rgba(167,139,250,0.2); }
    .from { color: var(--purple); font-weight: bold; font-size: 1.4rem; }
    .msg { margin: 1rem 0; white-space: pre-wrap; }
    .meta { color: #aaa; font-size: 0.95rem; }
    .status { padding: 1rem; border-radius: 10px; margin: 1rem 0; text-align: center; display: none; }
    .status.success { background: rgba(0,224,192,0.2); color: var(--success); }
    .status.error { background: rgba(255,80,80,0.2); color: var(--error); }
  </style>
</head>
<body>

<div class="container">
  <h1>Share & Search Location Pins</h1>

  <div id="status" class="status" role="alert"></div>

  <!-- Create Pin -->
  <section class="card">
    <h2>Create Pin</h2>
    <div>
      <label for="name">Your name (optional)</label>
      <input id="name" placeholder="Anonymous">
    </div>
    <div>
      <label for="msg">Message / note (optional)</label>
      <textarea id="msg" placeholder="What's here?..."></textarea>
    </div>
    <div>
      <label for="initial-comment">First comment (optional)</label>
      <input id="initial-comment" placeholder="Start conversation...">
    </div>
    <button onclick="createPin()">Create & Save + Share</button>
  </section>

  <!-- Search -->
  <div class="search-box card">
    <h2>Search Your Saved Pins</h2>
    <input type="text" id="search-input" placeholder="Search by name, message, or comment keyword..." oninput="searchPins()">
  </div>

  <!-- List of saved pins -->
  <div id="pin-list" class="pin-list"></div>

  <!-- View selected pin -->
  <section class="pin" id="pin-view" style="display:none;">
    <div class="from" id="pin-from"></div>
    <div class="msg" id="pin-msg"></div>
    <div class="meta" id="pin-meta"></div>
    <div class="comments" id="comments-list"></div>
    <div>
      <label for="new-comment">Add comment</label>
      <textarea id="new-comment" placeholder="Your thoughts..."></textarea>
      <button onclick="addComment()">Post Comment</button>
    </div>
    <div style="margin-top:1.5rem;">
      <strong>Share link:</strong><br>
      <input type="text" id="share-url-input" readonly style="width:100%; margin:0.8rem 0; padding:0.8rem; font-family:monospace;">
      <button onclick="copyLink()">Copy Link</button>
      <button class="email-btn" style="background:linear-gradient(135deg,#e94e77,#ff6b6b);" onclick="shareViaEmail()">ðŸ“§ Email</button>
    </div>
  </section>
</div>

<script>
let currentPin = null;
const STORAGE_KEY = 'savedPins';

function showStatus(msg, type = 'success') {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = `status ${type}`;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}

function escapeHTML(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function savePin(pin) {
  let pins = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  pins.push(pin);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
  renderPinList();
}

function getSavedPins() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
}

function renderPinList(filter = '') {
  const container = document.getElementById('pin-list');
  container.innerHTML = '';
  const pins = getSavedPins();
  const lowerFilter = filter.toLowerCase();

  pins.forEach((pin, index) => {
    const text = [pin.name, pin.msg, ...pin.comments.map(c => c.text)].join(' ').toLowerCase();
    if (lowerFilter && !text.includes(lowerFilter)) return;

    const div = document.createElement('div');
    div.className = 'pin-item';
    div.innerHTML = `
      <div class="from">${escapeHTML(pin.name)}</div>
      <div class="msg">${escapeHTML(pin.msg || '(no message)')}</div>
      <div class="meta">${pin.lat}, ${pin.lng} â€¢ ${new Date(pin.time).toLocaleDateString()}</div>
      <div>${pin.comments.length} comment${pin.comments.length !== 1 ? 's' : ''}</div>
    `;
    div.onclick = () => loadPin(pin);
    container.appendChild(div);
  });

  if (!container.children.length && filter) {
    container.innerHTML = '<p style="color:#888;text-align:center;">No matching pins found.</p>';
  }
}

function searchPins() {
  const query = document.getElementById('search-input').value;
  renderPinList(query);
}

function loadPin(pin) {
  currentPin = pin;
  document.getElementById('pin-from').textContent = pin.name;
  document.getElementById('pin-msg').textContent = pin.msg || '(no message)';
  document.getElementById('pin-meta').textContent = `${pin.lat}, ${pin.lng} â€¢ ${new Date(pin.time).toLocaleString()}`;

  const commentsEl = document.getElementById('comments-list');
  commentsEl.innerHTML = '<strong>Comments</strong>';
  if (!pin.comments.length) {
    commentsEl.innerHTML += '<p style="color:#888;margin:1rem 0;">No comments yet.</p>';
  } else {
    pin.comments.forEach(c => {
      const div = document.createElement('div');
      div.style.margin = '1rem 0';
      div.innerHTML = `<div>${escapeHTML(c.text)}</div><div style="color:#aaa;font-size:0.9rem;">${escapeHTML(c.author || 'Anonymous')} â€¢ ${new Date(c.time).toLocaleString()}</div>`;
      commentsEl.appendChild(div);
    });
  }

  const url = `${location.origin}${location.pathname}?p=${encodeURIComponent(btoa(JSON.stringify(pin)))}`;
  document.getElementById('share-url-input').value = url;

  document.getElementById('pin-view').style.display = 'block';
  window.scrollTo(0, document.getElementById('pin-view').offsetTop - 20);
}

function createPin() {
  if (!navigator.geolocation) return showStatus('Geolocation not supported', 'error');

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    const name  = document.getElementById('name').value.trim() || 'Anonymous';
    const msg   = document.getElementById('msg').value.trim();
    const first = document.getElementById('initial-comment').value.trim();

    currentPin = {
      lat, lng, name, msg,
      time: new Date().toISOString(),
      comments: first ? [{ text: first, author: name, time: new Date().toISOString() }] : []
    };

    savePin(currentPin);
    loadPin(currentPin);
    showStatus('Pin created & saved locally!');

    // Clear form
    document.getElementById('name').value = '';
    document.getElementById('msg').value = '';
    document.getElementById('initial-comment').value = '';
  }, err => {
    showStatus('Location error: ' + err.message, 'error');
  }, { enableHighAccuracy: true, timeout: 10000 });
}

function addComment() {
  const text = document.getElementById('new-comment').value.trim();
  if (!text) return showStatus('Enter a comment', 'error');
  if (!currentPin) return showStatus('No pin loaded', 'error');

  const author = prompt('Your name (optional)')?.trim() || 'Anonymous';
  currentPin.comments.push({ text, author, time: new Date().toISOString() });

  // Update in storage
  let pins = getSavedPins();
  const index = pins.findIndex(p => p.time === currentPin.time);
  if (index !== -1) pins[index] = currentPin;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));

  loadPin(currentPin);
  document.getElementById('new-comment').value = '';
  showStatus('Comment added');
}

function copyLink() {
  const url = document.getElementById('share-url-input').value;
  navigator.clipboard.writeText(url).then(() => showStatus('Link copied!'));
}

function shareViaEmail() {
  const url = document.getElementById('share-url-input').value;
  const subject = "Check this location pin!";
  const body = `Hey!\n\nCheck out this pin: ${url}\n\nCoordinates: ${currentPin.lat}, ${currentPin.lng}`;
  window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
}

// Load saved pins on start + handle shared URL
window.addEventListener('load', () => {
  renderPinList();

  const params = new URLSearchParams(location.search);
  const data = params.get('p');
  if (data) {
    try {
      const pin = JSON.parse(atob(data));
      savePin(pin); // Save if coming from shared link
      loadPin(pin);
      showStatus('Loaded shared pin & saved locally');
    } catch (e) {
      showStatus('Invalid shared link', 'error');
    }
  }
});
</script>
</body>
</html>