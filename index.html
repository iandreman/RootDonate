function generateShareUrl(pin) {
  const pinJson = JSON.stringify(pin);
  const encoded = btoa(pinJson);
  return `${window.location.origin}${window.location.pathname}#pin=${encodeURIComponent(encoded)}`;
}

async function copyToClipboard(text) {
  try {
    await navigator.clipboard.writeText(text);
    showStatus('Copied to clipboard!', 'success');
  } catch (err) {
    showStatus('Copy failed ‚Äì try manually', 'error');
    console.error(err);
  }
}

function copyPin(pin, format) {
  let content = '';
  if (format === 'email') content = generateEmailHTML(pin);
  else if (format === 'social') content = generateSocialSnippet(pin);
  else if (format === 'url') content = generateShareUrl(pin);
  if (content) copyToClipboard(content);
}

function getAllDrops() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  catch { return []; }
}

function saveDrops(drops) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(drops));
}

function savePin(name = 'Swagga Rico', msg = '', isAuto = false) {
  if (!userLat || !userLng) return showStatus('No GPS fix yet', 'error');
  const drops = getAllDrops();
  const newPin = {
    name,
    msg: isAuto ? '' : msg.trim(),
    lat: userLat,
    lng: userLng,
    timestamp: new Date().toISOString(),
    auto: isAuto
  };
  drops.push(newPin);
  saveDrops(drops);
  showStatus(isAuto ? 'Auto-pin saved' : 'Pin saved', 'success');
  renderNearby();
}

function addManualDrop() {
  const name = document.getElementById('name').value.trim() || 'Anonymous';
  const msg = document.getElementById('msg').value.trim();
  if (!msg && !confirm('Save without message?')) return;
  savePin(name, msg, false);
  document.getElementById('msg').value = '';
}

function toggleAutoTrack() {
  autoTracking = !autoTracking;
  const btn = document.getElementById('toggle-auto');
  btn.textContent = `Toggle Auto-Track (${autoTracking ? 'ON' : 'off'})`;
  btn.className = autoTracking ? 'active' : '';

  if (autoTracking) {
    if (!watchId) startWatching();
    autoSaveInterval = setInterval(() => {
      if (userLat && userLng) savePin('Swagga Rico', '', true);
    }, AUTO_SAVE_INTERVAL_MS);
    showStatus('Auto-tracking ON (~1 min)', 'success');
  } else {
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    showStatus('Auto-tracking OFF', 'success');
  }
}

function startWatching() {
  if (!navigator.geolocation) {
    showStatus('Geolocation not supported', 'error');
    return;
  }
  watchId = navigator.geolocation.watchPosition(
    pos => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      renderNearby();
    },
    err => showStatus(`GPS error: ${err.message}`, 'error'),
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
  );
}

function renderPinList(containerId, drops, showCopyButtons = false) {
  const container = document.getElementById(containerId);
  if (drops.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:#666;">No pins found</p>';
    return;
  }

  let html = '';
  drops.forEach(d => {
    const dt = new Date(d.timestamp).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
    const label = d.auto ? '[auto]' : '';
    const mapLink = getAppleMapsLink(d.lat, d.lng, d.name);
    html += `
      <div class="pin">
        <div class="from">${escapeHTML(d.name)} ${label}</div>
        <div class="msg">${escapeHTML(d.msg || '(no note)')}</div>
        <div class="meta">${dt} ‚Ä¢ <a href="${mapLink}" target="_blank" class="coords">${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}</a></div>
    `;
    if (showCopyButtons) {
      html += `
        <button onclick='copyPin(${JSON.stringify(d)}, "email")'>Copy Email HTML</button>
        <button onclick='copyPin(${JSON.stringify(d)}, "social")'>Copy Social Post</button>
        <button onclick='copyPin(${JSON.stringify(d)}, "url")'>Copy Share URL</button>
      `;
    }
    html += '</div>';
  });
  container.innerHTML = html;
}

function renderNearby() {
  if (!userLat || !userLng) {
    document.getElementById('pins').innerHTML = '<p style="text-align:center;color:#666;">Waiting for GPS‚Ä¶</p>';
    return;
  }

  const drops = getAllDrops()
    .filter(d => Math.abs(d.lat - userLat) <= NEARBY_RADIUS_DEG && Math.abs(d.lng - userLng) <= NEARBY_RADIUS_DEG)
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  renderPinList('pins', drops, false);
}

function searchPins() {
  const term = document.getElementById('search-input').value.trim().toLowerCase();
  if (!term) {
    document.getElementById('search-results').innerHTML = '<p style="text-align:center;color:#666;">Enter search term</p>';
    return;
  }

  const drops = getAllDrops()
    .filter(d =>
      d.name.toLowerCase().includes(term) ||
      (d.msg || '').toLowerCase().includes(term) ||
      `${d.lat.toFixed(6)},${d.lng.toFixed(6)}`.includes(term)
    )
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  renderPinList('search-results', drops, true);
  showStatus(`Found ${drops.length}`, drops.length > 0 ? 'success' : 'error');
}

function clearAllDrops() {
  if (!confirm('Delete ALL local pins?')) return;
  localStorage.removeItem(STORAGE_KEY);
  showStatus('All pins cleared', 'success');
  renderNearby();
  document.getElementById('search-results').innerHTML = '';
}

function renderSharedPin(pin) {
  const name    = pin.name || 'Anonymous';
  const msg     = pin.msg || '(auto-tracked position)';
  const dt      = new Date(pin.timestamp).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' });
  const coords  = `${pin.lat.toFixed(6)}, ${pin.lng.toFixed(6)}`;
  const autoTag = pin.auto ? ' [auto]' : '';
  const mapLink = getAppleMapsLink(pin.lat, pin.lng, name);

  mainContainer.innerHTML = `
    <div class="card">
      <div class="from" style="color:#88ffcc; font-weight:700; font-size:1.5rem; margin-bottom:1rem;">üìç From: ${escapeHTML(name)}${autoTag}</div>
      <div class="msg" style="white-space:pre-wrap; margin:1.4rem 0; font-size:1.2rem;">${escapeHTML(msg)}</div>
      <div class="meta" style="font-size:1rem; color:#888; text-align:right; margin:1.6rem 0 1.2rem;">${dt} ‚Ä¢ <a href="${mapLink}" class="coords" style="font-family:monospace; color:#4cc9ff; font-weight:500; text-decoration:none;">${coords}</a></div>
      <div class="footer">
        Root Donate ‚Ä¢ Drop your roots where it matters üå±<br>
        Build the map together ‚Ä¢ <a href="https://x.com/iandreme">@iandreme</a><br>
        Every pin counts üó∫Ô∏è #RootDonate
      </div>
    </div>
    <div style="text-align:center; margin:2rem 0; color:#666;">
      <button onclick="window.location.href = window.location.origin + window.location.pathname">‚Üê Back to Main Menu</button>
    </div>
  `;
}

function checkForSharedPin() {
  const hash = window.location.hash;
  if (hash.startsWith('#pin=')) {
    try {
      const encoded = decodeURIComponent(hash.slice(5));
      const pinJson = atob(encoded);
      const pin = JSON.parse(pinJson);
      renderSharedPin(pin);
      document.title = `üìç ${pin.name || 'Pin'} Drop ‚Ä¢ Root Donate`;
      return true;
    } catch (err) {
      console.error('Invalid shared pin:', err);
      showStatus('Invalid or corrupted share link', 'error');
    }
  }
  return false;
}

// Event listeners
document.getElementById('add-drop').onclick = addManualDrop;
document.getElementById('toggle-auto').onclick = toggleAutoTrack;
document.getElementById('search-btn').onclick = searchPins;
document.getElementById('search-input').addEventListener('keypress', e => {
  if (e.key === 'Enter') searchPins();
});

// Start
const isSharedMode = checkForSharedPin();
if (!isSharedMode) {
  startWatching();
  renderNearby();
}